# P4 工业化架构重构计划

## 1. 清理虚假数据 (Zero-Fake Data Policy)

### 1.1 全量搜索并删除硬编码测试数据

* 搜索所有文件中的 hardcoded 测试图片、测试参数

* 删除所有 AI 自拟的素材和参数

* 确保所有数据都来自 MissionContext

### 1.2 实现空状态处理

* 当资产池为空时，界面显示‘待上传’状态

* 禁止展示任何默认的测试素材

* 统一使用 MissionContext 作为数据底座

## 2. 重建 Asset-Step 关联逻辑

### 2.1 实现全局资产池

* 统一管理所有上传的资产到 globalAssets

* 资产仅存储 Metadata（ID、名称、临时 Blob URL）

* 实现资产的添加、删除、查询功能

* 确保资产池的唯一性和一致性

### 2.2 修复 Asset-Step 引用关系

* StepCard 通过 assetId 引用资产池

* 实现资产删除时的级联更新

* 确保所有引用该资产的步骤预览同步失效

## 3. 强制实验室同步闭环 (P4LAB Tunnel)

### 3.1 修复 P4LAB 同步按钮

* 确保点击后精准更新 MissionStore.steps\[currentStepIndex].params

* 实现同步成功后的路由重定向到 /p4

* 禁止跳转至其他无关页面

### 3.2 实现实验室与主页面的数据双向绑定

* 确保实验室的任何修改都能实时反映到主页面

* 实现主页面到实验室的精准数据传递

## 4. 视觉一致性协议 (Visual Identity)

### 4.1 封装 UniversalPreview 组件

* 组件只接受 asset 和 params 参数

* 内部实现隐藏的 Canvas 渲染逻辑

* 确保可以产出处理后的图片（右键保存就是处理后的图）

* 实现统一的渲染逻辑，确保像素级一致

### 4.2 替换所有现有预览组件

* 在 P4 列表中使用 UniversalPreview

* 在素材库中使用 UniversalPreview

* 在 P4LAB 预览中使用 UniversalPreview

## 5. 健壮的导航系统

### 5.1 实现固定导航栏

* 顶部导航栏固定 P1、P2、P4 入口

* 确保路径切换时数据不丢失

* 修复路由占位符问题

### 5.2 实现一致的导航体验

* 确保所有页面的导航逻辑一致

* 实现页面间的数据传递机制

* 修复导航过程中的数据丢失问题

## 6. 技术实现细节

### 6.1 数据层重构

* 统一使用 Context API 管理状态

* 14 个参数（Params）存入持久化存储

* 资产（Assets）仅存 Metadata，不存实际图片数据

* 确保数据的一致性和完整性

### 6.2 组件层重构

* 实现组件的封装和复用

* 确保组件的单一职责原则

* 实现组件间的清晰通信

### 6.3 路由层重构

* 实现一致的路由配置

* 确保路由跳转的正确性

* 实现路由守卫和权限控制

## 7. 验证标准

### 7.1 逻辑闭环验证

* 从上传到排产到调参到导出 JSON 的完整流程

* 确保每一步的数据都能正确传递和处理

### 7.2 数据真实性验证

* 确保所有数据都来自用户操作

* 禁止任何 AI 自拟的素材和参数

* 确保数据的可追溯性和可验证性

### 7.3 视觉一致性验证

* 确保同一套参数在任何地方看到的视觉效果完全一致

* 确保右键保存就是处理后的图

* 确保预览组件的统一使用

### 7.4 健壮性验证

* 确保系统在各种情况下都能正常运行

* 确保系统的容错性和可恢复性

* 确保系统的性能和响应速度

## 8. 重构进度

### 8.1 第一阶段：数据清理和基础架构

* 完成硬编码数据的清理

* 实现全局资产池（仅存 Metadata）

* 实现 UniversalPreview 组件（带 Canvas 渲染）

### 8.2 第二阶段：组件重构和数据关联

* 重构 StepCard 组件

* 修复 P4LAB 同步功能

* 实现 Asset-Step 关联逻辑

### 8.3 第三阶段：导航系统和视觉一致性

* 实现固定导航栏

* 替换所有预览组件

* 确保视觉一致性

### 8.4 第四阶段：验证和优化

* 验证完整流程

* 修复所有错误

* 优化性能和用户体验

## 9. 预期效果

### 9.1 逻辑闭环

* 从上传到排产到调参到导出 JSON 逻辑丝滑贯通

* 数据在各个环节间正确传递和处理

### 9.2 数据真实性

* 所有数据都来自用户操作

* 没有任何硬编码的测试数据

* 数据可追溯、可验证

### 9.3 视觉一致性

* 同一套参数在任何地方看到的视觉效果完全一致

* 统一的预览组件和渲染逻辑

* 右键保存就是处理后的图

### 9.4 健壮的导航系统

* 固定的 P1、P2、P4 入口

* 路径切换时数据不丢失

* 正确的路由跳转和重定向

### 9.5 报错清零

* 修复所有现有错误

* 确保系统的稳定性和可靠性

* 提供良好的错误处理和用户反馈

### 9.6 性能优化

* 资产仅存 Metadata，避免浏览器卡死

* 优化 Canvas 渲染性能

* 确保系统在处理大图片时也能正常运行

## 10. 技术栈

### 10.1 前端框架

* React 18

* TypeScript

* React Router Dom 7

### 10.2 状态管理

* React Context API

* LocalStorage 持久化（仅存参数和资产 Metadata）

* Blob URL 用于临时存储图片

### 10.3 UI 组件

* Ant Design 6

* 自定义 UniversalPreview 组件（带 Canvas 渲染）

### 10.4 构建工具

* Vite 4

* TypeScript Compiler

## 11. 风险评估

### 11.1 数据丢失风险

* 确保重构过程中数据的安全性

* 实现数据备份和恢复机制

### 11.2 功能回归风险

* 确保重构后所有现有功能正常工作

* 实现全面的测试和验证

### 11.3 性能影响

* 确保重构后系统性能不下降

* 优化组件渲染和数据处理

* 避免大图片导致的浏览器卡死

### 11.4 兼容性风险

* 确保重构后系统兼容所有现代浏览器

* 实现优雅降级和渐进增强

## 12. 成功标准

### 12.1 代码质量

* 代码结构清晰、易于维护

* 遵循最佳实践和编码规范

* 充分的类型安全

### 12.2 功能完整性

* 所有现有功能正常工作

* 新增功能符合要求

* 系统逻辑闭环

### 12.3 用户体验

* 界面简洁、直观

* 操作流畅、响应迅速

* 良好的错误处理和用户反馈

* 右键保存就是处理后的图

### 12.4 性能指标

* 页面加载时间 < 2s

* 组件渲染时间 < 100ms

* 内存占用合理

* 处理大图片时不卡死

### 12.5 可维护性

* 代码易于理解和修改

* 充分的文档和注释

* 良好的模块化设计

## 13. 后续计划

### 13.1 持续优化

* 监控系统性能和用户反馈

* 持续优化和改进

### 13.2 功能扩展

* 根据业务需求扩展功能

* 实现更多的高级特性

### 13.3 技术升级

* 跟进最新的技术栈

* 实现技术栈的平滑升级

### 13.4 团队协作

* 提供良好的开发文档

* 实现团队协作的最佳实践

* 确保代码的可维护性和可扩展性

