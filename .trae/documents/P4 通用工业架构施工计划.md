# 🏗️ P4 通用工业架构施工计划 (修订版 v2)

## Universal Industrial Architecture Construction Plan (Revised)

本计划已根据您的“物理逻辑纠偏”进行了核心修正，重点强化了**闭环回填**、**人工干预权**和**视觉秩序**。

***

## 🏛️ Phase 1: P4LAB 实验室改造 (Capability Factory)

### 1. 模型货架化 (Visual Shelf)

**目标**：将冷冰冰的模型 ID 转化为直观的“能力货架”。

* **UI 升级**:

  * 改造左侧插槽列表 (`P4LabPage` 左侧面板)。

  * 废弃纯文本列表，升级为 **Card List** (卡片列表)。

  * 每张卡片展示：

    * **🏷️ 核心标签**: `[视觉分析]`, `[图像生成]`, `[人声克隆]` (根据 `category` 字段渲染)。

    * **📝 能力描述**: "擅长 5 人以上构图还原" (新增 `description` 字段支持)。

* **数据层改造**:

  * 修改 `src/config/protocolConfig.ts`，为每个协议补充 `tags` 和 `description` 字段。

### 2. 万能响应容器 (Universal Response Container)

**目标**：消除“开盲盒”体验，实现“所见即所得”的物理显化。

* **UI 升级**:

  * 改造右侧预览区。

  * **Type-Based Renderer** (基于类型的渲染器)：

    * **Text**: Markdown Card (Qwen/Gemini)。

    * **Image**: 图片预览 + 放大功能。

    * **Audio**: Waveform Player (波形播放器)。

* **逻辑层改造**:

  * 根据 `result` 数据类型自动切换组件。

### 3. "唯一"包装站与物理回路 (Unified Packaging & Physical Loop)

**目标**：建立标准的“能力存档”流程，并确保“从哪里来，回哪里去”。

* **UI 升级**:

  * **唯一入口**：保留 **【📦 封装此能力】** 按钮。

  * **封装弹窗**: 名称输入、封面选择、**参数锁定 (Frozen Lock)**。

* **⚡ 核心修正：物理回路 (Physical Loop)**:

  * **逻辑**:

    1. 检测 `location.state.fromStepIndex` (是否从 P4 编辑器跳转而来)。
    2. **如果是**: 保存能力包 -> **自动跳转回** **`/editor`** -> **自动将新能力挂载到** **`fromStepIndex`** **对应的步骤**。
    3. **如果否** (直接进入实验室): 保存能力包 -> 跳转回 `/p4` 列表。

  * **反馈**: "能力已修缮并装配至步骤 X"。

***

## 🏛️ Phase 2: P4 任务编排改造 (Assembly Line)

### 1. 步骤卡片与视觉秩序 (Step Card & Visual Order)

**目标**：让编排界面像“乐高积木”一样干净，并防止视觉溢出。

* **UI 升级**:

  * **待命/挂载状态**: 灰/亮色切换。

  * **UI 坍缩**: 仅显示 `dynamic` 参数。

  * **⚡ 核心修正：结果区物理溢出控制**:

    * **Max-Height 限制**: 结果展示区高度锁定 (e.g., `max-height: 200px`)。

    * **滚动机制**: 长文本显示滚动条。

    * **缩略机制**: 大图显示缩略图，点击可看大图 (Lightbox)。

* **逻辑层改造**:

  * 完全依赖 `mountedCapability` 渲染。

### 2. 数据接力与应急阀 (Data Relay & Emergency Valve)

**目标**：实现“数据自动接力”，但保留人类的最高裁决权。

* **UI 升级**:

  * **流向线**: 绘制步骤间的连接线。

  * **引用标签**: 显示 `🔗 已自动引用 Step 01: [分析结果]`。

  * **⚡ 核心修正：手动应急阀 (Manual Override)**:

    * 在蓝色引用标签旁增加 **\[🔓 解除关联]** (Unlink) 按钮。

    * **交互**: 点击后，蓝色标签消失，输入框恢复为**可编辑状态**，且自动填入刚才引用的内容作为默认值 (方便微调)。

* **逻辑层改造**:

  * **Input Mapping**: 默认自动抓取。

  * **Override Logic**: 记录 `manualOverride: true` 状态。当用户点击解除时，阻断自动数据流，切换为 `user_input` 模式。

***

## 🔎 验收标准 (Acceptance Criteria)

1. **物理回路验证**:

   * [ ] 从 P4 点击 Step 02 进入实验室 -> 导出能力 -> 必须直接回到 P4 且 Step 02 已挂载该能力。

2. **应急阀验证**:

   * [ ] Step 02 自动填入了 Step 01 的文字。

   * [ ] 点击 \[解除关联] -> 输入框变白 -> 修改文字 -> 运行。系统必须使用修改后的文字。

3. **视觉秩序验证**:

   * [ ] 即使 Step 01 输出了 5000 字的分析报告，步骤卡片的高度也不能超过设定值 (e.g. 300px)，必须出现滚动条。

