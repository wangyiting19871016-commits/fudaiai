# P4Lab å…¨é“¾è·¯é€»è¾‘ç‰©ç†ä¿®å¤è®¡åˆ’

ç›®å‰ P4 (Editor) åˆ° P4LAB çš„äº¤äº’å­˜åœ¨æ–­è£‚ï¼Œä¸»è¦åŸå› æ˜¯ `EditorPage` åœ¨è·³è½¬æ—¶æ²¡æœ‰æ­£ç¡®è§£æå¹¶ä¼ é€’ Protocol IDï¼Œä¸” `P4LabPage` çš„åˆå§‹åŒ–é€»è¾‘è¢«ç¡¬ç¼–ç çš„â€œç²˜åœŸé€»è¾‘â€æ±¡æŸ“ã€‚æˆ‘ä»¬éœ€è¦å»ºç«‹é€šç”¨çš„â€œåè®®æ¡æ‰‹â€æœºåˆ¶ã€‚

## æ ¸å¿ƒé—®é¢˜åˆ†æ
1.  **ä¸Šæ¸¸æ–­è£‚ (EditorPage)**: è·³è½¬æ—¶å¯èƒ½æœªå‡†ç¡®è§£æç”¨æˆ·é€‰æ‹©çš„æ’ä»¶ IDï¼Œå¯¼è‡´ä¼ ç»™ P4Lab çš„ `protocolId` å¯èƒ½æ˜¯ `undefined` æˆ–é”™è¯¯çš„ `toolType`ã€‚
2.  **ä¸‹æ¸¸æ­»é” (P4LabPage)**: ç°æœ‰çš„åˆå§‹åŒ–é€»è¾‘åŒ…å«å¤§é‡é’ˆå¯¹ `chibify-3d-clay` çš„ç¡¬ç¼–ç  `if/else`ï¼Œå¯¼è‡´å…¶ä»–æ’ä»¶æ— æ³•æ­£å¸¸åŠ è½½å…¶é»˜è®¤é…ç½®ã€‚
3.  **æµ‹è¯•é€»è¾‘æ±¡æŸ“**: ç°å­˜çš„ `setTimeout` å’Œå¼ºåˆ¶è¦†ç›–é€»è¾‘æ˜¯ä¸ºäº†ä¸´æ—¶æ¼”ç¤ºè€Œå†™ï¼Œé˜»ç¢äº†é€šç”¨åè®®çš„ç”Ÿæ•ˆã€‚

## ä¿®å¤å®æ–½è®¡åˆ’ (Step-by-Step)

### Phase 1: ä¸Šæ¸¸æ•°æ®æ ‡å‡†åŒ– (EditorPage)
**ç›®æ ‡**: ç¡®ä¿è·³è½¬æ—¶æºå¸¦ç²¾å‡†çš„â€œèº«ä»½è¯æ˜â€ã€‚

1.  **ä¿®æ­£è·³è½¬é€»è¾‘**: åœ¨ `StepCard` æˆ–è·³è½¬å‡½æ•°ä¸­ï¼Œä¼˜å…ˆè¯»å– `step.pluginIds[0]` ä½œä¸º `protocolId`ã€‚
2.  **åè®®æ ¡éªŒ**: åœ¨è·³è½¬å‰ï¼ŒéªŒè¯è¯¥ ID æ˜¯å¦åœ¨ `MISSION_PROTOCOLS` ä¸­å®šä¹‰ã€‚å¦‚æœæœªå®šä¹‰ï¼Œå›é€€åˆ°é€šç”¨é»˜è®¤å€¼ï¼Œå¹¶ç»™å‡ºè­¦å‘Šã€‚

### Phase 2: ä¸‹æ¸¸é€šç”¨åˆå§‹åŒ– (P4LabPage)
**ç›®æ ‡**: ç§»é™¤â€œç²˜åœŸç‰¹æƒâ€ï¼Œå»ºç«‹é€šç”¨åŠ è½½å™¨ã€‚

1.  **ç§»é™¤ç¡¬ç¼–ç **: åˆ é™¤æ‰€æœ‰ `if (protocolId === 'chibify-3d-clay')` çš„ç‰¹åˆ¤ä»£ç å—ã€‚
2.  **å®ç°é€šç”¨åŠ è½½å™¨ (`useContextAwareness`)**:
    *   è¯»å– `protocolId`ã€‚
    *   é€šè¿‡ `ProtocolService.getPresetConfig(protocolId)` è·å–ç›®æ ‡æ¨¡å‹å’Œé¢„è®¾ Promptã€‚
    *   è‡ªåŠ¨æŸ¥æ‰¾åŒ¹é…è¯¥åè®® Provider çš„ Slotï¼ˆä¾‹å¦‚ SiliconFlow æˆ– FishAudioï¼‰ã€‚
    *   æ‰§è¡ŒçŠ¶æ€æ³¨å…¥ï¼š`Slot -> Model -> Params`ã€‚

### Phase 3: çŠ¶æ€æ³¨å…¥å¢å¼º (ProtocolService)
**ç›®æ ‡**: è®© Service å±‚å†³å®šâ€œè°è¯¥ç”¨ä»€ä¹ˆé…ç½®â€ã€‚

1.  **æ‰©å±• `getPresetConfig`**:
    *   æ”¯æŒæ‰€æœ‰å·²å®šä¹‰åè®®ï¼ˆCosyVoice, Qwen-Restore ç­‰ï¼‰çš„é¢„è®¾å€¼è¿”å›ã€‚
    *   å¢åŠ  `forceModel` å­—æ®µï¼Œç¡®ä¿ç‰¹å®šä»»åŠ¡é”å®šç‰¹å®šæ¨¡å‹ã€‚

### Phase 4: éªŒè¯ä¸æ¸…ç†
1.  **æ¸…ç†æµ‹è¯•ä»£ç **: åˆ é™¤æ‰€æœ‰ `console.log("ğŸ”¥ [CRITICAL_CHECK]...")` ç±»çš„ä¸´æ—¶è°ƒè¯•ä»£ç ã€‚
2.  **å…¨é“¾è·¯æµ‹è¯•**:
    *   æµ‹è¯• Case A: ç‚¹å‡»â€œ3D ç²˜åœŸâ€ -> P4Lab åŠ è½½ Flux + ç²˜åœŸ Promptã€‚
    *   Test Case B: ç‚¹å‡»â€œCosyVoiceâ€ -> P4Lab åŠ è½½ CosyVoice æ¨¡å‹ + è¯­éŸ³å‚æ•°ã€‚

## æ‰§è¡Œæ¸…å•
1.  **Modify `src/pages/MissionFoundry/components/TaskMatrix/StepCard.tsx`** (æˆ–ç›¸å…³è·³è½¬ç»„ä»¶): ç¡®ä¿ä¼ é€’æ­£ç¡®çš„ `protocolId`ã€‚
2.  **Update `src/services/ProtocolService.ts`**: å®Œå–„é€šç”¨é¢„è®¾é…ç½®è·å–é€»è¾‘ã€‚
3.  **Refactor `src/pages/P4LabPage.tsx`**: é‡å†™åˆå§‹åŒ– `useEffect`ï¼Œä½¿ç”¨é€šç”¨é€»è¾‘æ›¿ä»£ç¡¬ç¼–ç ã€‚
