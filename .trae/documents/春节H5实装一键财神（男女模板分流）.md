## 已确认的决策
- M2 进入任务页后：**强制先选性别**。
- 模板策略：**按 taskId 做 hash 轮换**（避免每次都一样且分布均匀）。
- **不做模板选择界面**（后续需要再加很快）。

## 实装目标（用户视角）
- 主页点“财神变身” → 选择男/女 → 上传照片 → 确认 → 自动生成财神成片 + 自动生成“马年财神语录”判词 → 结果页展示。
- 用户全程看不到任何可调参数。

## 技术方案（万金油 B：素材触发器）
### 1) 素材触发器文件
- 新增 `src/configs/festival/assetTriggers.ts` 作为唯一扩容入口：
  - `caishen: { male: Template[], female: Template[] }`
  - 每个模板只记录：`id`、`localPath`（站内资源路径）、可选 `label`。
- 你已提供：男 4 张、女 3 张 → 都入池，但不暴露给用户。

### 2) 模板图落地与 URL 稳定性
- 把模板图写入仓库：`public/assets/festival-templates/caishen/{male|female}/...`
- 线上：直接用站内 `https://域名/assets/...`（最稳，避免第三方图床）。
- 本地：因为 Liblib 拉不到 localhost，我会在提交前自动把“模板图 + 用户图”上传到现有图床（ImgBB）拿到公网 URL 再喂给 Liblib。

### 3) H5 Lab 流程改造（仅对 M2 生效）
- 修改 [Festival/LabPage.tsx](file:///f:/project_kuajing/src/pages/Festival/LabPage.tsx)：
  - 当 `missionId === 'M2'` 时：stage 初始为 `gender`（和 M1 一样）。
  - 选性别后进入 upload/preview。

### 4) M2 生成链路（MissionExecutor 新分支）
- 修改 [MissionExecutor.ts](file:///f:/project_kuajing/src/services/MissionExecutor.ts)：
  - 对 M2：不走现有 FLUX 文生图；改为 Comfy 工作流：
    - `POST /api/liblib/api/generate/comfyui/app`
    - 轮询 `POST /api/liblib/api/generate/comfy/status`
  - node40=用户图 URL（base64→上传→URL）
  - node49=模板图 URL（按性别，从素材池用 taskId-hash 选 1 张）
  - node271 默认：face=true, hair=false（稳定优先）

### 5) DeepSeek 判词（默认马年财神语录）
- M2 出图后调用 DeepSeek，返回 1~2 句短祝福（马年/财运/吉祥）。

## 轮换规则（taskId-hash）
- 生成 taskId 后：`index = hash(taskId) % templates.length`
- 同一个 taskId 结果可复现；不同用户/不同次生成分布均匀。

## 验证性测试（我会完成）
- 男/女各跑至少 1 次完整链路：选性别→上传→出图→判词→结果页。
- 验证模板轮换：连续生成多次，确保底图在池内轮换而非固定一张。
- 验证失败提示：遇到 100031 风控时给出可理解文案并允许重试。

## 不需要你再补的材料
- 男 4 张、女 3 张模板我已收到（按现有文件落库即可）。

如果你确认按这个版本开始，我就退出计划模式并开始实装与测试。