# 真迹平台架构重构施工方案 (修正版)
# Revised Project Zhenji Refactor Plan

收到您的修正指令，方案已根据以下三点核心约束进行了优化：
1.  **P4LAB UI 零侵入**：仅通过 Modal 扩展功能，不破坏现有布局。
2.  **P4 垂直布局**：使用 React Flow 实现垂直流式 (Vertical Flow) 视觉，保持工业风。
3.  **多模态执行器**：后端支持 Image/Audio/HTML 多种格式返回。

---

## 🏗️ 详细施工步骤 (Detailed Steps)

### 1. 后端与数据层建设 (Backend & Data Layer)
*   **目标**: 建立 "万能执行器" 和 "本地数据库"。
*   **动作**:
    *   创建 `src/data/db/` 目录及 `skills_library.json`, `tasks_registry.json`。
    *   实现 `JsonDB` 适配器 (CRUD 操作)。
    *   在 `server.js` 中挂载 API：
        *   `/api/skills` (GET/POST)
        *   `/api/tasks` (GET/POST)
        *   `/api/execute-task` (POST)
    *   **核心逻辑**: `execute-task` 将实现**多模态响应**。
        *   执行结果统一封装为 `{ type: 'image' | 'audio' | 'html' | 'text', data: '...' }`。
        *   根据 Atomic Skill 的 `outputs_def` 动态解析结果类型。

### 2. P4LAB 隐形改造 (Invisible Refactor)
*   **目标**: 变量化封装，不改动主界面。
*   **动作**:
    *   保持 P4LAB 现有三栏布局完全不动。
    *   修改右上角 "封装 (Encapsulate)" 按钮事件，触发 **Antd Modal**。
    *   **Modal 逻辑**:
        *   自动正则提取 Prompt 中的 `{{variable}}`。
        *   用户输入技能名称 (Name) 和 标签 (Tag)。
        *   点击 "保存" -> 生成 JSON -> POST `/api/skills`。

### 3. P4 编排器重构 (P4 Redesign - Vertical Flow)
*   **目标**: 垂直流式编排，保持 Visual Blueprint 质感。
*   **动作**:
    *   安装 `@xyflow/react` (React Flow)。
    *   创建 `/p4/builder` 页面。
    *   **UI 定制**:
        *   **布局**: 强制垂直自动布局 (Step 1 -> Step 2)，禁止乱序网状拖拽。
        *   **主题**: 使用深色/工业风 (Dark/Industrial Theme)，去除默认灰白样式。
        *   **连线**: 使用直角或平滑曲线连接上下步骤。
    *   **逻辑**: 实现 "上一步输出" 到 "下一步输入" 的参数映射选择器。

### 4. P3 端到端执行 (Multi-modal Terminal)
*   **目标**: 支持多种结果渲染。
*   **动作**:
    *   调用 `/api/execute-task`。
    *   根据返回的 `type` 字段动态渲染组件：
        *   `image` -> `<img src="..." />`
        *   `audio` -> `<audio controls src="..." />`
        *   `html` -> `<iframe srcdoc="..." />` (用于渲染代码任务结果)

### 5. 验证计划 (Verification Plan)
1.  **原子验证**: P4LAB 封装 Flux 技能，检查 JSON 中模板变量 `${keyword}` 是否正确保存。
2.  **编排验证**: P4 垂直拖拽两个技能，检查生成的 `pipeline_config` 顺序是否正确。
3.  **端到端验证**:
    *   测试 Image 任务 (Flux Logo) -> 期望显示图片。
    *   测试 Audio 任务 (声音克隆) -> 期望显示音频播放器。

请确认此修正方案，确认后我将立即开始 **Step 1: 后端与数据层建设**。
