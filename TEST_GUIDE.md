# 本地测试指南

## 测试环境说明

当前配置：
- AppID: `201906176646`
- 支付网关: `https://api.xunhupay.com/payment/do.html`
- 环境：本地开发，未部署到公网

---

## 方案A：完整流程测试（推荐）

### 前置条件
需要安装 ngrok 实现内网穿透

### 步骤

#### 1. 启动 ngrok
```bash
# 新开一个终端
ngrok http 3002
```

显示结果示例：
```
Forwarding  https://abc123.ngrok-free.app -> http://localhost:3002
```

#### 2. 更新 .env 文件
复制 ngrok 的 https URL，更新 `.env`：
```env
HUPIJIAO_NOTIFY_URL=https://abc123.ngrok-free.app/api/payment/notify
```
**⚠️ 记得替换为你实际的 ngrok URL**

#### 3. 启动项目
```bash
npm run dev:all
```

#### 4. 测试流程
1. 访问 http://localhost:5173
2. 点击右上角积分余额 → 进入充值页
3. 选择任意套餐 → 点击"立即购买"
4. 跳转虎皮椒支付页面
5. 完成支付（测试环境可使用沙箱支付）
6. 支付成功后自动跳转回结果页
7. **虎皮椒会回调你的 ngrok URL**
8. 积分自动到账 ✅

#### 5. 验证
- 查看积分余额是否更新
- 后端控制台显示：`✅ [支付成功] xxx`

---

## 方案B：快速测试（无需 ngrok）

### 说明
- 只测试支付跳转
- 积分需要手动发放
- 适合快速验证支付流程

### 步骤

#### 1. 启动项目
```bash
npm run dev:all
```

#### 2. 创建订单并支付
1. 访问 http://localhost:5173
2. 点击右上角积分余额 → 进入充值页
3. 选择任意套餐 → 点击"立即购买"
4. **记录订单号**（显示在支付结果页URL中）
5. 跳转虎皮椒支付页面
6. 完成支付

#### 3. 手动完成订单
支付完成后，订单状态不会自动更新（因为没有回调）

**使用测试接口手动完成：**
```bash
curl -X POST http://localhost:3002/api/payment/manual-complete \
  -H "Content-Type: application/json" \
  -d '{
    "orderId": "ord_1234567890_abc123"
  }'
```
**⚠️ 替换为你的实际订单号**

#### 4. 刷新页面验证
- 刷新支付结果页
- 积分应该已到账

---

## 测试检查清单

### 支付流程
- [ ] 首页显示积分余额（初始0）
- [ ] 充值页显示5个套餐
- [ ] 点击购买跳转虎皮椒
- [ ] 虎皮椒页面显示正确的订单信息
- [ ] 完成支付后跳转回来

### 积分系统
- [ ] 支付成功后积分到账
- [ ] 积分余额正确显示
- [ ] 点击付费功能检查积分
- [ ] 积分不足显示提示弹窗
- [ ] 使用功能后积分正确扣除

### 后端日志
查看控制台应显示：
```
💰 [支付信息]
   AppID: 201906176646
   订单号: ord_xxx
   金额: ¥59.9
   回调URL: https://xxx

✅ [支付成功] ord_xxx - ¥59.9 - 350积分
```

---

## 常见问题

### Q1: ngrok 连接失败
- 检查网络连接
- 尝试重启 ngrok
- 确保端口3002没有被占用

### Q2: 支付页面显示配置错误
- 检查 AppID 是否正确
- 检查签名生成是否正确
- 查看后端日志的错误信息

### Q3: 积分没有到账
**方案A（使用 ngrok）**：
- 检查 ngrok 是否还在运行
- 检查 .env 的回调URL是否正确
- 查看后端是否收到回调（看日志）

**方案B（手动完成）**：
- 使用测试接口手动完成订单
- 检查订单号是否正确

### Q4: 签名验证失败
- 确保 AppSecret 正确
- 检查参数是否按key排序
- 查看后端日志的签名对比

---

## 调试技巧

### 查看订单数据
```bash
cat F:/project_kuajing/data/orders.json
```

### 查看环境变量
在 server.js 启动时会打印配置信息

### 清除本地数据
```javascript
// 浏览器控制台
localStorage.clear()
location.reload()
```

### 测试订单查询
```bash
curl http://localhost:3002/api/payment/order-status/你的订单ID
```

---

## 推荐测试流程

1. **先用方案B快速测试**
   - 验证支付跳转正常
   - 验证订单创建正常
   - 使用手动接口完成订单

2. **确认基础流程OK后，再用方案A测试完整流程**
   - 配置 ngrok
   - 测试自动回调
   - 验证积分自动到账

3. **测试边界情况**
   - 积分不足
   - 订单超时
   - 重复支付

---

## 下一步

测试完成后：
1. 部署到公网服务器
2. 配置真实的回调URL
3. 在虎皮椒后台配置回调URL白名单
4. 进行生产环境测试
