# 福袋AI 部署前完整计划

**制定日期**: 2026-02-07 23:50
**目标**: 注释掉不完善功能,专注已完成功能,测试调试,准备部署

---

## 📋 执行总览

### 阶段1: 功能清理(今晚)
- [x] 评估可灵特效功能 → **注释掉**
- [x] 评估春联功能 → **已注释**(2026-02-07)
- [ ] 注释可灵路由和入口
- [ ] 隐藏VideoCategoryPage入口

### 阶段2: 功能测试(明天上午)
- [ ] 测试所有保留功能的完整流程
- [ ] 修复发现的Bug
- [ ] 验证移动端体验

### 阶段3: 部署准备(明天下午)
- [ ] 环境变量检查
- [ ] 生产构建测试
- [ ] 部署文档准备

### 阶段4: 正式部署(明天晚上)
- [ ] 部署到生产环境
- [ ] 监控和验证

---

## 🔍 当前功能评估

### ❌ 需要注释的功能

#### 1. 可灵特效视频 (KlingEffectsPage)
**问题**:
- API成功率只有2.5% (40次测试1次成功)
- 账户配额/权限问题
- 成本高,不稳定

**涉及文件**:
- `src/pages/Festival/KlingEffectsPage.tsx` - 特效页面
- `src/pages/Festival/VideoCategoryPage.tsx` - 视频分类入口
- `src/pages/Festival/components/KlingTemplateModal.tsx` - 模板组件
- `src/App.tsx` - 路由配置
- `server.js` - API端点(/api/kling/video-effects)

**注释策略**:
- 注释VideoCategoryPage中的"特效视频"选项
- 或直接注释整个VideoCategoryPage,视频分类只保留数字人
- 保留代码,只是隐藏入口

#### 2. AI春联 (M9)
**状态**: ✅ 已注释 (2026-02-07)
- `features.ts` Line 486: `enabled: false`
- `MaterialLibraryPage.tsx` L240-245: 标签已隐藏

**问题**:
- 模板不够
- 功能不完善

---

### ✅ 保留的核心功能(需测试)

#### 分类1: 新年形象 🎭
1. **M1 - 新年3D头像** ✅
   - 6个风格(水彩春意、赛博新春、国风厚涂等)
   - 支持自定义提示词
   - 页面: `TemplateSelectionPage.tsx`, `LabPage.tsx`
   - 测试要点: DNA提取、风格生成、自定义prompt

2. **M2 - 新年写真** ✅
   - 20个模板(男8女12)
   - 支持换发型
   - 页面: `M2TemplateSelectionPage.tsx`
   - 测试要点: 模板选择、换发型开关、生成质量

#### 分类2: 家庭相册 👨‍👩‍👧
3. **M3 - 情侣合照** ✅
   - 3个模板
   - 页面: `M3TemplateSelectionPage.tsx`
   - 测试要点: 2张照片上传、nodeMapping正确性(2026-02-07已修复)

4. **M4 - 全家福** (状态待确认)
   - 3张照片合成

5. **M6 - 老照片修复** (状态待确认)
   - 修复上色

#### 分类3: 拜年祝福 💬
6. **拜年文案生成** ✅
   - 页面: `TextPage.tsx`
   - 测试要点: DeepSeek API调用、文案质量

7. **M5 - 语音贺卡** ✅
   - 38个音频音色(含马云等明星音色)
   - 页面: `VoicePageNew.tsx`
   - 测试要点: Fish Audio TTS、音色选择、生成速度

8. **M11 - 数字人拜年** ✅
   - 照片+音频 → 数字人视频
   - 页面: `VideoPage.tsx`, `DigitalHumanPage.tsx`
   - 测试要点: WAN API调用、字幕烧录、视频保存

#### 分类4: 运势玩法 🎴
9. **M7 - 运势抽卡** ✅
   - 17张运势卡片
   - 页面: `FortunePage.tsx`
   - 测试要点: 卡片抽取、图片显示

10. **M8 - 赛博算命** ✅
    - 面相分析
    - 页面: `FortuneCardPage.tsx`
    - 测试要点: 照片分析、运势生成

11. **M10 - 高情商回复** ✅
    - 页面: `SmartReplyPage.tsx`
    - 测试要点: 回复生成、场景适配

---

## 🛠️ 阶段1: 功能清理(今晚执行)

### 任务1.1: 注释可灵特效入口

**方案A: 隐藏VideoCategoryPage中的特效选项**
```typescript
// VideoCategoryPage.tsx L23-42
const videoOptions = [
  // 🔥 2026-02-07 可灵特效暂时下线：API不稳定(2.5%成功率)，等后续优化
  // {
  //   id: 'effects',
  //   title: '特效视频',
  //   description: '烟花 · 财神 · 舞狮等12种特效',
  //   ...
  // },
  {
    id: 'digital-human',
    title: '数字人拜年',
    ...
  }
];
```

**方案B: 直接跳过VideoCategoryPage,视频分类直接进入数字人**
```typescript
// HomePageGlass.tsx L16-22 (已修改为进入分类页)
const handleCategoryClick = (categoryId: string) => {
  if (categoryId === 'video') {
    // 🔥 2026-02-07 可灵特效下线，视频分类只有数字人，直接跳转
    navigate('/festival/video');
    return;
  }
  navigate(`/festival/category/${categoryId}`);
};
```

**推荐**: 方案B更简洁，用户体验更流畅

### 任务1.2: 验证春联已注释

检查以下位置:
- [x] `features.ts` L486: `enabled: false`
- [x] `MaterialLibraryPage.tsx` L240-245: 标签注释
- [ ] 确认首页无春联入口

### 任务1.3: 清理未使用的功能

检查是否有其他未完成/不稳定的功能需要注释:
- [ ] M4全家福 - 测试验证状态
- [ ] M6老照片修复 - 测试验证状态
- [ ] M11隐形文字画 - 产品文档标记"开发中",检查是否实现

---

## 🧪 阶段2: 功能完整测试(明天上午)

### 测试环境
- 本地: http://localhost:5173
- 移动端: http://192.168.2.2:5173 (手机同WiFi访问)

### 测试清单

#### 2.1 M1新年3D头像
- [ ] 性别切换正常
- [ ] 模板选择(6个风格)正常
- [ ] 上传照片成功
- [ ] DNA提取成功
- [ ] 默认生成(不开启自定义)正常
- [ ] 自定义提示词生成正常
- [ ] 生成结果保留DNA特征和风格
- [ ] 结果页"保存作品"功能正常
- [ ] 结果页"重新生成"功能正常

#### 2.2 M2新年写真
- [ ] 性别切换正常
- [ ] 分类Tab切换(传统、现代、创意、喜庆)正常
- [ ] 模板选择(20个)正常
- [ ] 换发型开关显示正常
- [ ] 默认生成(不换发型)正常
- [ ] 换发型生成正常
- [ ] 结果保存正常

#### 2.3 M3情侣合照
- [ ] 上传2张照片成功
- [ ] 模板选择(3个)正常
- [ ] 生成合照左右位置正确(nodeMapping修复验证)
- [ ] 结果保存正常

#### 2.4 拜年文案
- [ ] 表单填写正常(关系、场景、风格)
- [ ] 文案生成速度(<3秒)
- [ ] 文案质量符合要求
- [ ] "继续创作"流转正常(文案→语音、文案→视频)

#### 2.5 语音贺卡
- [ ] 文案输入正常
- [ ] 音色分类显示(7个分类,38个音色)
- [ ] 音色选择正常
- [ ] 语音生成成功
- [ ] 音频播放正常
- [ ] 音频保存/下载正常

#### 2.6 数字人视频
- [ ] 照片上传成功
- [ ] 文案输入正常
- [ ] 音色选择正常
- [ ] 视频生成成功(WAN API)
- [ ] 字幕烧录正常
- [ ] 视频预览正常
- [ ] **视频长按保存正常**(关键测试点)
- [ ] 进度条显示合理(不卡在某个百分比)

#### 2.7 运势抽卡
- [ ] 卡片抽取动画正常
- [ ] 17张卡片图片显示正常
- [ ] 运势文案显示正常
- [ ] 结果保存正常

#### 2.8 赛博算命
- [ ] 照片上传成功
- [ ] 表单填写正常
- [ ] 面相分析生成成功
- [ ] 结果显示正常

#### 2.9 高情商回复
- [ ] 表单填写正常
- [ ] 回复生成成功
- [ ] 结果质量符合要求

#### 2.10 我的作品
- [ ] 素材库显示正常
- [ ] 文本预览正常(自动换行,不截断)
- [ ] 音频预览正常(显示播放器)
- [ ] 图片预览正常
- [ ] 视频预览正常
- [ ] 分类筛选正常
- [ ] **春联标签不显示**(验证已注释)

#### 2.11 全局功能
- [ ] 首页卡片点击跳转正常
- [ ] 返回按钮逻辑正确
- [ ] 首页按钮逻辑正确
- [ ] 移动端布局正常
- [ ] 错误提示友好
- [ ] 加载状态显示正常

---

## 🐛 阶段3: Bug修复

### 已知问题清单
1. ✅ M3情侣合照nodeMapping顺序 - **已修复**(2026-02-07)
2. ✅ M1自定义提示词真人照问题 - **已修复**(2026-02-07)
3. ✅ 我的作品文本/音频预览 - **已修复**(2026-02-07)
4. ✅ 春联功能禁用 - **已完成**(2026-02-07)
5. ⚠️ 视频长按保存问题 - **需验证VideoPage是否已修复**
6. ⚠️ 视频生成进度卡顿 - **需验证**

### 测试中发现的新问题
(测试过程中补充)

---

## 📦 阶段4: 部署准备

### 4.1 环境变量检查

确认`.env`文件包含所有必需的密钥:
- [x] VITE_DASHSCOPE_API_KEY (通义千问 - DNA提取、数字人)
- [x] VITE_DEEPSEEK_API_KEY (DeepSeek - 文案生成)
- [x] VITE_TENCENT_COS_SECRET_ID (腾讯云COS - 图片/音频存储)
- [x] VITE_TENCENT_COS_SECRET_KEY
- [x] VITE_TENCENT_COS_BUCKET
- [x] VITE_TENCENT_COS_REGION
- [ ] KLING_ACCESS_KEY (暂时不用,已注释)
- [ ] KLING_SECRET_KEY (暂时不用,已注释)

### 4.2 生产构建测试

```bash
cd F:/project_kuajing
npm run build
npm run preview
```

检查:
- [ ] 构建无错误
- [ ] 预览服务正常启动
- [ ] 页面加载正常
- [ ] 功能运行正常

### 4.3 性能优化

- [ ] 图片资源压缩
- [ ] 代码分割检查
- [ ] 首屏加载时间(<3秒)
- [ ] 移动端性能优化

### 4.4 部署文档准备

创建`DEPLOYMENT.md`:
- [ ] 环境要求(Node版本等)
- [ ] 部署步骤
- [ ] 环境变量配置
- [ ] 域名配置
- [ ] Nginx配置示例

---

## 🚀 阶段5: 正式部署

### 5.1 部署方案选择

**方案A: Vercel (推荐)**
- 免费CDN
- 自动HTTPS
- 环境变量管理
- Git集成部署

**方案B: 阿里云/腾讯云**
- 完全控制
- 需配置Nginx
- 需申请SSL证书

**方案C: Netlify**
- 类似Vercel
- 免费额度充足

### 5.2 部署步骤

#### Vercel部署
1. 将代码推送到GitHub
2. Vercel导入项目
3. 配置环境变量
4. 部署
5. 验证功能

#### 自建服务器部署
1. SSH登录服务器
2. 安装Node.js/Nginx
3. 克隆代码
4. 安装依赖
5. 构建项目
6. 配置Nginx反向代理
7. 配置PM2守护进程
8. 申请SSL证书
9. 部署

### 5.3 部署后验证

- [ ] 生产环境访问正常
- [ ] HTTPS正常
- [ ] 所有功能测试通过
- [ ] 移动端测试通过
- [ ] 性能监控正常

### 5.4 监控和日志

- [ ] 配置错误监控(Sentry)
- [ ] 配置性能监控
- [ ] 配置访问日志
- [ ] 配置API调用统计

---

## 📊 时间规划

### 今晚(2026-02-07 23:00-24:00)
- 注释可灵特效入口
- 验证春联已注释
- 提交代码

### 明天上午(2026-02-08 09:00-12:00)
- 完整功能测试(3小时)
- 记录发现的问题

### 明天下午(2026-02-08 14:00-18:00)
- 修复测试中发现的Bug(2小时)
- 生产构建测试(1小时)
- 部署准备(1小时)

### 明天晚上(2026-02-08 19:00-21:00)
- 正式部署(1小时)
- 部署后验证(1小时)

---

## 📝 注意事项

### 代码注释规范
所有注释的功能必须加上标记:
```typescript
// 🔥 2026-02-07 [功能名]暂时下线：[原因]，等后续[计划]
```

### Git提交规范
```bash
git commit -m "feat: 注释可灵特效和春联功能,准备部署

- 注释VideoCategoryPage中的可灵特效选项
- 确认春联功能已禁用
- 保留代码以备后续开发

原因: API不稳定,成本高,功能不完善
计划: 等后续优化后再上线"
```

### 备份策略
- 部署前备份当前代码
- 部署前备份数据库(如有)
- 部署前备份.env文件

---

## 🎯 成功标准

### 部署成功标准
1. ✅ 所有保留功能100%可用
2. ✅ 移动端体验流畅
3. ✅ 加载速度<3秒
4. ✅ 无严重Bug
5. ✅ 生产环境稳定运行24小时

### 后续优化计划
1. 可灵特效API优化(解决配额问题)
2. 春联模板补充
3. 性能优化
4. 用户反馈收集
5. 新功能开发

---

**制定者**: Claude Code
**审批者**: [用户确认]
**执行时间**: 2026-02-07晚 ~ 2026-02-08晚
