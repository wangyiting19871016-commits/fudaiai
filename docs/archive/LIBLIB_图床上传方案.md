# LiblibAI ControlNet 本地图片上传方案

## 🎯 问题说明

LiblibAI的ControlNet功能（Canny、QR Code等）**要求控制图必须是公网可访问的URL**，因为：
1. LiblibAI的服务器在云端
2. 它需要从互联网下载控制图
3. 本地文件路径（`C:\Users\...`）它无法访问

## ✅ 解决方案：自动图床上传

**已实现功能：**
当你在Canny模型中上传本地图片时，系统会：
1. 检测是否是本地base64图片
2. **自动上传到免费图床（ImgBB）**
3. 获取公网URL
4. 传递给LiblibAI API

## 📋 快速配置（5分钟）

### 步骤1：获取ImgBB API Key

1. **访问** https://api.imgbb.com/
2. **注册/登录**（可用GitHub账号）
3. **复制你的API Key**（32位字符串）

### 步骤2：配置环境变量

1. 在项目根目录创建 `.env` 文件（如果不存在）
2. 添加以下内容：

```bash
# ImgBB图床API Key
VITE_IMGBB_API_KEY=你的32位API_Key
```

3. 保存文件

### 步骤3：重启开发服务器

```bash
# 按 Ctrl+C 停止当前服务器
# 然后重启
npm run dev
```

---

## 🚀 使用方法

### Canny边缘检测（现在支持本地上传了！）

1. 刷新浏览器
2. 选择 `liblib-canny`
3. 填写提示词
4. **点击"控制图URL"右侧的📎按钮上传本地图片**
5. 系统会自动上传到图床并显示URL
6. 点击"点火"

**Console日志会显示：**
```
🌐 检测到本地图片，正在上传到图床...
✅ 图片已上传: https://i.ibb.co/xxxxx/image.jpg
```

---

## 🎨 支持的模型

| 模型 | 是否需要控制图 | 自动上传 |
|------|--------------|---------|
| **liblib-flux-dev** | ❌ 否（纯文生图） | - |
| **liblib-canny** | ✅ 是（边缘检测） | ✅ 支持 |
| **liblib-qrcode** | ❌ 否（文字隐藏） | - |

---

## 🔧 技术细节

### 图床服务选择

**ImgBB（当前方案）**
- ✅ 免费无限制
- ✅ 无需信用卡
- ✅ 速度快
- ✅ 稳定性好
- ⚠️ 需要API Key

**备选方案（可扩展）**
- Cloudinary（25GB免费）
- 七牛云（10GB免费）
- 阿里云OSS（付费）

### 上传流程

```
用户选择本地图片
      ↓
转换为base64
      ↓
调用ImgBB API
      ↓
获取公网URL
      ↓
传递给LiblibAI
```

### 代码位置

- **图床服务**: `src/services/imageHosting.ts`
- **自动上传逻辑**: `src/pages/P4LabPage.tsx` (handleRealRun)
- **环境变量**: `.env` 文件

---

## ❌ 如果没有配置图床

**表现：**
- 上传本地图片后点击"点火"
- 报错：`图片上传失败: 未配置图床服务`

**解决：**
按照上面的步骤配置 `VITE_IMGBB_API_KEY`

---

## 🚨 常见问题

### Q1: 上传失败怎么办？
**可能原因：**
1. API Key配置错误
2. 图片太大（ImgBB限制32MB）
3. 网络连接问题

**解决：**
- 检查`.env`文件中的API Key是否正确
- 尝试压缩图片
- 检查网络连接

### Q2: 可以用其他图床吗？
可以！`imageHosting.ts`已经预留了Cloudinary接口，你可以：
1. 在`.env`添加对应配置
2. 修改`uploadImage`函数的选择逻辑

### Q3: 图片会永久保存吗？
ImgBB的图片**永久保存**，除非你手动删除。

### Q4: 有隐私问题吗？
图片上传到公网后，任何人都可以通过URL访问。如果有隐私需求，建议：
1. 使用自己的私有图床
2. 或使用临时图床服务

---

## 📊 测试清单

- [x] ImgBB API集成
- [x] 自动检测本地base64图片
- [x] 上传并获取公网URL
- [x] 替换inputValues中的control_image_url
- [x] 错误提示
- [ ] UI上传按钮优化（可选）
- [ ] 上传进度显示（可选）
- [ ] 图片预览优化（可选）

---

## 🎯 下一步优化（可选）

1. **上传进度条**：显示上传进度
2. **图片压缩**：自动压缩大图
3. **多图床容错**：ImgBB失败时自动切换到Cloudinary
4. **上传历史**：保存已上传图片的URL
5. **拖拽上传**：支持拖拽文件到输入框

---

**现在就去配置ImgBB API Key，然后测试Canny模型的本地图片上传功能！**
