# 真迹项目：P4 架构复工地图 (RECOVERY_MAP)

## 🗺️ 一、核心支柱（指挥官作战中心）

如果把“真迹”比作一个数字工厂，这三个地方就是它的总控室、原料库和动力核心。

1.  **[EditorPage.tsx](file:///src/pages/EditorPage.tsx) (总控台)**
    *   **职能**: 这是指挥官（用户）的日常操作界面。所有任务的编排、能力包的挂载、执行指令的下达，都在这里完成。它是连接用户意图与底层逻辑的**唯一入口**。

2.  **[CapabilityStore.tsx](file:///src/stores/CapabilityStore.tsx) (军火库)**
    *   **职能**: 这里存放着从实验室 (P4LAB) 研发并验证通过的所有“能力武器”（如 FLUX 生图、CosyVoice 配音）。它是**连接实验室与战场的桥梁**，确保只有成熟的武器才能上战场。

3.  **[PayloadBuilder.ts](file:///src/services/PayloadBuilder.ts) (精密加工车间)**
    *   **职能**: 负责将用户的简单指令、素材库的原料、以及军火库的参数配置，组装成 API 能够听懂的复杂请求包。它是**自动化流水线的核心引擎**。

---

## 🔄 二、数据流向（从点击到交付）

当您在界面上点击“执行步骤”按钮时，后台发生了一场接力赛：

1.  **用户层 (EditorPage)**: 指挥官点击按钮，触发 `handleRunStep` 指令。
2.  **逻辑层 (MissionRunner)**: 执行官接单，检查该步骤挂载了什么“武器” (Capability)，并收集前一步的产出 (Upstream Data) 作为原料。
3.  **加工层 (PayloadBuilder)**: 按照武器说明书 (Manifest)，将原料、参数、模型配置组装成一个标准的快递包裹 (JSON Payload)。
4.  **传输层 (apiService)**: 快递员拿着包裹，敲开对应供应商 (如 SiliconFlow/N1N) 的大门 (API Request)。
5.  **交付层 (UpdateStep)**: 供应商处理完返回成品 (图片/音频)，系统将其存入任务档案，并在界面上展示给指挥官。

---

## 🚧 三、施工断点（最急需修复的短板）

**当前最大痛点**: **[APISlotStore.tsx](file:///src/stores/APISlotStore.tsx) 中的硬编码逻辑**

*   **为什么乱**: 目前大量的模型参数配置（如 FLUX 需要什么参数、Qwen 需要什么参数）都直接写死在这个文件里。
*   **后果**: 每次接入新模型或调整参数，都需要修改代码，风险高且不灵活。这就像每次换一种螺丝，都要把整条生产线拆了重装。
*   **重构方向**: 应完全通过“实验室 (P4LAB)”配置并导出 JSON 来定义这些参数，实现**代码与配置分离**。

---

## 🚀 四、下一步行动建议（复工第一枪）

**任务目标**: **打通“实验室 -> 战场”的闭环验证**

**具体操作**:
1.  **进入实验室**: 启动项目，访问 `/p4-lab` (或点击界面入口)。
2.  **制造武器**: 调试一个简单的“文本生成”或“生图”能力，确保在实验室里能跑通。
3.  **入库**: 点击“封装能力包”，将其导出到能力库。
4.  **实战演练**: 回到 `/p4` (EditorPage)，创建一个新步骤，挂载刚才导出的能力包，点击运行。

**预期效果**: 如果这一套流程跑通，证明 P4 架构的“研发-生产”大动脉已彻底打通，后续只需不断往里填新模型即可，无需再动核心代码。
