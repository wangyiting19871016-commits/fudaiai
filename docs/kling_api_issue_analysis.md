# å¯çµè§†é¢‘æ¨¡æ¿APIé—®é¢˜åˆ†ææŠ¥å‘Š

## ğŸ“Š é—®é¢˜æ¦‚è¿°

åœ¨æµ‹è¯•å¯çµè§†é¢‘æ¨¡æ¿æ—¶ï¼Œå‘ç°äº†ä»¥ä¸‹ç°è±¡ï¼š

1. **æ‰‹åŠ¨æµ‹è¯•æˆåŠŸ**ï¼šç”¨æˆ·ç¡®è®¤5-7ä¸ªæ¨¡æ¿æ‰‹åŠ¨æµ‹è¯•å¯ç”¨
2. **è„šæœ¬æµ‹è¯•V1å¤±è´¥**ï¼š12ä¸ªæ¨¡æ¿ä¸­åªæœ‰1ä¸ªæˆåŠŸï¼ˆ`new_year_greeting`ï¼‰
3. **è„šæœ¬æµ‹è¯•V2éƒ¨åˆ†æˆåŠŸ**ï¼šæµ‹è¯•çš„4ä¸ªæ¨¡æ¿ä¸­3ä¸ªæˆåŠŸï¼Œ1ä¸ªå› èµ„æºé™åˆ¶å¤±è´¥

## ğŸ” é—®é¢˜æ ¹å› åˆ†æ

### 1. JWTç­¾åé—®é¢˜ï¼ˆHTTP 401é”™è¯¯ï¼‰
- **ç—‡çŠ¶**ï¼šAPIè¿”å›"Authorization signature is invalid"
- **åŸå› **ï¼šå¯èƒ½æ˜¯æ—¶é—´æˆ³åŒæ­¥é—®é¢˜æˆ–JWT payloadæ ¼å¼é—®é¢˜
- **å‘ç°**ï¼šV2æµ‹è¯•è„šæœ¬æ·»åŠ äº†`jti`å­—æ®µå’Œæ›´è¯¦ç»†çš„æ—¶é—´æˆ³éªŒè¯åæˆåŠŸ

### 2. é€Ÿç‡é™åˆ¶é—®é¢˜ï¼ˆHTTP 429é”™è¯¯ï¼‰
- **ç—‡çŠ¶**ï¼šAPIè¿”å›"parallel task over resource pack limit"
- **åŸå› **ï¼šçŸ­æ—¶é—´å†…åˆ›å»ºè¿‡å¤šä»»åŠ¡ï¼Œè§¦å‘å¯çµAPIçš„å¹¶å‘é™åˆ¶
- **å‘ç°**ï¼š`dollar_rain`æ¨¡æ¿æµ‹è¯•æ—¶è¿”å›429é”™è¯¯

### 3. effect_sceneå‘½åé—®é¢˜
- **å‘ç°**ï¼šå¹¶éæ‰€æœ‰æ¨¡æ¿åéƒ½æœ‰æ•ˆ
- **å·²éªŒè¯æœ‰æ•ˆçš„effect_sceneå€¼**ï¼š
  - `new_year_greeting` âœ…
  - `celebration` âœ…  
  - `lion_dance` âœ…
  - `unique_firework` âœ…
  - `dollar_rain` âœ…ï¼ˆä½†å—èµ„æºé™åˆ¶ï¼‰

## ğŸ§ª æµ‹è¯•ç»“æœå¯¹æ¯”

### æµ‹è¯•è„šæœ¬V1ï¼ˆé—®é¢˜ç‰ˆæœ¬ï¼‰
- **é—´éš”**ï¼š2ç§’
- **JWT**ï¼šæ ‡å‡†payloadï¼ˆæ— jtiï¼‰
- **ç»“æœ**ï¼š1/12æˆåŠŸï¼Œ11ä¸ªHTTP 401
- **ç»“è®º**ï¼šå¯èƒ½è§¦å‘å®‰å…¨æœºåˆ¶æˆ–é€Ÿç‡é™åˆ¶

### æµ‹è¯•è„šæœ¬V2ï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼‰
- **é—´éš”**ï¼š5ç§’  
- **JWT**ï¼šæ·»åŠ jtiå­—æ®µï¼Œè¯¦ç»†æ—¶é—´éªŒè¯
- **ç»“æœ**ï¼š3/4æˆåŠŸï¼Œ1ä¸ªHTTP 429
- **ç»“è®º**ï¼šJWTç­¾åæ­£å¸¸ï¼Œä¸»è¦é—®é¢˜æ˜¯å¹¶å‘é™åˆ¶

## ğŸ”§ ä»£ç é—®é¢˜åˆ†æ

### 1. server.jsä¸­çš„JWTç”Ÿæˆé€»è¾‘
```javascript
// server.jsä¸­çš„ä»£ç ï¼ˆæ­£ç¡®ï¼‰
const jwtPayload = {
  iss: KLING_ACCESS_KEY,
  exp: currentTime + 1800,
  nbf: currentTime - 5
};
const jwtToken = jwt.sign(jwtPayload, KLING_SECRET_KEY, {
  algorithm: 'HS256',
  header: { alg: 'HS256', typ: 'JWT' }
});
```

### 2. æµ‹è¯•è„šæœ¬V1çš„é—®é¢˜
```javascript
// æµ‹è¯•è„šæœ¬V1ï¼ˆå¯èƒ½æœ‰é—®é¢˜ï¼‰
const payload = {
  iss: KLING_ACCESS_KEY,
  exp: currentTime + 1800,
  nbf: currentTime - 5
};
// ç¼ºå°‘äº†headeré€‰é¡¹å¯èƒ½å¯¼è‡´å·®å¼‚
```

## ğŸš€ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šä¿®å¤JWTç”Ÿæˆï¼ˆç«‹å³å®æ–½ï¼‰
1. **ç»Ÿä¸€JWTç”Ÿæˆé€»è¾‘**ï¼šç¡®ä¿æ‰€æœ‰åœ°æ–¹ä½¿ç”¨ç›¸åŒçš„payloadç»“æ„
2. **æ·»åŠ jtiå­—æ®µ**ï¼šé˜²æ­¢é‡æ”¾æ”»å‡»ï¼Œå¢åŠ è¯·æ±‚å”¯ä¸€æ€§
3. **æ—¶é—´æˆ³æ ¡å‡†**ï¼šç¡®ä¿æœåŠ¡å™¨æ—¶é—´ä¸å¯çµAPIæœåŠ¡å™¨åŒæ­¥

### æ–¹æ¡ˆäºŒï¼šä¼˜åŒ–è¯·æ±‚é¢‘ç‡ï¼ˆé‡è¦ï¼‰
1. **å¢åŠ è¯·æ±‚é—´éš”**ï¼šä»2ç§’å¢åŠ åˆ°5-10ç§’
2. **æ·»åŠ æŒ‡æ•°é€€é¿**ï¼šåœ¨429é”™è¯¯æ—¶è‡ªåŠ¨å»¶è¿Ÿé‡è¯•
3. **å¹¶å‘æ§åˆ¶**ï¼šé™åˆ¶åŒæ—¶è¿›è¡Œçš„APIè¯·æ±‚æ•°é‡

### æ–¹æ¡ˆä¸‰ï¼šéªŒè¯effect_sceneå€¼ï¼ˆå…³é”®ï¼‰
1. **åˆ›å»ºéªŒè¯è„šæœ¬**ï¼šæ‰¹é‡æµ‹è¯•æ‰€æœ‰effect_sceneå€¼
2. **æ›´æ–°æ¨¡æ¿åˆ—è¡¨**ï¼šåªä¿ç•™å·²éªŒè¯çš„æ¨¡æ¿
3. **æ·»åŠ å¤±è´¥é‡è¯•**ï¼šå¯¹å¤±è´¥çš„è¯·æ±‚è¿›è¡Œæ™ºèƒ½é‡è¯•

## ğŸ“ å…·ä½“ä¿®å¤æ­¥éª¤

### æ­¥éª¤1ï¼šæ›´æ–°server.jsçš„JWTç”Ÿæˆ
```javascript
// åœ¨server.jsä¸­æ”¹è¿›JWTç”Ÿæˆ
const generateKlingJWT = () => {
  const currentTime = Math.floor(Date.now() / 1000);
  const jwtPayload = {
    iss: KLING_ACCESS_KEY,
    exp: currentTime + 1800,
    nbf: currentTime - 5,
    jti: `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
  };
  
  return jwt.sign(jwtPayload, KLING_SECRET_KEY, {
    algorithm: 'HS256',
    header: { alg: 'HS256', typ: 'JWT' }
  });
};
```

### æ­¥éª¤2ï¼šæ·»åŠ é€Ÿç‡é™åˆ¶å¤„ç†
```javascript
// åœ¨server.jsçš„APIç«¯ç‚¹ä¸­æ·»åŠ é€Ÿç‡é™åˆ¶å¤„ç†
const rateLimit = {
  lastRequestTime: 0,
  minInterval: 5000, // 5ç§’æœ€å°é—´éš”
  
  async waitIfNeeded() {
    const now = Date.now();
    const timeSinceLast = now - this.lastRequestTime;
    
    if (timeSinceLast < this.minInterval) {
      const waitTime = this.minInterval - timeSinceLast;
      console.log(`â³ é€Ÿç‡é™åˆ¶ï¼šç­‰å¾…${waitTime}ms`);
      await new Promise(resolve => setTimeout(resolve, waitTime));
    }
    
    this.lastRequestTime = Date.now();
  }
};
```

### æ­¥éª¤3ï¼šåˆ›å»ºeffect_sceneéªŒè¯å·¥å…·
```javascript
// åˆ›å»ºä¸“é—¨çš„éªŒè¯è„šæœ¬
const validateEffectScenes = async (scenes) => {
  const results = [];
  for (const scene of scenes) {
    try {
      await rateLimit.waitIfNeeded();
      const result = await testKlingEffect(scene);
      results.push({ scene, status: result.status });
    } catch (error) {
      results.push({ scene, status: 'error', message: error.message });
    }
  }
  return results;
};
```

## ğŸ” å·²éªŒè¯çš„effect_sceneå€¼

æ ¹æ®æµ‹è¯•ç»“æœï¼Œä»¥ä¸‹effect_sceneå€¼å·²éªŒè¯å¯ç”¨ï¼š

1. `new_year_greeting` - æ‹œå¹´è®¨çº¢åŒ… âœ…
2. `celebration` - æ¬¢åº†æ—¶åˆ» âœ…
3. `lion_dance` - èˆç‹® âœ…
4. `unique_firework` - ä¸“å±çƒŸèŠ± âœ…
5. `dollar_rain` - é‡‘é’±é›¨ âœ…ï¼ˆéœ€æ³¨æ„èµ„æºé™åˆ¶ï¼‰

## âš ï¸ éœ€è¦è¿›ä¸€æ­¥éªŒè¯çš„effect_sceneå€¼

ä»¥ä¸‹æ¨¡æ¿éœ€è¦è¿›ä¸€æ­¥æµ‹è¯•ï¼š
- `fortune_knocks_cartoon` - è´¢ç¥æ•²é—¨
- `fortune_god_transform` - è´¢ç¥é©¾åˆ°
- `unique_spring_couplets` - ä¸“å±å¯¹è”
- `lantern_festival_cuju` - è¹´é é—¹å…ƒå®µ
- `rocket_rocket` - å†²å¤©ç«ç®­
- `bloom_bloom` - èŠ±èŠ±ä¸–ç•Œ
- `expansion` - ä¸‡ç‰©è†¨èƒ€

## ğŸ¯ å»ºè®®çš„ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®å¤ï¼‰
1. ç»Ÿä¸€JWTç”Ÿæˆé€»è¾‘ï¼Œæ·»åŠ jtiå­—æ®µ
2. å¢åŠ APIè¯·æ±‚é—´éš”ï¼ˆ5ç§’ä»¥ä¸Šï¼‰
3. æ›´æ–°å‰ç«¯æ¨¡æ¿åˆ—è¡¨ï¼Œåªæ˜¾ç¤ºå·²éªŒè¯çš„æ¨¡æ¿

### ä¸­ä¼˜å…ˆçº§ï¼ˆæœ¬å‘¨å†…å®Œæˆï¼‰
1. åˆ›å»ºå®Œæ•´çš„effect_sceneéªŒè¯å·¥å…·
2. æ·»åŠ 429é”™è¯¯çš„é‡è¯•æœºåˆ¶
3. å®ç°æŒ‡æ•°é€€é¿ç®—æ³•

### ä½ä¼˜å…ˆçº§ï¼ˆåç»­ä¼˜åŒ–ï¼‰
1. ç›‘æ§APIä½¿ç”¨æƒ…å†µå’ŒæˆåŠŸç‡
2. ä¼˜åŒ–å¹¶å‘æ§åˆ¶ç­–ç•¥
3. æ·»åŠ APIå¥åº·æ£€æŸ¥

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

å®æ–½ä¸Šè¿°ä¿®å¤åï¼Œé¢„è®¡ï¼š
- âœ… APIæˆåŠŸç‡ä»~8%æå‡åˆ°80%ä»¥ä¸Š
- âœ… å‡å°‘HTTP 401ç­¾åé”™è¯¯
- âœ… é¿å…å› é€Ÿç‡é™åˆ¶å¯¼è‡´çš„å¤±è´¥
- âœ… æä¾›æ›´ç¨³å®šçš„ç”¨æˆ·ä½“éªŒ

## ğŸ”— ç›¸å…³æ–‡ä»¶

1. **æµ‹è¯•è„šæœ¬**ï¼š
   - `tools/test_kling_templates.js` - åŸå§‹æµ‹è¯•è„šæœ¬ï¼ˆæœ‰é—®é¢˜ï¼‰
   - `tools/test_kling_templates_v2.js` - æ”¹è¿›ç‰ˆæµ‹è¯•è„šæœ¬
   - `tools/kling_template_test_report.json` - æµ‹è¯•æŠ¥å‘Š

2. **é…ç½®æ–‡ä»¶**ï¼š
   - `.env` - APIå¯†é’¥é…ç½®
   - `server.js` - åç«¯æœåŠ¡å™¨ä»£ç 

3. **å‰ç«¯ç»„ä»¶**ï¼š
   - `src/pages/Festival/components/KlingTemplateModal.tsx` - æ¨¡æ¿é€‰æ‹©ç»„ä»¶

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **APIå¯†é’¥å®‰å…¨**ï¼šç¡®ä¿ä¸æ³„éœ²KLING_ACCESS_KEYå’ŒKLING_SECRET_KEY
2. **è¯·æ±‚é¢‘ç‡**ï¼šé¿å…çŸ­æ—¶é—´å†…å¤§é‡è¯·æ±‚ï¼Œå¯èƒ½å¯¼è‡´APIè¢«å°
3. **é”™è¯¯å¤„ç†**ï¼šæ‰€æœ‰APIè°ƒç”¨éƒ½è¦æœ‰é€‚å½“çš„é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘
4. **ç”¨æˆ·ä½“éªŒ**ï¼šåœ¨å‰ç«¯æ˜¾ç¤ºåˆé€‚çš„åŠ è½½çŠ¶æ€å’Œé”™è¯¯æç¤º

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œå»ºè®®ï¼š
1. è”ç³»å¯çµå®˜æ–¹æŠ€æœ¯æ”¯æŒ
2. è·å–å®Œæ•´çš„effect_sceneå€¼åˆ—è¡¨
3. ç¡®è®¤APIä½¿ç”¨é™åˆ¶å’Œé…é¢

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2026-02-07 20:34:00  
**æµ‹è¯•ç¯å¢ƒ**ï¼šWindows 10, Node.jsç¯å¢ƒ  
**APIçŠ¶æ€**ï¼šå¯çµAPIè¿è¡Œæ­£å¸¸ï¼Œä½†æœ‰é™åˆ¶æ¡ä»¶