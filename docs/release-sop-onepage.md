# 春节项目一页纸上线SOP

## 目标
3天内稳妥上线：支付可闭环、积分可核对、核心链路可用、安全风险可控。

---

## A. 上线前准备（20分钟）

1. 锁环境  
- 前端只指向腾讯云后端  
- 关闭测试开关（见下方配置）

2. 配置检查  
- 后端 `.env`：`NODE_ENV=production`、`PAYMENT_MODE=production`、`ALLOW_MANUAL_COMPLETE=false`  
- 前端变量：`VITE_API_BASE_URL` 指向腾讯云  
- 积分策略：`VITE_CREDIT_ENFORCE=on`、`VITE_CREDIT_LOCAL_FALLBACK=off`

3. 素材检查  
- 首页图是否已替换为目标素材  
- 免费分享水印二维码地址是否可访问

---

## B. 核心链路冒烟（30分钟）

1. 生成功能  
- M1、M2、M3 各跑1次（上传 -> 生成 -> 结果）  
- 视频链路跑1次（图+音频 -> 生成视频）

2. 支付闭环  
- 创建订单 -> 完成真实支付1笔 -> 回到成功页  
- 校验 `order-status` 为 `paid`

3. 积分闭环  
- 支付后查余额：`/api/credits/balance/:visitorId`  
- 执行一次扣分功能，确认 `/api/credits/consume` 扣减成功

---

## C. 上线闸门（Go/No-Go）

必须全部满足才Go：

1. P0=0（无支付错单、无积分错扣、无核心链路不可用）  
2. 真实支付闭环通过  
3. 扣分闭环通过  
4. 免费水印/会员无水印符合预期  
5. 回滚路径已确认

---

## D. 回滚预案（5分钟可执行）

触发条件（任一）：

1. 支付异常连续出现  
2. 积分异常（重复加分/误扣）  
3. 核心生成功能失败率明显升高

执行：

1. 前端回滚到上一个Vercel部署  
2. 后端切回上一稳定版本  
3. 临时打开兜底（仅短时）：`VITE_CREDIT_LOCAL_FALLBACK=on`  
4. 问题修复后改回：`VITE_CREDIT_LOCAL_FALLBACK=off`

---

## E. 24小时值守节奏

每2小时检查一次：

1. 下单成功率  
2. 回调成功率  
3. 积分扣减成功率  
4. 5xx/超时比例  

异常处理顺序：

1. 先限流保护  
2. 再定位日志  
3. 最后热修或回滚

