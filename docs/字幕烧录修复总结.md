# 字幕烧录问题修复总结

**修复时间**: 2026-02-08
**状态**: ✅ 已完成

---

## 问题回顾

**用户反馈**: 数字人视频字幕"一会显示、一会不显示"

**根本原因**:
- FFmpeg字幕烧录失败时，前端静默降级使用原视频（无字幕）
- 用户不知道发生了什么，以为是bug

---

## 解决方案

### 采用全新的智能字幕烧录API

**新API**: `POST /api/video/burn-subtitle`
**优势**:
1. ✅ **智能算法** - 按字数权重分配时间，而不是简单平均
2. ✅ **自动合并短段** - 每段至少1.2秒，避免闪现
3. ✅ **更简洁** - 只需 `videoUrl` + `subtitle`
4. ✅ **明确提示** - 失败时前端显示警告

**测试结果**:
```
✅ 短文案测试 (5字): 1段字幕, 4.6秒
✅ 中等文案测试 (32字): 3段字幕, 平均1.5秒/段
✅ 长文案测试 (82字): 4段字幕, 按字数权重分配
✅ API参数验证: 正常
```

---

## 修改文件

### 1. server.js (+250行)
- 新增 `generateSmartSRT` 函数
- 新增 `/api/video/burn-subtitle` API

### 2. VideoPage.tsx (~40行修改)
- 改用新API调用
- 失败时显示明确警告

### 3. 新增测试工具
- `tools/test_subtitle_simple.js` - 算法测试
- `tools/diagnose_subtitle_burning.js` - 诊断工具

---

## 使用方法

### 后端启动
```bash
cd F:\project_kuajing
node server.js
```

### 测试验证
```bash
node tools/test_subtitle_simple.js
```

### 前端测试
1. 访问: http://localhost:5173/festival/video
2. 上传图片 + 输入文案 + 生成视频
3. 检查字幕是否正确显示
4. 下载视频验证字幕已烧录

---

## 技术细节

### 智能字幕算法

**分段规则**:
- 按句号/问号/感叹号断句
- 逗号不断句（保持语句完整）

**时间分配**:
```javascript
// 按字数权重分配时间
const weight = sentence.length / totalChars;
const duration = weight * availableDuration;
```

**自动合并**:
- 每段至少1.2秒
- 段数过多时自动合并最短的段

**字幕样式**:
- FontSize=24（原60太大）
- BorderStyle=3（不透明背景框）
- MarginV=30（距底部30px）
- Alignment=2（底部居中）

---

## 部署检查

- [x] 后端代码已更新
- [x] 前端代码已更新
- [x] 算法测试通过
- [x] API测试通过
- [ ] 完整前端测试（待用户验证）
- [ ] 生产环境部署

---

## 下一步

1. **用户完整测试**
   - 生成多个数字人视频
   - 验证字幕显示效果
   - 测试不同长度的文案

2. **可选优化**
   - ASR实时字幕（更精准）
   - 字幕样式模板（多种风格）
   - 装饰元素叠加（红灯笼、福字）

---

**修复完成** ✅
