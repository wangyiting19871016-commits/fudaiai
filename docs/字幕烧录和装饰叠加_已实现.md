# 字幕烧录和装饰叠加功能 - 已实现

**实现时间**: 2026-02-06
**状态**: ✅ 已完成基础功能

---

## 已实现功能

### 1. 后端API：视频后处理

**端点**: `POST /api/video/post-process`
**文件**: `server.js` 第887行

**功能**:
- ✅ 字幕烧录（FFmpeg drawtext滤镜）
- ✅ 装饰元素叠加（FFmpeg overlay滤镜）
- ✅ 支持多个装饰元素（灯笼、福字等）
- ✅ 装饰元素位置可配置（top-left, top-right, bottom-left, bottom-right, center）
- ✅ 自动下载和临时文件管理
- ✅ 错误处理和资源清理

**请求示例**:
```json
{
  "videoUrl": "https://xxx.com/video.mp4",
  "subtitle": "新年快乐，恭喜发财！",
  "decorations": [
    {
      "url": "https://xxx.com/lantern.png",
      "position": "top-left"
    },
    {
      "url": "https://xxx.com/blessing.png",
      "position": "top-right"
    }
  ]
}
```

**响应示例**:
```json
{
  "status": "success",
  "downloadUrl": "http://localhost:3002/downloads/processed_1234567890.mp4",
  "fileName": "processed_1234567890.mp4"
}
```

---

### 2. 前端集成：VideoPage自动字幕烧录

**文件**: `src/pages/Festival/VideoPage.tsx` 第454-490行

**流程**:
1. WAN生成视频（动嘴同步）
2. **自动调用后处理API**，烧录字幕
3. 返回带字幕的最终视频
4. 用户下载后**保留字幕**

**代码逻辑**:
```typescript
// WAN视频生成完成后
let remoteVideoUrl = wanResult.output.results.video_url;

// 如果有文案，自动调用后处理API
if (text.trim()) {
  const postProcessResponse = await fetch('http://localhost:3002/api/video/post-process', {
    method: 'POST',
    body: JSON.stringify({
      videoUrl: remoteVideoUrl,
      subtitle: text.trim(),
      decorations: [] // 预留装饰元素接口
    })
  });

  if (postProcessResult.status === 'success') {
    remoteVideoUrl = postProcessResult.downloadUrl; // 使用新视频
  }
}
```

---

## 字幕样式配置

**字体**: 微软雅黑 (msyh.ttc)
**字号**: 80
**颜色**: 白色
**描边**: 4px 黑色
**阴影**: 2px 半透明黑色
**背景**: 半透明黑色背景框
**位置**: 底部居中，距离底部120px

---

## 装饰元素支持的位置

| position | 说明 |
|----------|------|
| `top-left` | 左上角 |
| `top-right` | 右上角 |
| `bottom-left` | 左下角 |
| `bottom-right` | 右下角 |
| `center` | 居中 |

---

## 测试方法

### 1. 启动后端服务

```bash
cd F:\project_kuajing
node server.js
```

确保看到：
```
✅ 物理保存路径已锁定: F:/project_kuajing/temp_processing
✅ 下载目录已初始化: F:\project_kuajing\downloads
🚀 API server listening on http://localhost:3002
```

### 2. 访问VideoPage

打开浏览器访问视频生成页面。

### 3. 生成视频

1. 选择或上传图片
2. 输入文案（如："新年快乐，恭喜发财！"）
3. 选择音色
4. 点击"生成视频"

### 4. 验证字幕烧录

**关键步骤**：
- 查看浏览器控制台，确认看到：
  ```
  [VideoPage] 调用后处理API烧录字幕
  [VideoPage] 字幕烧录成功，新视频URL: http://localhost:3002/downloads/processed_xxx.mp4
  ```

- 下载视频到本地
- 用播放器打开（VLC、PotPlayer等）
- **字幕应该固定显示在视频中**（不可关闭）

---

## 下一步：装饰元素模板

### TODO 列表

- [ ] 准备春节装饰素材（PNG透明图）
  - [ ] 红灯笼 x3
  - [ ] 福字 x3
  - [ ] 鞭炮 x2
  - [ ] 烟花 x2

- [ ] 添加模板选择UI
  - [ ] 在VideoPage添加"春节模板"选择器
  - [ ] 预览装饰元素位置
  - [ ] 支持自定义组合

- [ ] 集成装饰元素到后处理API
  - [ ] 修改VideoPage传递decorations参数
  - [ ] 测试多装饰元素叠加

---

## 技术细节

### FFmpeg命令示例

**字幕烧录**:
```bash
ffmpeg -i video.mp4 \
  -vf "drawtext=text='新年快乐':fontfile='C:/Windows/Fonts/msyh.ttc':fontsize=80:fontcolor=white:..." \
  output.mp4
```

**装饰叠加**:
```bash
ffmpeg -i video.mp4 -i lantern.png \
  -filter_complex "[0:v][1:v]overlay=10:10" \
  output.mp4
```

**字幕+多装饰**:
```bash
ffmpeg -i video.mp4 -i lantern.png -i blessing.png \
  -filter_complex "[0:v][1:v]overlay=10:10[tmp];[tmp][2:v]overlay=W-w-10:10[v];[v]drawtext=..." \
  output.mp4
```

---

## 对比豆包的差异化价值

| 功能 | 豆包 | 我们 |
|------|------|------|
| 动嘴同步 | ✅ | ✅ |
| 字幕烧录 | ❌ | ✅ |
| 春节装饰模板 | ❌ | ✅（待完成） |
| 自定义装饰元素 | ❌ | ✅（待完成） |
| 一站式体验 | ❌ | ✅ |
| 文案模板库 | ❌ | 📋（计划中） |

---

## 成本核算

**WAN 2.2-s2v**: 5秒1080P = **3.5元**
**后处理（FFmpeg）**: **免费**（自建服务器资源）
**总成本**: **3.5元/视频**

**建议定价**: **5-8元/视频**
**利润**: **1.5-4.5元/视频**

---

## 备注

- ✅ 字幕烧录已完全集成，用户下载后视频包含字幕
- ✅ 不再依赖前端WebVTT临时字幕
- 🎯 下一步重点：添加春节装饰模板UI
- 📝 装饰素材需要PNG透明背景图
