# 安全评估报告

**评估时间**: 2026-02-08
**评估人**: Claude Code
**风险等级**: 🔴 **严重 - 不可部署**

---

## 当前安全状况

### 🔴 严重问题

#### 1. 前端暴露所有API密钥

**文件**: `src/config/ApiVault.ts`

**暴露的密钥**:
```typescript
N1N: {
  MASTER_KEY: 'sk-tTHj1OFcBEgEEQ8oi3kkKUHpjpluQzo0ySRZ8o8vY5EX68fN'
}
SILICONFLOW: {
  MASTER_KEY: 'sk-tpcfhwsckdrngcfeymudxjgnuhxadegbqzjztnakfceutvwy'
}
LIBLIB: {
  ACCESS_KEY: 'z8_g6KeL5Vac48fUL6am2A'
  SECRET_KEY: 'FbPajEW5edStMVxBJuRUDu7fwr1Hy5Up'
}
FISH_AUDIO: {
  API_KEY: '58864427d9e44e4ca76febe5b50639e6'
}
```

**风险**:
- ⚠️ 所有密钥会打包进前端JS bundle
- ⚠️ 用户可以在浏览器开发者工具中看到
- ⚠️ 任何人都可以提取并滥用这些密钥
- ⚠️ 会产生巨额账单

#### 2. MissionExecutor直接读取前端密钥

**文件**: `src/services/MissionExecutor.ts` Line 729-730

```typescript
const accessKey = API_VAULT.LIBLIB.ACCESS_KEY;  // 从前端读取
const secretKey = API_VAULT.LIBLIB.SECRET_KEY;  // 从前端读取
```

**风险**:
- ⚠️ 没有使用后端代理
- ⚠️ 密钥在客户端明文传输
- ⚠️ 无法撤销已暴露的密钥

---

## 🟡 次要问题

### 3. 后端代理存在但未使用

**文件**: `api-proxy-endpoints.js` ✅ 已创建

**问题**:
- 代理端点已实现：
  - `/api/liblib/text2img`
  - `/api/liblib/query`
  - `/api/fish/tts`
- 但前端服务（MissionExecutor, FishAudioService等）没有使用这些代理
- 形同虚设

### 4. secureApiService存在但未集成

**文件**: `src/services/secureApiService.ts` ✅ 已创建

**问题**:
- 安全拦截器已实现
- 但MissionExecutor没有使用它
- 仍在使用不安全的apiService

---

## 部署风险评估

### 如果现在部署会发生什么？

1. **前端JS打包**
   ```
   npm run build
   ↓
   dist/assets/index-xxxxx.js (包含所有API密钥明文)
   ```

2. **用户访问网站**
   ```
   用户打开浏览器开发者工具
   ↓
   Sources标签 → 查看JS文件
   ↓
   搜索 "ACCESS_KEY" 或 "API_KEY"
   ↓
   轻松获取所有API密钥
   ```

3. **密钥被滥用**
   ```
   恶意用户提取密钥
   ↓
   大量调用API（图像生成、语音合成）
   ↓
   产生巨额账单
   ```

**预估损失**:
- LiblibAI图像生成: ¥0.3/张 × 10000张 = ¥3000
- Fish Audio语音: ¥0.15/次 × 5000次 = ¥750
- 其他API: ¥2000+
- **总计风险**: ¥5750+

---

## 解决方案对比

### 方案A: 完全后端代理（推荐）

**优点**:
- ✅ 密钥完全隐藏在后端
- ✅ 前端无法看到真实密钥
- ✅ 可以随时更换密钥而不影响前端
- ✅ 符合安全最佳实践

**缺点**:
- ⚠️ 需要修改多个前端服务文件
- ⚠️ 需要测试所有功能

**实施步骤**:
1. 修改ApiVault.ts - 移除所有密钥
2. 修改MissionExecutor - 使用secureApiService
3. 修改FishAudioService - 使用后端代理
4. 在后端.env中配置密钥
5. 测试所有功能
6. 部署

**工作量**: 2-3小时

---

### 方案B: 环境变量方案（次优）

**优点**:
- ✅ 密钥不在代码中
- ✅ 改动较小

**缺点**:
- ❌ 密钥仍会打包进前端JS
- ❌ 构建时需要注入环境变量
- ❌ 不够安全

**不推荐原因**:
前端环境变量在构建时会被替换成明文值，最终仍然暴露在JS bundle中

---

### 方案C: 临时方案（仅用于测试）

**做法**:
- 在Vercel/Netlify部署时使用Private环境
- 添加访问密码
- 限制IP访问

**缺点**:
- ❌ 治标不治本
- ❌ 不适合正式上线

---

## 推荐行动计划

### 立即执行（部署前必须完成）

1. **不要立即部署** - 当前状态会导致密钥泄露

2. **实施方案A** - 完全后端代理
   - [ ] 修改ApiVault.ts
   - [ ] 修改MissionExecutor.ts
   - [ ] 修改FishAudioService.ts
   - [ ] 修改VoiceService.ts
   - [ ] 配置后端环境变量
   - [ ] 完整测试

3. **验证安全性**
   - [ ] npm run build
   - [ ] 检查dist/assets/index-xxx.js是否包含密钥
   - [ ] 应该找不到任何API密钥字符串

4. **部署**
   - [ ] 后端部署到Render（配置环境变量）
   - [ ] 前端部署到Vercel
   - [ ] 再次验证密钥不可见

---

## 当前决策

**问题**: 刚才为了修复M1功能，我回滚了ApiVault.ts，导致密钥重新暴露

**选项**:

**选项1 - 立即修复安全问题（推荐）**
- 现在就实施方案A
- 2-3小时完成
- 今晚可以安全部署

**选项2 - 临时绕过（不推荐）**
- 为了今天测试，暂时保持现状
- 明天再修复安全问题
- **风险**: 如果忘记修复就部署会很危险

**选项3 - 分步实施**
- 今天只部署到测试环境（添加访问密码）
- 明天修复安全问题后再正式上线

---

## 我的建议

**建议选项1** - 立即修复安全问题

理由:
1. 安全问题不能拖延
2. 修复工作量不大（2-3小时）
3. 一次性解决，避免遗忘
4. 今晚仍可完成部署

**下一步**:
1. 你决定选择哪个方案
2. 如果选方案A，我立即开始修复
3. 如果选其他方案，我会遵照执行

---

**等待你的决策！** 🎯
