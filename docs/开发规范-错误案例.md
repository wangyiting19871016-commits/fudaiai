# 常见错误案例集

**重要性**: 极高 - 前车之鉴，后车之师
**最后更新**: 2026-02-05

[返回总览](./开发规范-总览.md)

---

**本文档记录项目中发生的所有重大错误案例，供参考和警示。**

---


**问题描述**:
将卡片标题移到外部后，grid布局从"一大2小加一个横"变成了2x2均匀布局。

**根本原因**:
添加wrapper div后，grid的直接子元素从 `.glass-card` 变成了 wrapper，但 `grid-column: span 2` 仍设置在 `.glass-card` 上。

**原始代码（正常）**:
```tsx
<div className="category-grid">
  <div className="glass-card card-large">  {/* ✓ 直接子元素 */}
    内容
  </div>
</div>
```

**修改后（崩溃）**:
```tsx
<div className="category-grid">
  <div>  {/* ← wrapper成为直接子元素 */}
    <div className="glass-card card-large">  {/* ✗ 孙元素，grid-column失效 */}
      内容
    </div>
  </div>
</div>
```

**正确修复**:
```tsx
<div
  style={{
    gridColumn: (isFirst || isLast) ? 'span 2' : 'auto'  // ← 移到wrapper上
  }}
>
  <div className="glass-card">内容</div>
</div>
```

**教训**:
- 添加wrapper时必须同步检查CSS
- 使用DevTools立即验证布局
- Grid属性只对直接子元素生效

---

### 案例3: 移动端步骤指示器问题（2026-01-30）

**问题描述**:
移动端步骤指示器占据屏幕1/3高度，用户需下滑才能看到生成按钮。

**错误诊断**:
AI首先怀疑是缓存问题，浪费1小时清除缓存、修改端口等。

**实际问题**:
步骤指示器在移动端占用空间太多，应该完全隐藏。

**正确解法**:
```css
@media (max-width: 480px) {
  .step-indicator {
    display: none !important;  /* 移动端隐藏 */
  }
}
```

**教训**:
- 移动端问题不要首先怀疑缓存
- 检查代码逻辑而非外部因素
- 移动端空间宝贵，不必要的元素直接隐藏

---

### 案例4: .env文件全量覆盖事故（2026-02-04）⚠️⚠️⚠️

**严重程度**: 🔴 极其严重 - 数据丢失

**问题描述**:
在实施支付系统时，AI使用 `Write` 工具直接覆盖了现有的 `.env` 文件，导致所有已配置的AI API密钥全部丢失。

**违反的规则**:
1. **Write工具明确规定**: "If this is an existing file, you MUST use the Read tool first"
2. **用户规范**: "ALWAYS prefer editing existing files. NEVER write new files unless explicitly required"
3. **基本操作原则**: 配置文件（.env, .config等）属于关键文件，必须特别谨慎

**造成的损失**:
- ⏱️ **时间损失**: 用户浪费3小时重新配置和排查
- 💰 **成本损失**: 几十美金的Token费用
- 📋 **数据损失**: 所有AI API密钥配置丢失：
  - `VITE_DASHSCOPE_API_KEY`（阿里云通义千问）
  - `VITE_DEEPSEEK_API_KEY`（DeepSeek）
  - `VITE_TENCENT_COS_SECRET_ID/KEY/BUCKET/REGION`（腾讯云COS）
  - `VITE_IMGBB_API_KEY`（ImgBB图床）
- 🔐 **安全问题**: 部分密钥因腾讯云安全策略（"2023年11月30日起，新建密钥只在创建时提供SecretKey"）无法重新查看
- 😤 **信任损失**: 用户表示"想起诉你们公司"

**错误执行流程**:
```bash
# ❌ 错误操作
Write .env (新内容：只包含支付配置)
# → 覆盖了原有的所有AI API配置
```

**正确流程应该是**:
```bash
# ✅ 正确操作
1. Read .env (查看现有内容)
2. 分析现有配置
3. Edit .env (追加支付配置到末尾)
   old_string: (文件末尾)
   new_string:
   # ========== 支付配置 ==========
   HUPIJIAO_APP_ID=xxx
   ...
```

**次生错误**:
1. **字符识别错误**: 从用户提供的密钥图片中识别COS SecretKey时出错
   - 原本: `gBSVLNIE3oNqZ8aqvnSvBDcu1ymvviJh`
   - 错误识别: `gBSVLNlE3oNqZ8agynSvBDcu1ymvviJh`
   - 差异: 第7位 `I`→`l`，第16-18位 `aqv`→`agy`
   - 导致: 反复测试失败，用户更加愤怒

2. **未进行全面验证**: 配置恢复后没有立即进行全面测试
   - 应该: 恢复配置后立即测试所有功能
   - 实际: 让用户逐个功能测试，发现问题

**强制性约束（违反将被视为严重事故）**:

#### 1. 文件操作强制规范

**配置文件操作禁令**:
```
🚫 绝对禁止对以下文件使用Write工具全量覆盖:
   - .env / .env.* (环境变量)
   - package.json (依赖配置)
   - tsconfig.json (TypeScript配置)
   - vite.config.* (构建配置)
   - *.config.js/ts (所有配置文件)
   - README.md (项目文档)
```

**必须遵守的流程**:
```
1. 修改任何现有文件前，必须先Read
2. 配置文件只能使用Edit追加/修改，严禁Write覆盖
3. 如果必须创建新文件，文件名必须明确是"新文件"（如.env.new）
```

#### 2. 密钥/凭证处理强制规范

**读取密钥时**:
```
✅ 必须做:
   1. 从图片识别密钥时，逐字符仔细核对
   2. 特别注意易混淆字符: l/I/1, 0/O, g/q/9, v/y, B/8
   3. 识别后立即测试验证，不要等到用户测试
   4. 提供配置内容给用户核对

❌ 严禁:
   1. 未经测试就认为识别正确
   2. 让用户逐个功能测试发现问题
```

#### 3. 配置恢复强制流程

**当配置丢失需要恢复时**:
```
强制执行顺序:
1. 停止所有操作，优先恢复配置
2. 搜索所有可能的备份位置:
   - git历史记录
   - 备份文件夹
   - 用户提供的截图/文档
3. 逐项恢复配置
4. 每项配置后立即测试验证
5. 全部恢复后进行完整的功能测试
6. 向用户提供完整配置清单核对
```

#### 4. 补救措施 SOP

**发生配置丢失后的标准操作程序**:
```
立即执行（5分钟内）:
□ 承认错误，不找借口
□ 停止当前任务，全力恢复配置
□ 搜索所有可能的备份

30分钟内:
□ 向用户提供当前配置清单
□ 请求用户提供原始密钥
□ 逐项测试验证

1小时内:
□ 完成所有配置恢复
□ 进行全面功能测试
□ 形成事故报告

永久记录:
□ 更新开发规范文档
□ 添加强制约束条款
□ 作为反面教材警示
```

**赔偿标准**:
```
类似事故造成的损失:
- 用户时间: 按市场价计算
- Token费用: 实际产生费用
- 情感损失: 郑重道歉
- 数据丢失: 协助恢复所有可恢复数据
```

**教训总结**:
1. ⚠️ **永远不要覆盖配置文件** - 使用Edit而非Write
2. 🔍 **操作前必须Read** - 遵守工具使用规范
3. ✅ **密钥识别后立即测试** - 不要让用户发现错误
4. 📋 **提供配置清单给用户核对** - 让用户参与验证
5. 🚫 **没有任何理由可以违反Write工具规范** - 规则就是规则

**此事故被列为开发规范中的最严重案例，必须永久铭记。**

---

## 案例5: 赛博算命功能优化记录（2026-02-04）

### 📅 时间线
- **日期**: 2026-02-04
- **功能**: 赛博算命（M8）
- **问题类型**: 功能优化、准确性提升、用户体验改进

---

### ✅ 已完成的工作

#### 1. **移除年龄输出（隐私保护）**

**问题**: 原先算命结果会显示用户年龄，存在隐私问题
- 猜对了没人觉得好
- 猜错了别人不高兴
- 年龄是敏感信息

**解决方案**:
- 修改 `qwen_face_analysis` prompt，完全移除年龄字段提取
- 修改 `cyber_fortune` prompt，移除所有年龄相关的判断逻辑
- 算命结果不再显示或使用年龄信息

**文件**: `F:\project_kuajing\src\configs\festival\prompts.ts`

---

#### 2. **增强神棍算命话术**

**优化内容**:
- 添加大量玄学术语：天庭、印堂、人中、山根、法令纹、鼻准、颧骨、地阁、五行、八字、命宫
- 11步详细神棍流程（开场镇场子、五行判断、痣相解读、配饰风水、五官相法等）
- slogan要求提到3-4个具体特征（18-20字）
- analysis_reason使用相术术语（60-70字）

**文件**: `F:\project_kuajing\src\configs\festival\prompts.ts`

---

#### 3. **修复JSON解析错误**

**问题**: Qwen返回文本格式（key: value）导致 `JSON.parse()` 失败

**解决方案**:
- 修改 `qwen_face_analysis` prompt，要求输出纯JSON格式
- 修改 `aliService.ts` 解析逻辑，智能识别中文字段JSON
- 添加兜底逻辑，自动格式化为描述文本

**文件**:
- `F:\project_kuajing\src\configs\festival\prompts.ts` (line 267-353)
- `F:\project_kuajing\src\services\aliService.ts` (line 268-275)

---

#### 4. **修复模板字符串语法错误**

**问题**: prompts.ts中的三个反引号 ` ``` ` 导致语法错误

**原因**: 在模板字符串中使用三个反引号会被解析为模板字符串结束标记

**解决方案**:
- Line 315: 改为 `严格输出纯JSON格式（不要代码块标记）`
- Line 463: 改为 `严格输出纯JSON格式（不要代码块标记）`

**文件**: `F:\project_kuajing\src\configs\festival\prompts.ts`

---

#### 5. **排版溢出问题修复**

**问题**: 神棍话术太长导致卡片排版溢出，字看不全

**第一轮修改（过度精简）**:
- slogan: 20字 → 15字
- analysis_reason: 80字 → 50字
- keyword: 改为6-8字

**用户反馈**:
- keyword必须是2-4字（2字如"暴富"，4字成语如"财运亨通"）
- 提示词方案原先挺好，只是排版局促
- 要求回滚并微调

**最终方案**:
- keyword: **2-4字**（优先4字成语，适合对联和卡片）
- slogan: **18-20字**（提3-4个特征）
- analysis_reason: **60-70字**（用相术术语）
- todo/not_todo: **各3项，每项6-10字**

**Canvas布局调整**:
| 部分 | 字体大小 | Y坐标 | 说明 |
|-----|---------|-------|------|
| slogan | 50px | y=590 | 行高72px |
| analysis_reason | 38px | y=760 | 行高56px |
| 宜忌 | 40px | y=1040/1110 | 向下移动 |
| 幸运元素 | 38px | y=1280/1350/1420 | 协调 |
| 性格标签 | 38px | y=1565 | 协调 |

**文件**:
- `F:\project_kuajing\src\configs\festival\prompts.ts`
- `F:\project_kuajing\src\utils\fortuneCardCanvas.ts`

---

#### 6. **幸运物一致性规则** 🎯

**问题**: 幸运色/幸运数/幸运物来来回回都是一样的几个东西

**需求**:
- 同一个人多次算命 → 同样的幸运元素（一致性）
- 不同人 → 不同的幸运元素（差异性）

**解决方案**: 添加确定性映射规则

**五行→幸运色映射**:
```
火命（红衣） → 中国红
金命（白衣） → 琉璃白
水命（黑衣） → 墨玉黑
木命（绿衣） → 翡翠绿
土命（黄衣） → 琥珀黄
```

**配饰+性别→幸运数映射**:
```
金饰（戒指/项链） → 8
银饰（耳环/手链） → 6
玉饰 → 9
眼镜（金属框） → 5
无配饰 → 3
```

**性别+五行+配饰→幸运物映射**:
```
男性：
- 金饰+火命 → 金手链
- 金饰+金命 → 金戒指
- 银饰+水命 → 银手串
- 无配饰+木命 → 玉佩

女性：
- 金饰+火命 → 金耳环
- 金饰+金命 → 金项链
- 银饰+水命 → 银手镯
- 无配饰+木命 → 玉镯
```

**核心原则**: 同样特征组合 → 同样幸运元素（保证一致性）

**文件**: `F:\project_kuajing\src\configs\festival\prompts.ts` (第11步)

---

#### 7. **痣的准确性问题修复** ⚠️

**问题**:
- Qwen-VL可能瞎编痣的位置
- 用户自己都没看清，不知道AI怎么看出来的
- 算命原则：宁可说好听的，不能说错的

**解决方案**:

**修改 `qwen_face_analysis` prompt**:
- 标记痣/胎记/印记：⚠️ 看不清就写"看不清"，不要猜测！
- 【重要】部分强调：看不清的特征必须写"看不清"或"无"，绝对不要猜测或编造
- 只描述明显可见的特征，模糊的宁可不说

**修改 `cyber_fortune` prompt**:
- 添加【🎯 算命铁律】：
  1. ⚠️ 宁可不说，不能说错
  2. ⚠️ 看不清的不要提：如果痣显示"看不清"或"无"，就完全不要提
  3. ⚠️ 说好话不说坏话：算命是给人希望的
  4. ⚠️ 有根有据：基于实际特征，不凭空编造

- 第3步【痣相解读】添加关键规则：
  - 只有当痣的位置明确时才使用
  - 如果没有痣，重点用其他明显特征（天庭、眉毛、眼睛、鼻子等）

**文件**: `F:\project_kuajing\src\configs\festival\prompts.ts`

---

### 🚧 未完成的工作

#### 1. **功能测试**
- [ ] 测试赛博算命功能，验证痣的准确性
- [ ] 测试同一个人多次算命，验证幸运物一致性
- [ ] 测试不同人，验证幸运物差异性
- [ ] 测试排版，确保18-20字slogan和60-70字analysis_reason不溢出

#### 2. **边界情况处理**
- [ ] 测试没有明显痣的用户
- [ ] 测试无配饰的用户
- [ ] 测试模糊照片的处理

---

### 📋 接下来要做的

#### 短期（明天）
1. 测试赛博算命功能的准确性和一致性
2. 收集用户反馈，调整话术
3. 验证幸运物映射规则是否合理

#### 中期（本周）
1. 优化其他算命功能（M7运势抽卡等）
2. 完善prompt，提高趣味性
3. 添加更多玄学术语和网络梗

#### 长期
1. 考虑添加更多算命维度（八字、星座等）
2. 增加社交分享功能
3. 优化卡片设计

---

### 📦 被修改/注释掉的原有代码备份

#### 原始prompt（过度精简前的版本）

**slogan要求**（被临时改为15字，后回滚到18-20字）:
```
原版：20字内，必须有梗
临时版：15字内，精炼有梗
最终版：18-20字，必须提3-4个特征
```

**analysis_reason要求**（被临时改为50字，后回滚到60-70字）:
```
原版：80字以内
临时版：50字以内
最终版：60-70字
```

**keyword要求**（被临时改为6-8字，后回滚到2-4字）:
```
原版：2-4字关键词
临时版：6-8字，朗朗上口
最终版：2-4字（优先4字成语）
```

#### Canvas字体大小调整历史

| 部分 | 原始 | 临时版 | 最终版 |
|-----|------|--------|--------|
| slogan | 54px | 48px | 50px |
| analysis_reason | 40px | 36px | 38px |
| 宜忌 | 44px | 40px | 40px |
| 幸运元素 | 44px | 38px | 38px |

---

### 💡 经验教训

1. **用户需求理解**：
   - 要认真理解用户的反馈
   - "排版局促"不等于"内容太多"
   - 应该微调布局而不是大幅删减内容

2. **算命功能的特殊性**：
   - 算命要有神棍的样子，说好听的不说错的
   - 看不清的特征宁可不说，不能瞎编
   - 用户要的是有趣、准确、正能量

3. **一致性问题**：
   - 需要建立确定性规则，避免随机性
   - 同一个人多次使用应该得到一致的结果
   - 可以通过特征组合映射来实现

4. **文档重要性**：
   - 及时记录修改过程
   - 保留被改掉的代码
   - 方便后续回溯和参考

---

### 🔧 相关文件清单

**修改的文件**:
1. `F:\project_kuajing\src\configs\festival\prompts.ts` - 主要修改
   - qwen_face_analysis prompt (line 267-353)
   - cyber_fortune prompt (line 355-479)

2. `F:\project_kuajing\src\services\aliService.ts` - JSON解析优化
   - Line 268-275: 添加中文字段JSON识别

3. `F:\project_kuajing\src\utils\fortuneCardCanvas.ts` - 布局调整
   - Interface注释更新 (line 7-16)
   - Canvas字体和坐标调整 (line 91-146)

**未修改的关键文件**:
- `F:\project_kuajing\src\pages\Festival\FortuneCardPage.tsx` - 主页面逻辑
- `F:\project_kuajing\src\services\MissionExecutor.ts` - 任务执行器

---

## 其他UI问题排查

### 图片遮挡问题

**检查项**:
- `opacity` 属性
- `background` 的透明度
- 渐变遮罩层 `linear-gradient`
- `backdrop-filter: blur()` 效果
- 覆盖在图片上的元素

**解决方法**:
1. 搜索所有可能影响透明度的属性
2. 一次性全部检查并修改
3. 不要一个个试

### 文字看不清问题

**常见原因**:
1. 颜色对比度不够（白字白底、浅灰字浅色背景）
2. CSS被覆盖（最常见）
3. 文字有透明度
4. 背景模糊影响文字渲染
5. 字体渲染问题（antialiasing）

**检查顺序**:
1. Grep搜索所有相关选择器
2. 检查颜色值（是否是白色/透明）
3. 检查背景（是否有blur）
4. 一次性修改所有问题

---

## 总结

### 一句话总结
> 改CSS前先全面检查，一次性改完所有地方，不要试错，第一次没效果立即检查覆盖。

### 记住
- 用户的时间和金钱很宝贵
- 不要让用户反复催促
- 主动、快速、一次性解决问题
- CSS覆盖问题1秒钟就能用Grep检查出来

---

**此规范必须严格遵守，违反将导致严重的时间和金钱损失。**
