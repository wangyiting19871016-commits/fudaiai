# 福袋AI - 技术文档

**最后更新**: 2026-02-01
**适用版本**: v1.0

---

## 目录

1. [技术栈](#技术栈)
2. [核心功能实现](#核心功能实现)
3. [API接口](#api接口)
4. [测试指南](#测试指南)
5. [常见问题](#常见问题)

---

## 技术栈

### 前端
- **框架**: React 18 + TypeScript
- **路由**: React Router v6
- **状态管理**: LocalStorage + SessionStorage
- **UI组件**: Ant Design
- **样式**: CSS Modules + 响应式设计
- **构建工具**: Vite

### 后端
- **运行时**: Node.js
- **服务器**: Express
- **视频处理**: FFmpeg
- **存储**: 腾讯云COS

### AI能力
- **图片生成**: LiblibAI (ComfyUI工作流)
- **文字生成**: DeepSeek
- **语音合成**: Fish Audio TTS

---

## 核心功能实现

### 1. 运势抽卡系统（M7）

**技术特点**:
- 加权随机算法
- Canvas文字渲染
- 稀有度系统

**关键文件**:
- `src/configs/festival/fortuneConfig.ts` - 运势配置
- `src/services/FortuneService.ts` - 抽卡逻辑
- `src/services/FortuneCardGenerator.ts` - 卡片生成
- `src/services/CanvasTextService.ts` - 文字渲染

**运势类型**:
| 类型 | 权重 | 稀有度 | 主题色 |
|------|------|--------|--------|
| 财源滚滚 | 25% | 普通 | 金色 |
| 桃花运 | 20% | 普通 | 粉色 |
| 事业高升 | 25% | 普通 | 蓝色 |
| 身体健康 | 15% | 稀有 | 绿色 |
| 欧气满满 | 10% | 史诗 | 紫色 |
| 一发入魂 | 5% | 传说 | 彩虹 |

**生成流程**:
```
1. 用户点击"抽取运势"
   ↓
2. FortuneService.drawFortune() - 加权随机选择
   ↓
3. FortuneCardGenerator.generate() - Canvas绘制卡片
   ↓
4. 上传到COS获取URL
   ↓
5. 返回结果给用户
```

**Canvas渲染配置**:
```javascript
{
  width: 800,
  height: 1200,
  fontSize: 72,
  fontFamily: 'SourceHanSansSC-Heavy',
  gradient: ['#FFD700', '#FFA500'],  // 金色渐变
  stroke: {
    color: 'white',
    width: 4
  }
}
```

---

### 2. 老照片修复对比图

**技术特点**:
- 自动合成修复前后对比图
- Canvas拼接 + 文字标签
- 腾讯云COS上传

**关键文件**:
- `src/services/PhotoComparisonService.ts` - 对比图合成

**对比图布局**:
```
┌────────────────────────────┐
│  修复前   │    修复后      │
│  (800px)  │    (800px)    │
│           │   金色分割线   │
│  原图     │    修复后图    │
│           │               │
└────────────────────────────┘
总尺寸: 1600x800px
```

**生成流程**:
```
1. 用户上传老照片
   ↓
2. LiblibAI修复API处理
   ↓
3. PhotoComparisonService.createComparison()
   - 加载原图和修复图
   - Canvas绘制对比图
   - 添加文字标签和分割线
   ↓
4. 上传到COS
   ↓
5. 返回对比图URL
```

---

### 3. 财神变身（M2）

**技术特点**:
- LiblibAI P4Lab工作流
- 多工作流Fallback机制
- 人脸检测 + 换脸合成

**关键文件**:
- `src/configs/festival/liblibWorkflows.ts` - 工作流配置
- `src/services/MissionExecutor.ts` (950-995行) - 执行引擎

**工作流优先级**:
```
Priority 0 → original-p4lab-v1 (稳定，优先使用)
Priority 1 → instantid-v2 (快速备选)
Priority 2 → caishen-faceswap-v1 (兜底方案)
```

**节点映射**:
- Node 40 → 用户照片
- Node 49 → 模板图

**蒙版配置**:
```javascript
{
  face: true,    // 保留人脸
  hair: false,   // 不保留发型
  body: false    // 不保留身体
}
```

---

### 4. 主页UI重构

**设计理念**:
- **春节氛围**: 红金配色 (#C41E3A + #FFD700)
- **AI科技感**: 玻璃态效果 (backdrop-filter)
- **去除低级动画**: 删除飘落红包、闪烁等

**关键文件**:
- `src/pages/Festival/HomePageRedesign.tsx`
- `src/styles/festival-home-redesign.css`

**布局结构**:
```
┌─────────────────────────┐
│ Hero区 - 精选案例轮播    │
│ (5秒自动切换)            │
├─────────────────────────┤
│ 分类模块1 - 新年形象     │
│ [M1] [M2]               │
├─────────────────────────┤
│ 分类模块2 - 家庭时刻     │
│ [M3] [M6] [M11]         │
├─────────────────────────┤
│ 分类模块3 - 新年祝福     │
│ [文案] [语音] [春联]     │
├─────────────────────────┤
│ 分类模块4 - 运势玩法     │
│ [M7] [M8] [M10]         │
├─────────────────────────┤
│ 社交证明 + VIP礼包      │
└─────────────────────────┘
```

---

## API接口

### 后端API

#### 1. 视频合成
```
POST /api/video/compose

Request:
{
  inputUrl: string,        // 图片URL
  type: 'image' | 'video',
  subtitle?: string,       // 字幕文字
  duration?: number        // 视频时长（秒）
}

Response:
{
  success: boolean,
  videoUrl: string,        // 生成的视频URL
  duration: number
}
```

**FFmpeg配置**:
- 视频编码: H.264
- 分辨率: 保持原图比例
- 帧率: 25fps
- 字幕效果:
  - 字号: 80px
  - 位置: 距底部120px
  - 颜色: 白色 + 黑色描边4px
  - 背景: 半透明黑色框

#### 2. 健康检查
```
GET /api/health

Response:
{
  status: 'ok',
  timestamp: number
}
```

#### 3. FFmpeg检查
```
GET /api/ffmpeg-check

Response:
{
  installed: boolean,
  version: string
}
```

### LiblibAI API

#### 工作流执行
```
POST https://www.liblib.art/api/open/v0/workflow-run

Headers:
{
  Authorization: Bearer {API_KEY}
}

Body:
{
  workflowUuid: string,
  inputNodes: {
    [nodeId]: {
      imageUrl?: string,
      text?: string,
      ...
    }
  }
}

Response:
{
  taskUuid: string
}
```

#### 任务查询
```
GET https://www.liblib.art/api/open/v0/task/{taskUuid}

Response:
{
  status: 'pending' | 'running' | 'success' | 'failed',
  result?: {
    imageUrls: string[]
  }
}
```

---

## 测试指南

### 本地测试

#### 启动服务
```bash
# 终端1 - 前端
cd F:\project_kuajing
npm run dev
# 访问: http://localhost:5174

# 终端2 - 后端
node server.js
# 监听: http://localhost:3002
```

#### 移动端测试
```
# 确保手机和电脑在同一WiFi
访问: http://192.168.2.2:5174
```

### 功能测试清单

#### M7 运势抽卡
- [ ] 点击"抽取运势"按钮
- [ ] 检查运势卡是否正确生成
- [ ] 验证文字渲染效果
- [ ] 检查字体是否加载成功
- [ ] 测试稀有度分布（多次抽取）

#### M6 老照片修复
- [ ] 上传老照片
- [ ] 检查修复是否成功
- [ ] 验证对比图生成
- [ ] 检查对比图布局（左右分割）
- [ ] 测试下载功能

#### M2 财神变身
- [ ] 上传人脸照片
- [ ] 选择性别
- [ ] 选择模板
- [ ] 检查生成效果
- [ ] 验证Fallback机制（故意触发失败）

#### 主页重构
- [ ] 检查Hero区轮播
- [ ] 验证分类模块展示
- [ ] 测试移动端响应式
- [ ] 检查导航跳转

### 性能测试

#### 生成速度
- M1/M2: < 5秒
- M3: < 8秒
- M6: < 10秒
- M7: < 100ms
- 文字生成: < 3秒
- 语音生成: < 4秒

#### 资源加载
- 首屏加载: < 3秒
- 字体加载: < 2秒
- 图片懒加载: 正常

---

## 常见问题

### Q1: 运势卡文字渲染失败
**原因**: 字体文件未加载
**解决**:
```javascript
// 检查字体路径
const fontPath = './public/fonts/SourceHanSansSC-Heavy.otf';

// 预加载字体
const font = new FontFace('SourceHanSansSC', `url(${fontPath})`);
await font.load();
document.fonts.add(font);
```

### Q2: 对比图上传失败
**原因**: COS配置错误或权限不足
**解决**:
1. 检查 `.env` 中的COS配置
2. 验证Bucket权限设置
3. 检查SecretId和SecretKey是否正确

### Q3: M2生成失败
**原因**: 工作流UUID错误或API配额用尽
**解决**:
1. 检查Console日志，查看具体错误
2. 验证工作流UUID是否正确
3. 检查LiblibAI账户余额
4. 触发Fallback机制，尝试备用工作流

### Q4: 移动端样式不生效
**原因**: CSS覆盖问题（见开发规范.md）
**解决**:
1. 使用Grep搜索所有相关选择器
2. 检查媒体查询优先级
3. 一次性修改所有覆盖位置

### Q5: FFmpeg视频生成失败
**原因**: FFmpeg未安装或字体文件缺失
**解决**:
```bash
# 检查FFmpeg
ffmpeg -version

# 检查字体文件
ls -la C:/Windows/Fonts/ | grep "simhei"

# 安装FFmpeg (Windows)
# 从 https://ffmpeg.org/download.html 下载
# 添加到系统PATH
```

---

## 关键配置

### 环境变量 (.env)
```env
# LiblibAI
VITE_LIBLIB_API_KEY=your_api_key

# 腾讯云COS
VITE_COS_SECRET_ID=your_secret_id
VITE_COS_SECRET_KEY=your_secret_key
VITE_COS_BUCKET=your_bucket
VITE_COS_REGION=ap-shanghai

# DeepSeek
VITE_DEEPSEEK_API_KEY=your_api_key

# Fish Audio
VITE_FISH_AUDIO_API_KEY=your_api_key
```

### Vite配置
```typescript
// vite.config.ts
{
  server: {
    port: 5174,
    host: '0.0.0.0',  // 允许局域网访问
    proxy: {
      '/api': {
        target: 'http://localhost:3002',
        changeOrigin: true
      }
    }
  }
}
```

---

## 部署说明

### 前端部署
```bash
# 构建生产版本
npm run build

# 生成的文件在 dist/ 目录
# 部署到静态服务器（Nginx/Vercel/Netlify）
```

### 后端部署
```bash
# 使用PM2管理进程
pm2 start server.js --name "福袋AI-后端"

# 查看日志
pm2 logs

# 重启服务
pm2 restart "福袋AI-后端"
```

---

**文档维护**: 此文档应在技术实现变更后及时更新
**最后更新**: 2026-02-01
