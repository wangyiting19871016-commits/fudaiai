# 🎨 素材融合技术方案

## 问题1：如何将背景、装饰、对联与人像融合？

### 技术实现方案

**方案A：Fabric.js Canvas合成（当前实现）** ✅

```
人物底图（PNG透明背景）
    ↓
添加背景层（可替换）
    ↓
添加装饰层（印章、烫金、艺术字）
    ↓
添加对联层（PNG透明图片）
    ↓
添加文字层（自定义文字）
    ↓
导出为最终图片（PNG/JPG）
```

**技术栈**：
- **Fabric.js**：Canvas图层管理
- **React**：UI交互
- **HTML5 Canvas**：图片合成引擎

**已实现功能**：
- ✅ 图层管理（添加、删除、拖拽、缩放、旋转）
- ✅ 撤销/重做（最多20步）
- ✅ 背景替换
- ✅ 装饰元素添加（137个素材）
- ✅ 文字添加
- ✅ 导出PNG（2倍分辨率）

---

## 问题2：对联能否融合进图片里？

### ✅ 可以！技术实现：

#### 方案一：PNG透明对联图片（推荐）

**原理**：
1. 对联制作成PNG透明背景图片
2. 用户在编辑器中选择对联
3. Canvas自动叠加到人物图片上
4. 用户可以调整位置、大小、旋转角度

**示例**：
```
对联PNG文件结构：
/assets/editor/couplets/
  ├── fortune_001.png （招财进宝对联，透明背景）
  ├── family_001.png  （阖家欢乐对联，透明背景）
  └── career_001.png  （事业高升对联，透明背景）
```

**配置示例**：
```typescript
{
  id: 'couplet_fortune_001',
  name: '招财进宝',
  type: 'couplet',
  imagePath: '/assets/editor/couplets/fortune_001.png',
  category: 'fortune',
  tags: ['招财', '财运']
}
```

#### 方案二：动态生成对联文字（备用）

**原理**：
1. 用户输入对联文字
2. Canvas实时渲染书法字体
3. 可以调整字体、颜色、大小

**已支持的文字样式**：
- 书法字体（需配置字体文件）
- 描边效果
- 阴影效果
- 渐变填充

---

## 需要什么样的人物素材？

### ✅ 最佳格式：PNG透明背景人物照

#### 推荐规格：
- **分辨率**：2048x2048 或 1024x1536（竖版）
- **格式**：PNG（透明背景）
- **内容**：全身或半身人物，穿着传统服饰
- **背景**：完全透明（无白底）
- **边缘**：抠图精细，无杂边

#### 人物类型：

**男性模板（需20-30张）**：
- 财神造型（金色服饰，手持元宝）
- 唐装造型（红色、金色）
- 汉服造型（长袍马褂）
- 现代国潮（国潮服饰+传统元素）

**女性模板（需20-30张）**：
- 财神女神（华丽服饰，喜庆造型）
- 汉服/唐装（华丽古装）
- 中式婚纱（马面裙、秀禾服）
- 现代国潮（旗袍+现代元素）

**儿童模板（需15-20张）**：
- 传统服饰（唐装、汉服）
- 生肖造型（龙年、蛇年等）
- 拜年造型（手持红包、福字）

---

## 如果素材不是透明背景怎么办？

### 方案：自动抠图

**技术栈**：
- **Rembg API**：自动去除背景
- **或 Remove.bg API**：商用级抠图
- **或本地模型**：U2Net抠图模型

**流程**：
```
用户上传人物照（有背景）
    ↓
调用抠图API（自动去除背景）
    ↓
返回PNG透明背景图
    ↓
保存到模板库
```

---

## 当前素材库现状

### ✅ 已有素材（可用）：
- **137个装饰元素**：印章、烫金、艺术字、书法
- **34个背景**：喜庆背景
- **字体文件**：多款书法字体

### ❌ 缺失素材（急需）：
- **0个成人男性换脸模板**
- **0个成人女性换脸模板**
- **0个儿童换脸模板**
- **0个对联PNG图片**

---

## 素材融合工作流程

### 用户使用流程：

1. **上传人脸照片** → M2换脸生成
2. **得到换脸结果**（人物穿着财神服饰）
3. **点击"编辑装饰"按钮** → 打开图片编辑器
4. **编辑器功能**：
   - 替换背景（34个背景）
   - 添加对联（左右对联+横批）
   - 添加装饰（印章、烫金、艺术字、书法）
   - 添加文字（祝福语、姓名等）
5. **保存/导出**（PNG高清图）

---

## 技术实现细节

### Canvas图层结构：

```
[最顶层] 文字层 5       ← 用户自定义文字
         ──────────────
         装饰层 4       ← 印章、烫金、艺术字
         ──────────────
         对联层 3       ← 左右对联+横批
         ──────────────
         人物层 2       ← 换脸后的人物（PNG透明）
         ──────────────
[最底层] 背景层 1       ← 可替换的背景图
```

### 代码示例（已实现）：

```typescript
// 1. 加载人物底图
fabric.Image.fromURL(personImageUrl, (img) => {
  img.set({ selectable: false }); // 人物不可删除
  canvas.add(img);
  canvas.sendToBack(img);
});

// 2. 添加背景
fabric.Image.fromURL(backgroundUrl, (img) => {
  canvas.add(img);
  canvas.sendToBack(img); // 背景在最下层
});

// 3. 添加对联
fabric.Image.fromURL(coupletUrl, (img) => {
  img.set({
    left: 50,
    top: 100,
    scaleX: 0.5,
    scaleY: 0.5
  });
  canvas.add(img);
});

// 4. 导出最终图片
const dataURL = canvas.toDataURL({
  format: 'png',
  multiplier: 2  // 2倍分辨率
});
```

---

## 下一步行动

### 急需完成：

1. **购买/生成人物PNG素材**   - 男性20张（财神、唐装、汉服）
   - 女性20张（财神、汉服、婚纱）
   - 儿童15张（传统服饰）

2. **制作对联PNG图片**   - 可以委托设计师制作
   - 或使用PS批量生成
   - 或使用AI生成（MidJourney + 抠图）

3. **集成编辑器到ResultPage**   - 添加"编辑装饰"按钮
   - 点击打开ImageComposerEditor
   - 保存后更新结果图

---

## 技术优势

✅ **实时预览**：用户拖拽即可看到效果
✅ **无损编辑**：撤销/重做，随时调整
✅ **高清导出**：支持2倍分辨率导出
✅ **素材丰富**：137个装饰+34个背景+无限对联
✅ **移动友好**：支持触摸拖拽、缩放、旋转

---

## 常见问题

**Q：对联文字能否动态修改？**
A：可以。方案1：用户输入文字，Canvas动态渲染。方案2：预制PNG对联图片供选择。

**Q：人物图必须是透明背景吗？**
A：最佳是透明背景。如果有背景，可以调用抠图API自动去除。

**Q：能否导出视频？**
A：当前导出PNG图片。如果需要视频，可以结合Kling视频生成或数字人功能。

**Q：素材能否用户自己上传？**
A：可以。后续可以添加"用户自定义素材"功能，上传自己的装饰/背景。
