# 福袋AI·马年大吉 - 项目总览

**最后更新**: 2026-02-02
**项目路径**: F:\project_kuajing
**产品定位**: 春节主题AI生成工具集合（移动端H5优先）

---

## 📊 项目状态

### 当前进度
```
总体进度: ██████████████████░░ 90%

✅ 已完成并上线:     75%
🔄 已完成待测试:     15%
⏳ 开发中:            5%
📋 待开始:            5%
```

### 运行环境

| 服务 | 端口 | 状态 | 访问方式 |
|------|------|------|----------|
| Vite前端 | 5174 | ✅ 运行中 | http://192.168.2.2:5174 |
| Node后端 | 3002 | ✅ 运行中 | http://localhost:3002 |

**快速启动**:
```bash
# 前端
cd F:\project_kuajing
npm run dev

# 后端（另一个终端）
node server.js
```

### 最近构建状态
```
✅ 2026-02-02 最新构建成功 (812ms)
   - fortuneCardCanvas.ts (字体2倍优化)
   - SmartReplyPage.tsx (loading状态)
   - smartReplyLibrary.ts (150+模板)
   - BottomNav.tsx (新组件)
   - HomePageGlass.tsx (删除VIP)
   - CategoryPage.tsx (删除VIP)
```

---

## ✅ 已完成功能

### 核心功能（14个已完成）

| 分类 | 功能 | 状态 | 收费模式 |
|------|------|------|---------|
| **🎭 新年形象** | M1 新年3D头像 | ✅ 已上线 | VIP+单次 |
| | M2 财神变身 | ✅ 已上线 | VIP+单次 |
| **👨‍👩‍👧 家庭相册** | M3 情侣合照 | ✅ 已上线 | VIP+单次 |
| | M6 老照片修复 | ✅ 已上线 | VIP+8.8元 |
| | M11 隐形文字画 | ✅ 已上线 | 免费 |
| **💬 拜年祝福** | text-blessing 拜年文案 | ✅ 已上线 | 无限免费 |
| | M5 语音贺卡 | ✅ 已上线 | 每天10次 |
| | M9 AI春联 | ✅ 已上线 | 无限免费 |
| **🔮 运势玩法** | M7 运势抽卡 | ✅ 新增 | 每天3次免费 |
| | M8 AI运势占卜 | ✅ 已上线 | 每天3次 |
| | M10 高情商回复 | ✅ 已上线 | 每天10次 |
| **🎨 海报生成** | 填空式海报系统 | ✅ 新增 | 付费去水印 |

**注**: M4全家福已禁用

### 最新完成（2月2日）

#### 1. M8 赛博算命 - 体验全面优化
- **字体可读性提升** - 所有字体2倍放大（28px→56px, 72px→144px等）
- **Canvas升级** - 1080×1440高清画布（原768×1024）
- **按钮层级优化** - 主操作（金色渐变春联按钮）> 次要操作（保存）> 辅助操作（重试）
- **春联联动** - 点击关键词可直接生成春联海报
- **实时扫描** - 摄像头实时面相分析（已实现，待HTTPS环境测试）
- **QWEN人物检测** - 8条幽默提示（如"阿猫阿狗无法占卜"）
- **状态**: ✅ 已上线，字体加倍后可读性大幅提升

#### 2. M10 高情商回复 - 反同质化系统
- **模板库扩充** - 从25条扩展到150+条真实2025-2026网络热梗
- **来源**：台湾小钟梗、李雪琴段子、知乎神回复、脱口秀段子
- **5大场景**：催婚（30条）、催生（30条）、问工资（30条）、问对象（30条）、比孩子（30条）
- **10种创意技巧** - 每次随机选择（谐音梗/双关语/反转/自嘲/夸张等）
- **加载反馈** - "换一批"按钮增加loading状态（解决用户多次点击问题）
- **状态**: ✅ 已上线，模板丰富度提升6倍

#### 3. UI清理与导航优化
- **删除会员价格板块** - HomePageGlass和CategoryPage移除VIP Banner
- **用户反馈**："不想让人家一看都是钱的元素"
- **底部导航栏** - 新增BottomNav组件（4个Tab）
  - 🏠 首页 - /festival/home
  - 💼 我的作品 - /festival/library
  - 👑 会员中心 - /festival/vip
  - 💬 联系客服 - /festival/contact
- **集成页面** - HomePageGlass, CategoryPage, FortuneCardPage, SmartReplyPage
- **状态**: ✅ 已上线

#### 4. 生成结果页与素材库 - 重大功能改进（2月2日下午）

**背景**: 用户反馈发现5个关键问题：
1. 下载按钮替换成保存后丢失下载功能
2. 素材库缺少视频支持和文字预览
3. 底部导航链接错误
4. 保存逻辑应该手动而非自动
5. H5移动端下载必须引导长按保存到相册

**实施方案**:

##### 4.1 生成结果页 (ResultPage.tsx)
- **4按钮布局** - 2x2网格适配移动端，替代长条按钮
  - ⬇️ 下载 - 打开引导弹窗，指导用户长按保存
  - 💾 保存 - 手动保存到素材库（不再自动保存）
  - 📤 分享 - 添加水印后分享
  - 🔄 重生成 - 返回编辑页
- **H5下载方案** - 弹窗显示图片 + 金色提示框引导长按
  - 不使用 `<a download>` (H5不支持)
  - CSS启用长按: `userSelect: 'auto'`, `WebkitTouchCallout: 'default'`
- **手动保存** - 移除 useEffect 自动保存，仅在用户点击时保存
- **状态反馈** - 保存后按钮显示 "✅ 已保存"

##### 4.2 高情商回复结果页 (SmartReplyPage.tsx)
- **玻璃态风格重构** - 统一整体设计系统
  - 背景: `var(--cny-bg-cream)` + 径向渐变装饰
  - 卡片: `backdrop-filter: blur(10px)` 玻璃态效果
- **4按钮 + 更多玩法** - 主功能突出，次要功能收起
  - 主按钮: 📋 复制文字、🎙️ 配语音、🔄 换一个、🎨 更多玩法
  - 更多玩法面板: 💾 保存到作品、⬇️ 下载图片、🎬 生成视频
- **复制文字功能** - 点击直接复制到剪贴板（适配移动端）
- **语音导航修复** - 路由改为 `/festival/voice` (见4.6节)

##### 4.3 素材库 (MaterialLibraryPage.tsx)
- **视频类型支持** - 新增视频Tab，显示视频封面
- **文字素材预览** - 显示前4行文字（`-webkit-line-clamp: 4`）
- **三个点菜单** - 每个素材右上角 "⋮" 按钮
  - ⬇️ 下载 - 打开引导弹窗
  - 🗑️ 删除 - 从素材库移除
- **清空全部功能** - 顶部操作栏新增清空按钮
- **下载引导** - 同样使用长按保存方案
- **CSS长按启用** - 预览图添加 `stopPropagation()` + CSS属性

##### 4.4 继续创作面板 (ContinueCreationPanel.tsx)
- **生成视频快捷操作** - 图片素材可一键跳转视频生成
- **语音导航修复** - 路由改为 `/festival/voice`

##### 4.5 底部导航修复 (BottomNav.tsx)
- **路径更正** - "我的作品" 从 `/festival/library` 改为 `/festival/materials`

##### 4.6 语音生成导航修复（关键Bug）
**问题**: 所有生成页面的"生成语音"按钮点击后显示空白页
**原因**: 路由错误，使用了不存在的路径
**修复文件**:
- ResultPage.tsx: `/festival/voice/${taskId}` → `/festival/voice`
- ContinueCreationPanel.tsx: `/festival/text/M5` → `/festival/voice`
- VideoPage.tsx: `/festival/voice/${taskId || ''}` → `/festival/voice`

**正确路由**: `/festival/voice` (不带taskId，通过state传递数据)

##### 4.7 模板选择页样式修复 (festival-template-selection.css)
- **继续按钮宽度** - 居中显示，最大宽度320px
- **按钮内边距** - 14px 32px（移动端友好）

#### 🚨 **关键经验: 风格一致性原则**

**用户核心反馈**:
> "这种小问题不要一个个让我指出来，你做的时候必须保持风格统一好嘛，沟通成本很高TOKEN成本也很高"

**问题案例**:
1. **返回按钮不统一** - MaterialLibraryPage 返回按钮变成圆形，其他页面是圆角矩形
2. **Emoji与按钮重叠** - "💼 我的作品" 标题emoji与返回按钮位置冲突
3. **下载方案理解错误** - H5移动端必须长按保存到相册，不能下载到文件夹

**统一规范**:

| 组件 | 规范 | 示例代码 |
|------|------|----------|
| 返回按钮 | 圆角矩形 + 箭头SVG + "返回"文字 | `borderRadius: '20px'`, `padding: '8px 16px'` |
| 主标题 | 无emoji，避免与按钮重叠 | "我的作品" 而非 "💼 我的作品" |
| 下载图片 | 引导长按保存到相册 | 弹窗 + 金色提示框 + `userSelect: 'auto'` |
| 4按钮布局 | 2x2网格，gap: 12px | `display: grid; grid-template-columns: repeat(2, 1fr)` |
| 玻璃态卡片 | 统一背景 + 模糊效果 | `rgba(255,255,255,0.7)` + `backdrop-filter: blur(10px)` |

**开发原则**:
1. **保持风格统一** - 新功能必须参考现有页面的设计风格，不能随意创造新样式
2. **H5移动端特性** - 下载、分享等操作必须考虑移动端限制
3. **一次性完成** - 同类组件（如返回按钮）应该在所有页面中统一处理，不要分批修改
4. **文档先行** - 修改前检查是否有统一的设计系统文档

**状态**: ✅ 已完成修复，已建立规范文档

#### 5. 拜年文案优化
- **字数限制** - 80-120字（原100-150字），提升可读性
- **状态**: ✅ 已上线

### 已完成（2月1日）

#### 5. 填空式海报系统（万金油方案）
- **模板驱动** - JSON配置，支持未来设计变更
- **3个预设模板**：经典春联、简约边框、全屏照片
- **Canvas渲染器** - 支持春联、装饰、文字、水印
- **React Hook** - `usePosterGenerator` 封装
- **集成水印系统** - Logo+QR可移除（付费）
- **无遮挡布局** - 15px安全间距
- **状态**: ✅ 核心系统已完成，待集成到UI

### 已完成（1月31日夜间）

#### 6. 运势抽卡功能（M7）
- 6种运势类型（财运、桃花、事业、健康、欧气、一发入魂）
- 加权随机算法 + 稀有度系统
- Canvas文字渲染
- **状态**: ✅ 已实装，待测试

#### 7. 老照片修复对比图
- 自动合成修复前后对比图（一张图）
- 左右布局 + 金色分割线
- **状态**: ✅ 已集成到M6

#### 8. 主页UI重构
- Hero区轮播（精选案例展示）
- 春节氛围（红金配色）+ AI科技感（玻璃态效果）
- 去除低级动画
- **状态**: ✅ 已完成

---

## 📋 待办事项

### 🔥 高优先级

1. **真机测试（2月2日新增功能）**
   - [ ] M8赛博算命 - 测试2倍字体在真机上的可读性
   - [ ] M8赛博算命 - 测试春联跳转流程（关键词传递）
   - [ ] M10高情商回复 - 测试150+模板的随机性和多样性
   - [ ] 底部导航栏 - 测试4个Tab页面跳转
   - [ ] 实时扫描 - 在HTTPS环境测试摄像头调用

2. **填空式海报系统集成**
   - [ ] 集成到M1/M2/M7等功能页面
   - [ ] 添加海报模板选择UI
   - [ ] 测试生成和下载流程
   - [ ] 添加真实示例图

3. **补充真实素材**
   - [ ] 赛博算命2倍字体卡片效果图
   - [ ] 高情商回复三种风格示例
   - [ ] 运势卡生成效果图
   - [ ] 老照片对比图示例
   - [ ] 3D头像示例
   - [ ] 海报生成示例

4. **Bug修复**
   - [ ] 主页素材路径配置
   - [ ] 字体文件加载测试（1080×1440大画布可能更耗内存）
   - [ ] 对比图上传COS验证

### ⚡ 中优先级

4. **性能优化**
   - [ ] 字体预加载
   - [ ] 图片懒加载
   - [ ] 首屏加载优化

5. **支付流程开发**
   - [ ] VIP会员购买
   - [ ] 单次付费（老照片8.8元）

### 📝 低优先级

6. **功能完善**
   - [ ] 运势卡分享功能
   - [ ] 我的作品页面
   - [ ] 使用帮助页面

---

## 🚨 已知问题

### P1 - 待验证
1. **字体加载** - 字体文件18MB+，可能影响首屏加载
2. **Canvas渲染** - 1080×1440大画布可能消耗更多内存，需测试浏览器兼容性
3. **素材路径** - 主页素材路径需要配置正确
4. **实时扫描** - 摄像头功能需要HTTPS环境，本地HTTP测试可能失败
5. **高情商回复随机性** - 需真机测试150+模板是否有效减少同质化

### P2 - 次要问题
1. **旧模板文件403** - 部分腾讯云COS文件权限未设置（影响低）

---

## 📁 关键文件

### 核心业务代码
```
src/
├── configs/festival/
│   ├── liblibWorkflows.ts          # AI工作流配置
│   ├── fortuneConfig.ts            # 运势配置
│   ├── posterTemplates.ts          # 海报模板配置
│   ├── smartReplyLibrary.ts        # ⭐ 150+高情商回复模板库（2月2日扩充）
│   ├── prompts.ts                  # ⭐ QWEN提示词（含人物检测）
│   └── categories.ts               # 分类配置
├── services/
│   ├── MissionExecutor.ts          # 核心执行引擎
│   ├── FortuneService.ts           # 运势抽卡逻辑
│   ├── PhotoComparisonService.ts   # 对比图合成
│   └── apiService.ts               # API调用
├── utils/
│   ├── posterCanvas.ts             # 海报Canvas渲染器
│   ├── fortuneCardCanvas.ts        # ⭐ 命理卡片渲染（1080×1440，字体2倍）
│   ├── smartReplyCanvas.ts         # 高情商回复卡片渲染
│   ├── addWatermark.ts             # 水印系统
│   └── coupletCanvas.ts            # 春联绘制
├── hooks/
│   └── usePosterGenerator.ts       # 海报生成Hook
├── components/
│   ├── PosterGeneratorExample.tsx  # 海报生成示例
│   └── BottomNav.tsx               # ⭐ 底部导航栏（4 Tabs）
├── pages/Festival/
│   ├── HomePageGlass.tsx           # ⭐ 主页（已删除VIP Banner）
│   ├── CategoryPage.tsx            # ⭐ 分类页（已删除VIP Banner）
│   ├── FortuneCardPage.tsx         # ⭐ 赛博算命（春联按钮+人物检测）
│   ├── SmartReplyPage.tsx          # ⭐ 高情商回复（加载状态+150模板）
│   ├── LabPage.tsx                 # 生成页面
│   └── ResultPage.tsx              # 结果展示
└── styles/
    ├── festival-home-glass.css     # 主页样式
    └── festival.css                # 全局春节主题
```

**⭐ = 2月2日新增/重大修改**

### 后端服务
```
server.js                           # Node后端主文件
├── /api/video/compose              # FFmpeg视频合成
└── /api/health                     # 健康检查
```

---

## 📣 用户反馈处理记录

### 2026-02-02 测试反馈处理

用户进行首次完整测试后提出的关键问题及解决方案：

| 问题 | 原因 | 解决方案 | 状态 |
|------|------|---------|------|
| **"字体太小看不清，不近视都要凑近看"** | Canvas字体尺寸过小 | 所有字体2倍放大（28px→56px, 72px→144px等），Canvas升级到1080×1440 | ✅ 已修复 |
| **"既然提到关键词能生成春联，应该有按钮"** | 缺少引导 | 添加金色渐变"生成春联海报"按钮作为主操作 | ✅ 已添加 |
| **"换一批没有反馈，会重复点击"** | 按钮无loading状态 | 添加disabled状态 + "🔄 生成中..."文字 + 透明度变化 | ✅ 已修复 |
| **"高情商回复同质化严重"** | 模板库太少（仅25条） | 扩充到150+真实网络热梗 + 10种创意技巧随机化 | ✅ 已优化 |
| **"不想让人家一看都是钱的元素"** | VIP Banner占用空间 | 从HomePageGlass和CategoryPage删除所有价格板块 | ✅ 已删除 |
| **"底部导航栏缺失"** | 组件未集成 | 创建BottomNav组件并集成到所有主页面 | ✅ 已添加 |
| **摄像头无法调用（用户反馈）** | HTTPS环境限制 | 功能已实现，需HTTPS环境测试 | ⏳ 待验证 |

**关键引用**:
- "这个字体大小加一倍我都觉得也就凑合能看" → 字体×2策略
- "我也不想让人家一看都是钱的元素" → 删除VIP Banner
- "现在模板太少还是太重复" → 150+模板库

---

## 📖 相关文档

- **产品功能清单.md** - 完整的产品功能说明
- **开发规范.md** - CSS规范、常见问题复盘
- **技术文档.md** - 技术实现细节、API文档
- **README.md** - 项目快速入门
- **填空式海报_开发指南.md** - 🆕 海报系统使用指南
- **填空式海报_实施完成报告.md** - 🆕 海报系统实施报告
- **填空式海报_设计师协作方案.md** - 设计师协作规范

---

## 🎯 差异化策略

### 与LiblibAI的区别

| 维度 | LiblibAI | 福袋AI |
|------|---------|--------|
| **定位** | 技术工具平台 | 春节营销解决方案 |
| **用户** | 技术玩家 | 普通用户 |
| **门槛** | 需要懂工作流 | 一键傻瓜操作 |
| **包装** | 功能导向 | 场景/情感导向 |
| **服务** | 单一生图 | 图+文+音完整方案 |

### 核心价值
1. **降低门槛** - 技术0门槛
2. **场景化包装** - 春节情感连接
3. **组合服务** - 提高客单价
4. **质量保证** - 精选工作流
5. **社交裂变** - 水印+分享

---

## 💡 快速开始下次对话

**标准开场白**:
> "我是福袋AI项目的用户。请先查看 `项目总览.md` 了解当前进度。我需要 [具体任务]。"

**检查服务状态**:
```bash
# 检查前端
curl http://localhost:5174

# 检查后端
curl http://localhost:3002/api/health
```

---

**最后更新**: 2026-02-02
**下次更新**: 完成真机测试后
**本次更新内容**: M8/M10体验优化、UI清理、底部导航、用户反馈处理
