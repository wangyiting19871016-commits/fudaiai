import React, { useState, useEffect, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { ArrowLeft, Mic, CheckCircle, Monitor, Activity, Zap, FileText, Headphones, Play, Square, Settings, BookOpen, Heart, Eye, Code } from 'lucide-react';
import ReferenceCard from '../components/ReferenceCard';
import VerifyPanel from '../components/VerifyPanel';
import ErrorBoundary from '../components/ErrorBoundary';
import FruitProgressMap from '../components/FruitProgressMap';
import { useMissionContext } from '../stores/MissionContext';

// è§£å†³æµè§ˆå™¨ç¯å¢ƒä¸‹å¯¹ NodeJS å‘½åç©ºé—´çš„è¯¯æŠ¥
declare global {
  namespace NodeJS {
    interface Timeout {}
  }
}

const LabPage = () => {
  const { stepId } = useParams();
  const navigate = useNavigate();
  const { state: missionState } = useMissionContext();

  // --- 2. P3 æ•°æ®è§£æé€»è¾‘ï¼šå¤šæ­¥æ¥ç®¡ ---
  
  // ä»»åŠ¡åˆ—è¡¨çŠ¶æ€ï¼Œåªä» localStorage æˆ– MissionContext è·å–æ•°æ®
  const [missions, setMissions] = useState<any[]>([]);
  
  // E. çŠ¶æ€ç»´æŠ¤ï¼šå®šä¹‰ currentSubStep (å½“å‰å­æ­¥éª¤ç´¢å¼•ï¼Œé»˜è®¤ä» sessionStorage è¯»å–)
  const [currentSubStep, setCurrentSubStep] = useState(() => {
    // ã€çŠ¶æ€é”å®šã€‘ç»ˆæå…œåº•ï¼šä» sessionStorage è¯»å–æš‚å­˜çš„æ­¥éª¤ç´¢å¼•
    if (typeof window !== 'undefined') {
      const savedStep = sessionStorage.getItem(`current_step_index_${stepId}`);
      return savedStep ? parseInt(savedStep, 10) : 0;
    }
    return 0;
  });
  
  // ã€ç‰©ç†çº§æ­¢è¡€ã€‘å¼ºåˆ¶åˆ·æ–° Keyï¼Œç¡®ä¿ç»„ä»¶å®Œå…¨é‡å»º
  const [instanceKey, setInstanceKey] = useState(0);
  
  // === æ²‰æµ¸å¼å¯¹ç…§æ¶æ„æ–°å¢çŠ¶æ€ ===
  const [lockedReference, setLockedReference] = useState<string | null>(null); // é”å®šçš„å‚è€ƒå¸§
  const [isVerifyPanelOpen, setIsVerifyPanelOpen] = useState(true); // éªŒè¯é¢æ¿å¼€å…³çŠ¶æ€
  
  // === Qwen-VL è§†è§‰å®¡è®¡çŠ¶æ€ ===
  const [isQwenVLAnalyzing, setIsQwenVLAnalyzing] = useState(false);
  const [qwenVLResult, setQwenVLResult] = useState<string | null>(null);
  
  // === ç´ æåŠ è½½é²æ£’æ€§çŠ¶æ€ ===
  const [currentReferenceUrl, setCurrentReferenceUrl] = useState<string | null>(null);
  const [isLoadingReference, setIsLoadingReference] = useState(false);
  
  // === P3 è¿›åº¦æœå®åŒ–çŠ¶æ€ ===
  const [completedSteps, setCompletedSteps] = useState<number[]>([]);
  
  // === P3 æ–¹æ¡ˆç±»å‹è¯»å– ===
  const [schemeType, setSchemeType] = useState<string>('A'); // é»˜è®¤åŸå‘³æ–¹æ¡ˆ
  
  // === P3 å¾®æ­¥æ•°é‡åŒæ­¥ ===
  const [microStepsCount, setMicroStepsCount] = useState<number>(0);
  
  // === å³æ—¶ä»£ç è¿è¡ŒåŠŸèƒ½çŠ¶æ€ ===
  const [editorContent, setEditorContent] = useState<string>('');
  const [isRunning, setIsRunning] = useState<boolean>(false);
  const codeEditorRef = useRef<HTMLTextAreaElement>(null);
  const runnerIframeRef = useRef<HTMLIFrameElement>(null);
  
  // è¿è¡Œä»£ç çš„æ ¸å¿ƒå‡½æ•°
  const handleRunCode = () => {
    try {
      // è·å–ç¼–è¾‘å™¨ä¸­çš„ä»£ç 
      const code = editorContent;
      if (!code.trim()) {
        alert('ä»£ç ä¸èƒ½ä¸ºç©ºï¼Œè¯·å…ˆç¼–è¾‘ä»£ç ');
        return;
      }
      
      // è®¾ç½®è¿è¡ŒçŠ¶æ€
      setIsRunning(true);
      
      // è·å– iframe å¹¶æ³¨å…¥ä»£ç 
      const iframe = runnerIframeRef.current;
      if (iframe) {
        // å°†ä»£ç ä½œä¸º srcDoc æ³¨å…¥ iframe
        iframe.srcdoc = code;
      }
    } catch (error) {
      console.error('è¿è¡Œä»£ç å‡ºé”™:', error);
      alert('è¿è¡Œä»£ç å‡ºé”™ï¼Œè¯·æ£€æŸ¥ä»£ç è¯­æ³•');
    }
  };
  
  // ä» localStorage æˆ– MissionContext è¯»å–ä»»åŠ¡æ•°æ®
  useEffect(() => {
    // æ³¨å…¥å´æ©è¾¾çœŸè¿¹ä»»åŠ¡
    const ngMission = {
      id: "ng_real_01",
      title: "ç¬¬ä¸€è¯¾ï¼šåˆ†éš”ç¬¦çš„é­”æ³•",
      verifyType: "TEXT",
      source_url: "https://www.youtube.com/embed/jC4v5AS4RIM", // çœŸå®è§†é¢‘
      desc: "ã€è§‚çœ‹ã€‘è¯·çœ‹å·¦ä¾§è§†é¢‘å‰ 2 åˆ†é’Ÿã€‚\nã€åŸæ–™ã€‘å¤åˆ¶è¿™æ®µæ–‡å­—ï¼š'å­”ä¹™å·±æ˜¯ç«™ç€å–é…’è€Œç©¿é•¿è¡«çš„å”¯ä¸€çš„äºº...'\nã€åŠ¨ä½œã€‘åœ¨ä¸‹æ–¹è¾“å…¥ Promptï¼Œç”¨ ``` å°†è¿™æ®µæ–‡å­—åŒ…è£¹ï¼Œè¦æ±‚ AI æå–ä¸»è§’ç‰¹å¾ã€‚\nã€éªŒè¯ã€‘å°†ä½ å†™å¥½çš„ Prompt ç²˜è´´åœ¨ä¸‹æ–¹ã€‚",
      verify_key: "```" // ç®€å•çš„ç‰©ç†éªŒè¯ï¼šæ£€æŸ¥æœ‰æ²¡æœ‰ç”¨åå¼•å·
    };
    
    // ä¼˜å…ˆä» localStorage è·å–å½“å‰ä»»åŠ¡åè®®
    const currentMissionProtocol = localStorage.getItem('current_mission_protocol');
    if (currentMissionProtocol) {
      try {
        const parsedMissions = JSON.parse(currentMissionProtocol);
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ä»»åŠ¡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ·»åŠ 
        const missionExists = parsedMissions.some((m: any) => m.id === ngMission.id);
        if (!missionExists) {
          parsedMissions.push(ngMission);
        }
        setMissions(parsedMissions);
        console.log('ğŸ”— ä» localStorage åŠ è½½ä»»åŠ¡åè®®å¹¶æ³¨å…¥çœŸè¿¹ä»»åŠ¡');
      } catch (error) {
        console.error('è§£æcurrent_mission_protocolå¤±è´¥:', error);
        setMissions([ngMission]);
      }
    } else if (missionState.missions && missionState.missions.length > 0) {
      // å¦‚æœ localStorage ä¸­æ²¡æœ‰ï¼Œåˆ™ä» MissionContext è·å–
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ä»»åŠ¡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ·»åŠ 
      const missionExists = missionState.missions.some((m: any) => m.id === ngMission.id);
      if (!missionExists) {
        setMissions([...missionState.missions, ngMission]);
      } else {
        setMissions(missionState.missions);
      }
      console.log('ğŸ”— ä» MissionContext åŠ è½½ä»»åŠ¡æ•°æ®å¹¶æ³¨å…¥çœŸè¿¹ä»»åŠ¡');
    } else {
      // å…œåº•ï¼šç›´æ¥ä½¿ç”¨çœŸè¿¹ä»»åŠ¡
      setMissions([ngMission]);
      console.log('ğŸ”— æ³¨å…¥çœŸè¿¹ä»»åŠ¡ä½œä¸ºå…œåº•æ•°æ®');
    }
  }, [missionState.missions]);
  
  // A. å¯»å€å‡çº§ï¼šå…ˆåœ¨ localStorage çš„ custom_missions ä¸­å¯»æ‰¾åŒ¹é…è¯¥ ID çš„ä»»åŠ¡åŒ…
  const localMissions = JSON.parse(localStorage.getItem('custom_missions') || '[]');
  
  // B. ä»activeMissionä¸­å¯»æ‰¾åŒ¹é…è¯¥IDçš„ä»»åŠ¡åŒ…
  const activeMission = JSON.parse(localStorage.getItem('activeMission') || 'null');
  
  // C. ä¼˜å…ˆä»æœ¬åœ°ä»»åŠ¡ä¸­æŸ¥æ‰¾ï¼Œç¡®ä¿ P4 ç”Ÿæˆçš„ä»»åŠ¡ä¼˜å…ˆå¤„ç†
  let targetMission = localMissions.find((m: any) => String(m.id) === String(stepId));
  
  // D. å¦‚æœæœ¬åœ°ä»»åŠ¡ä¸­æ‰¾ä¸åˆ°ï¼Œä»activeMissionä¸­æŸ¥æ‰¾
  if (!targetMission && activeMission && String(activeMission.id) === String(stepId)) {
    targetMission = activeMission;
  }
  
  // E. å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼Œä½¿ç”¨é»˜è®¤ä»»åŠ¡ï¼ˆé˜²å´©æºƒä¿æŠ¤ï¼‰
  if (!targetMission) {
    targetMission = {
      id: 'default',
      title: 'ç­‰å¾…åŒæ­¥åè®®',
      type: 'TEXT',
      desc: 'è¯·ä» P4 ç¼–è¾‘å™¨ç”Ÿæˆå¹¶åŒæ­¥ä»»åŠ¡åè®®',
      key: 'SYNC_NEEDED',
      color: '#666'
    };
  }
  
  // F. é€‚é… P4 æ–°æ•°æ®ç»“æ„ï¼šå¤„ç† asset, material, instruction, validation
  const [p4MissionData, setP4MissionData] = useState<any>(null);
  
  // ç›‘å¬ P4 ä¼ è¿‡æ¥çš„æ–°æ•°æ®ç»“æ„
  useEffect(() => {
    // ä» localStorage ç›‘å¬ P4 æ•°æ®å˜åŒ–
    const handleStorageChange = (event: StorageEvent) => {
      if (event.key === 'p4MissionData') {
        try {
          const data = JSON.parse(event.newValue || 'null');
          if (data) {
            setP4MissionData(data);
            console.log('ğŸ”— ä» localStorage åŠ è½½ P4 æ–°æ•°æ®ç»“æ„:', data);
          }
        } catch (error) {
          console.error('âŒ è§£æ P4 æ•°æ®å¤±è´¥:', error);
        }
      }
    };
    
    // åˆå§‹åŠ è½½
    const initialP4Data = localStorage.getItem('p4MissionData');
    if (initialP4Data) {
      try {
        const data = JSON.parse(initialP4Data);
        setP4MissionData(data);
        console.log('ğŸ”— åˆå§‹åŠ è½½ P4 æ–°æ•°æ®ç»“æ„:', data);
      } catch (error) {
        console.error('âŒ åˆå§‹è§£æ P4 æ•°æ®å¤±è´¥:', error);
      }
    }
    
    window.addEventListener('storage', handleStorageChange);
    return () => window.removeEventListener('storage', handleStorageChange);
  }, []);
  
  // å¾®æ­¥æ•°é‡è®¾ç½®ï¼šä»localStorageè¯»å–
  useEffect(() => {
    // æ­£å¸¸æƒ…å†µï¼šä»localStorageè¯»å–å¾®æ­¥æ•°é‡
    const savedMicroStepsCount = localStorage.getItem('microStepsCount');
    if (savedMicroStepsCount) {
      setMicroStepsCount(parseInt(savedMicroStepsCount, 10));
    }
  }, []);
  
  // Qwen-VL è§†è§‰å®¡è®¡å‡½æ•° - æç®€å®ç°
  const handleQwenVLAudit = async () => {
    setIsQwenVLAnalyzing(true);
    setQwenVLResult(null);
    
    try {
      console.log('ğŸ” Qwen-VLè§†è§‰å®¡è®¡å¼€å§‹...');
      
      // 1. æ•è·å·¥ä½œåŒºæˆªå›¾
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      if (!ctx) {
        throw new Error('æ— æ³•è·å–Canvasä¸Šä¸‹æ–‡');
      }
      
      // è®¾ç½®Canvaså°ºå¯¸ä¸ºå·¥ä½œåŒºå°ºå¯¸
      const workArea = document.querySelector('[data-work-area]') as HTMLElement;
      if (!workArea) {
        throw new Error('æœªæ‰¾åˆ°å·¥ä½œåŒºå…ƒç´ ');
      }
      
      const rect = workArea.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
      
      // ç»˜åˆ¶å·¥ä½œåŒºå†…å®¹åˆ°Canvas
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // è¿™é‡Œåº”è¯¥å®ç°å®é™…çš„æˆªå›¾é€»è¾‘
      // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      
      // 2. è°ƒç”¨Qwen-VL APIï¼ˆæ¨¡æ‹Ÿå®ç°ï¼‰
      const qwenVLResponse = await callQwenVLAPI(canvas.toDataURL('image/png'));
      
      // 3. è§£æå¹¶æ˜¾ç¤ºç»“æœï¼ˆ8å²å°å­©èƒ½æ‡‚çš„ä¸­æ–‡ï¼‰
      setQwenVLResult(qwenVLResponse);
      console.log('âœ… Qwen-VLè§†è§‰å®¡è®¡å®Œæˆ');
      
    } catch (error) {
      console.error('âŒ Qwen-VLè§†è§‰å®¡è®¡å¤±è´¥:', error);
      setQwenVLResult('è§†è§‰å®¡è®¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–é‡è¯•ã€‚');
    } finally {
      setIsQwenVLAnalyzing(false);
    }
  };

  // Qwen-VL APIè°ƒç”¨å‡½æ•°ï¼ˆæ¨¡æ‹Ÿå®ç°ï¼‰
  const callQwenVLAPI = async (imageData: string): Promise<string> => {
    // æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    // æ¨¡æ‹ŸQwen-VLè¿”å›ç»“æœï¼ˆ8å²å°å­©èƒ½æ‡‚çš„ä¸­æ–‡ï¼‰
    return `
ğŸ¯ è§†è§‰å®¡è®¡ç»“æœï¼š

âœ… åšå¾—å¥½çš„åœ°æ–¹ï¼š
- é¢œè‰²åŸºæœ¬ä¸€è‡´ï¼Œéƒ½æ˜¯é»‘ç™½é£æ ¼
- å¸ƒå±€ä½ç½®å·®ä¸å¤š

âŒ éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼š
- å·¦è¾¹çš„æŒ‰é’®æ¯”å‚è€ƒå›¾å°äº†ä¸€ç‚¹ç‚¹
- æ–‡å­—å¤§å°å¯ä»¥å†å¤§ä¸€äº›
- å›¾ç‰‡ä½ç½®ç¨å¾®åå³äº†

ğŸ’¡ å»ºè®®ï¼š
æŠŠæŒ‰é’®è°ƒå¤§ä¸€ç‚¹ï¼Œæ–‡å­—ä¹Ÿè°ƒå¤§ï¼Œå›¾ç‰‡å¾€å·¦ç§»åŠ¨ä¸€ç‚¹ç‚¹å°±å®Œç¾å•¦ï¼
    `;
  };

  // ç´ æåŠ è½½é²æ£’æ€§å‡½æ•° - ä¼˜å…ˆæœ¬åœ°å­˜å‚¨
  const loadReferenceMaterial = async (url: string): Promise<string> => {
    setIsLoadingReference(true);
    
    try {
      // 1. é¦–å…ˆå°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½
      const cachedUrl = localStorage.getItem(`cached_reference_${btoa(url)}`);
      if (cachedUrl) {
        console.log('âœ… ä»æœ¬åœ°ç¼“å­˜åŠ è½½å‚è€ƒç´ æ');
        setCurrentReferenceUrl(cachedUrl);
        return cachedUrl;
      }
      
      // 2. å¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œå°è¯•åŠ è½½è¿œç¨‹èµ„æº
      console.log('ğŸŒ ä»è¿œç¨‹åŠ è½½å‚è€ƒç´ æ');
      
      // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚å»¶è¿Ÿ
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // æ£€æŸ¥èµ„æºæ˜¯å¦å¯è®¿é—®
      const response = await fetch(url, { method: 'HEAD' });
      if (!response.ok) {
        throw new Error('è¿œç¨‹èµ„æºä¸å¯è®¿é—®');
      }
      
      // 3. æˆåŠŸåŠ è½½åç¼“å­˜åˆ°æœ¬åœ°
      localStorage.setItem(`cached_reference_${btoa(url)}`, url);
      setCurrentReferenceUrl(url);
      return url;
      
    } catch (error) {
      console.error('âŒ ç´ æåŠ è½½å¤±è´¥:', error);
      
      // 4. åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºæœ¬åœ°é»˜è®¤ç´ æ
      const defaultMaterial = localStorage.getItem('default_reference_material');
      if (defaultMaterial) {
        console.log('ğŸ”„ ä½¿ç”¨æœ¬åœ°é»˜è®¤ç´ æ');
        setCurrentReferenceUrl(defaultMaterial);
        return defaultMaterial;
      }
      
      // 5. è¿é»˜è®¤ç´ æéƒ½æ²¡æœ‰ï¼ŒæŠ›å‡ºé”™è¯¯è§¦å‘Error Boundary
      throw new Error('æœ¬åœ°çœŸè¿¹åº“ç¼ºå¤±');
      
    } finally {
      setIsLoadingReference(false);
    }
  };

  // F. é€‚é… P4 æ–°æ•°æ®ç»“æ„ï¼šå•é¡µåŸå­ä»»åŠ¡æ¸²æŸ“
  // ä¿®å¤ï¼šé‡æ–°å®šä¹‰ steps å’Œ hasSubSteps å˜é‡ï¼Œç¡®ä¿å®ƒä»¬åœ¨æ‰€æœ‰åœ°æ–¹éƒ½èƒ½æ­£ç¡®è®¿é—®
  const steps = targetMission?.steps || [];
  const hasSubSteps = targetMission && targetMission.steps && Array.isArray(targetMission.steps) && targetMission.steps.length > 0;
  
  // åºŸå¼ƒæ—§çš„ steps éå†é€»è¾‘ï¼Œæ”¹ä¸ºç›´æ¥ä½¿ç”¨ P4 ä¼ è¿‡æ¥çš„æ–°æ•°æ®ç»“æ„
  const isP4Mission = p4MissionData?.asset && p4MissionData?.material;
  
  // åˆå¹¶æ•°æ®ï¼šä¼˜å…ˆä½¿ç”¨ P4 æ–°æ•°æ®ç»“æ„ï¼Œå¦åˆ™ä½¿ç”¨æ—§ç»“æ„
  const currentStep = isP4Mission ? {
    ...targetMission,
    ...p4MissionData,
    type: 'TEXT', // é»˜è®¤ä½¿ç”¨æ–‡æœ¬éªŒè¯ç±»å‹
    source_url: p4MissionData.asset?.url, // ä¿®å¤ï¼šæ·»åŠ ç©ºå€¼ä¿æŠ¤
    desc: p4MissionData.instruction || '', // ä¿®å¤ï¼šæ·»åŠ ç©ºå€¼ä¿æŠ¤
    key: p4MissionData.validation?.keyword // ä¿®å¤ï¼šæ·»åŠ ç©ºå€¼ä¿æŠ¤
  } : (hasSubSteps ? targetMission.steps[currentSubStep] : targetMission);
  
  // åˆå§‹åŒ–ç¼–è¾‘å™¨å†…å®¹ï¼Œé¢„å¡« P4 ä¼ è¿‡æ¥çš„åŸæ–™ä»£ç 
  useEffect(() => {
    // æ”¾å®½åˆ¤æ–­é€»è¾‘ï¼Œå…¼å®¹å¤šç§ä»£ç å­—æ®µå
    const rawCode = p4MissionData?.material || targetMission?.materialLayer?.content || targetMission?.material;
    
    if (rawCode) {
      setEditorContent(rawCode || '');
    }
  }, [p4MissionData, targetMission]);
  
  // ç›‘å¬ä»»åŠ¡å˜åŒ–å’Œå½“å‰æ­¥éª¤å˜åŒ–ï¼Œè‡ªåŠ¨åŠ è½½å‚è€ƒç´ æ
  useEffect(() => {
    // å‡çº§ï¼šæ”¾å®½åˆ¤æ–­é€»è¾‘ï¼Œå…¼å®¹å¤šç§å­—æ®µå
    const referenceUrl = lockedReference || 
      currentStep?.mediaUrl || // æ–°å¢ï¼šæ”¯æŒ mediaUrl
      currentStep?.asset?.url || // æ”¯æŒ asset.url
      currentStep?.assetLayer?.mediaUrl || // æ”¯æŒ assetLayer.mediaUrl
      currentStep?.source_url;
    
    // åªè¦æœ‰ä»»ä½•è§†é¢‘URLï¼Œå°±å°è¯•åŠ è½½
    if (referenceUrl) {
      loadReferenceMaterial(referenceUrl).catch(error => {
        console.error('å‚è€ƒç´ æåŠ è½½å¤±è´¥:', error);
      });
    } else {
      setCurrentReferenceUrl(null);
    }
  }, [lockedReference, currentStep?.source_url, currentStep?.assetLayer?.mediaUrl, currentStep?.asset?.url, currentStep?.mediaUrl, p4MissionData]);
  
  // è·å–éªŒè¯ç±»å‹å›¾æ ‡å‡½æ•°
  const getStepIcon = (type: string) => {
    switch (type) {
      case 'SCREEN_SHOT':
      case 'SCREEN':
        return <Monitor size={14} />;
      case 'TEXT':
        return <FileText size={14} />;
      case 'VOICE':
        return <Mic size={14} />;
      default:
        return <Activity size={14} />;
    }
  };
  
  // ç›‘å¬ URL å˜åŒ–ï¼Œä»…åœ¨ä»»åŠ¡çœŸæ­£åˆ‡æ¢æ—¶é‡ç½®å­æ­¥éª¤çŠ¶æ€
  useEffect(() => {
    // é‡æ–°æŸ¥æ‰¾ä»»åŠ¡å¯¹è±¡
    let newTargetMission = localMissions.find((m: any) => String(m.id) === String(stepId));
    
    // å¦‚æœæœ¬åœ°ä»»åŠ¡ä¸­æ‰¾ä¸åˆ°ï¼Œä»activeMissionä¸­æŸ¥æ‰¾
    if (!newTargetMission && activeMission && String(activeMission.id) === String(stepId)) {
      newTargetMission = activeMission;
    }
    
    // å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼Œä½¿ç”¨é»˜è®¤ä»»åŠ¡ï¼ˆé˜²å´©æºƒä¿æŠ¤ï¼‰
    if (!newTargetMission) {
      newTargetMission = {
        id: 'default',
        title: 'ç­‰å¾…åŒæ­¥åè®®',
        type: 'TEXT',
        desc: 'è¯·ä» P4 ç¼–è¾‘å™¨ç”Ÿæˆå¹¶åŒæ­¥ä»»åŠ¡åè®®',
        key: 'SYNC_NEEDED',
        color: '#666'
      };
    }
    
    // ã€çŠ¶æ€é”å®šã€‘ä»…åœ¨ä»»åŠ¡ ID çœŸæ­£å˜åŒ–æ—¶æ‰é‡ç½®å­æ­¥éª¤ç´¢å¼•
    if (newTargetMission.id !== targetMission?.id) {
      setCurrentSubStep(0);
      console.log("ã€çŠ¶æ€é”å®šã€‘ä»»åŠ¡åˆ‡æ¢ï¼Œé‡ç½®å­æ­¥éª¤ç´¢å¼•ä¸ºåˆå§‹å€¼");
    }
  }, [stepId, localMissions, activeMission, targetMission?.id]);

  // ã€çŠ¶æ€å›æ˜¾ã€‘ä¿å­˜å’Œæ¢å¤è¾“å…¥æ–‡æœ¬çŠ¶æ€


  // ã€çŠ¶æ€å›æ˜¾ã€‘åŠ è½½å½“å‰æ­¥éª¤çš„è¾“å…¥çŠ¶æ€
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const savedState = sessionStorage.getItem(`input_state_${stepId}_${currentSubStep}`);
      if (savedState) {
        // çŠ¶æ€æ¢å¤ç”±VerifyPanelç»„ä»¶å†…éƒ¨ç®¡ç†
      }
    }
  }, [stepId, currentSubStep]);

  // ã€çŠ¶æ€é”å®šã€‘ç›‘å¬ currentSubStep å˜åŒ–ï¼Œä¿å­˜åˆ° sessionStorage
  useEffect(() => {
    if (typeof window !== 'undefined') {
      // é˜²æ­¢æ­»å¾ªç¯ï¼šä»…åœ¨æœ‰æ•ˆæ­¥éª¤æ—¶ä¿å­˜
      if (currentSubStep >= 0) {
        sessionStorage.setItem(`current_step_index_${stepId}`, currentSubStep.toString());
        console.log("ã€çŠ¶æ€é”å®šã€‘ä¿å­˜æ­¥éª¤ç´¢å¼•åˆ° sessionStorage:", currentSubStep);
      }
    }
  }, [currentSubStep, stepId]);
  
  // ã€æ–¹æ¡ˆç±»å‹è¯»å–ã€‘ä»activeMissionä¸­è¯»å–æ–¹æ¡ˆç±»å‹
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const activeMission = localStorage.getItem('activeMission');
      if (activeMission) {
        try {
          const missionData = JSON.parse(activeMission);
          if (missionData.schemeType) {
            setSchemeType(missionData.schemeType);
            console.log("ã€æ–¹æ¡ˆç±»å‹è¯»å–ã€‘æ£€æµ‹åˆ°æ–¹æ¡ˆç±»å‹:", missionData.schemeType);
          }
        } catch (error) {
          console.warn("ã€æ–¹æ¡ˆç±»å‹è¯»å–ã€‘è§£æactiveMissionå¤±è´¥:", error);
        }
      }
    }
  }, [stepId]);

  // ã€åè®®åŒæ­¥ç›‘å¬ã€‘ç›‘å¬ P4 åŒæ­¥äº‹ä»¶ï¼Œè§¦å‘é‡æ–°æ¸²æŸ“
  useEffect(() => {
    const handleStorageChange = (event: StorageEvent) => {
      if (event.key === 'lastSyncTimestamp' || event.key === 'activeMission') {
        console.log('ğŸ”— æ£€æµ‹åˆ°åè®®åŒæ­¥ï¼Œè§¦å‘ P3 é‡æ–°æ¸²æŸ“');
        
        // å¼ºåˆ¶åˆ·æ–°ç»„ä»¶å®ä¾‹
        setInstanceKey(prev => prev + 1);
        
        // é‡æ–°åŠ è½½ä»»åŠ¡æ•°æ®
        const newLocalMissions = JSON.parse(localStorage.getItem('custom_missions') || '[]');
        const newTargetMission = newLocalMissions.find((m: any) => String(m.id) === String(stepId));
        
        // å¦‚æœæœ¬åœ°ä»»åŠ¡ä¸­æ‰¾ä¸åˆ°ï¼Œå°è¯•ä» activeMission åŠ è½½
        let finalMission = newTargetMission;
        if (!finalMission) {
          const activeMission = JSON.parse(localStorage.getItem('activeMission') || 'null');
          if (activeMission && String(activeMission.id) === String(stepId)) {
            finalMission = activeMission;
            console.log('ğŸ”— ä» activeMission åŠ è½½ä»»åŠ¡æ•°æ®');
          }
        }
        
        if (finalMission) {
          console.log('ğŸ”— å·²åŠ è½½åŒæ­¥åçš„ä»»åŠ¡æ•°æ®:', finalMission);
          
          // å¦‚æœæ–°ä»»åŠ¡æœ‰ç´ æURLï¼Œè‡ªåŠ¨è§£é”å‚è€ƒçª—å£
          if (finalMission.source_url) {
            console.log('ğŸ”— æ£€æµ‹åˆ°æ–°ç´ æURLï¼Œè‡ªåŠ¨åŠ è½½å‚è€ƒç´ æ');
          }
        }
      }
    };

    // ç›‘å¬ localStorage å˜åŒ–
    window.addEventListener('storage', handleStorageChange);
    
    // æ¸…ç†ç›‘å¬å™¨
    return () => {
      window.removeEventListener('storage', handleStorageChange);
    };
  }, [stepId]);

  // æ‰‹åŠ¨åŒæ­¥æ£€æŸ¥ï¼ˆç”¨äºå½“å‰é¡µé¢å†…è§¦å‘ï¼‰
  const checkForSync = () => {
    console.log('ğŸ”„ æ‰‹åŠ¨æ£€æŸ¥åè®®åŒæ­¥çŠ¶æ€');
    
    // å¼ºåˆ¶åˆ·æ–°ç»„ä»¶å®ä¾‹
    setInstanceKey(prev => prev + 1);
    
    // é‡æ–°åŠ è½½ä»»åŠ¡æ•°æ®
    const newLocalMissions = JSON.parse(localStorage.getItem('custom_missions') || '[]');
    const newTargetMission = newLocalMissions.find((m: any) => String(m.id) === String(stepId));
    
    // å¦‚æœæœ¬åœ°ä»»åŠ¡ä¸­æ‰¾ä¸åˆ°ï¼Œå°è¯•ä» activeMission åŠ è½½
    let finalMission = newTargetMission;
    if (!finalMission) {
      const activeMission = JSON.parse(localStorage.getItem('activeMission') || 'null');
      if (activeMission && String(activeMission.id) === String(stepId)) {
        finalMission = activeMission;
        console.log('ğŸ”— ä» activeMission åŠ è½½ä»»åŠ¡æ•°æ®');
      }
    }
    
    if (finalMission) {
      console.log('ğŸ”— æ‰‹åŠ¨åŒæ­¥æˆåŠŸï¼ŒåŠ è½½ä»»åŠ¡æ•°æ®:', finalMission);
      alert('âœ… åè®®åŒæ­¥æˆåŠŸï¼');
    } else {
      console.log('ğŸ”— æœªæ‰¾åˆ°åŒæ­¥çš„ä»»åŠ¡æ•°æ®');
      alert('âŒ æœªæ‰¾åˆ°åŒæ­¥çš„ä»»åŠ¡æ•°æ®');
    }
  };




  // æ·»åŠ è¿‡æ¸¡çŠ¶æ€
  const [isTransitioning, setIsTransitioning] = useState(false);
  
  // é‡å†™ä¸º handleVerifyï¼Œç¡®ä¿ä»»åŠ¡ç‰©ç†è·³è½¬çš„é“¾è·¯é—­ç¯
  const handleNextStep = () => {
    // 1. ç«‹å³æ›´æ–°å½“å‰å­æ­¥éª¤çš„å®ŒæˆçŠ¶æ€
    setCompletedSteps(prev => [...prev, currentSubStep]);
    
    console.log("ä¿¡å·å·²æ”¶åˆ°ï¼Œå¼ºåˆ¶è·³è½¬è‡³:", currentSubStep + 1);
    
    // 2. å¼ºåˆ¶ç´¢å¼•æ­¥è¿›
    // ä¿®å¤ï¼šæ·»åŠ ç©ºå€¼ä¿æŠ¤ï¼Œç¡®ä¿ steps æ˜¯æœ‰æ•ˆçš„æ•°ç»„
    if (steps && steps.length > 0 && currentSubStep < steps.length - 1) {
      setCurrentSubStep(prev => prev + 1);
    } else {
      // é˜²å¾¡æ€§æ£€æŸ¥ï¼šå¦‚æœæ˜¯æœ€åä¸€ä¸ªæ­¥éª¤æˆ–å•é¡µä»»åŠ¡ï¼Œå¼¹å‡ºå…¨å±€æç¤º
      alert("åè®®å·²åœ†æ»¡ç­¾ç½²");
      console.log("Mission Accomplished");
    }
    
    // 3. ç¡®ä¿æ»šåŠ¨åˆ°é¡¶éƒ¨
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  // --- æ™ºèƒ½å·¥å…·ç®±çŠ¶æ€ ---
  const [isToolboxExpanded, setIsToolboxExpanded] = useState(true);

  // --- é€»è¾‘é€‚é…ï¼šæ ¹æ®typeå­—æ®µåŠ¨æ€æ¸²æŸ“ç»„ä»¶ ---
  // ä¿®å¤ï¼šæ·»åŠ ç©ºå€¼ä¿æŠ¤ï¼Œé˜²æ­¢ currentStep ä¸ºç©ºæ—¶å‡ºé”™
  const displayType = currentStep?.type === 'SCREEN_SHOT' ? 'SCREEN' : currentStep?.type;

  // --- ç©ºæ¯é‡ç½®åŠŸèƒ½ (ç‰©ç†çº§æ­¢è¡€) ---
  const handleReset = () => {
    // ã€ç©ºæ¯é‡ç½®ã€‘å¼ºåˆ¶æ‰§è¡Œç‰©ç†çº§é‡ç½®ï¼Œä»»ä½•æ®‹ç•™ç¼“å­˜éƒ½å¿…é¡»æ­»
    
    // A. ç‰©ç†æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
    sessionStorage.clear();
    localStorage.removeItem(`completed_step_${stepId}`);
    
    // B. ç‰©ç†è§¦å‘ç»„ä»¶é‡è¿
    setInstanceKey(prev => prev + 1);
    
    // C. ç‰©ç†è·³è½¬ï¼ˆå¯é€‰ï¼Œç¡®ä¿è·¯ç”±åˆ·æ–°ï¼‰
    console.log("ã€ç‰©ç†é‡ç½®ã€‘æ‰€æœ‰çŠ¶æ€å·²å¼ºåˆ¶åˆå§‹åŒ–");
  };



  const themeColor = currentStep.color || "#06b6d4";
  // ç±»å‹æ˜ å°„ï¼šå°†P4ç”Ÿæˆçš„ä¸‰ç§æ ‡å‡†ç±»å‹æ˜ å°„åˆ°å¯¹åº”çš„æ¸²æŸ“ç»„ä»¶


  // æ§åˆ¶å°åŸ‹ç‚¹ï¼šæ˜¾ç¤ºç»„ä»¶æŒ‚è½½çŠ¶æ€å’Œ missions æ•°æ®
  console.log('LabPage Mounted, missions:', missions);
  
  // --- ğŸ è´ªé£Ÿè›‡æ²™ç›’é€»è¾‘ Start ---
  // ä¸‡èƒ½é€‚é…ï¼šä¸ç®¡ P4 å‘ä»€ä¹ˆæ ¼å¼ï¼Œéƒ½è½¬æˆæ ‡å‡†æ ¼å¼
  const snakeData = {
    video: targetMission?.mediaUrl || targetMission?.assetLayer?.mediaUrl || targetMission?.videoUrl || targetMission?.asset?.url,
    code: targetMission?.rawMaterial || targetMission?.materialLayer?.content || targetMission?.rawCode || targetMission?.material,
    instruction: targetMission?.instruction || targetMission?.desc || "è¯·å‚è€ƒå·¦ä¾§ç´ æï¼Œä¿®æ”¹ä»£ç ã€‚"
  };
  
  const [sandboxCode, setSandboxCode] = useState("");
  const [sandboxRunning, setSandboxRunning] = useState(false);
  const [sandboxKey, setSandboxKey] = useState(0);

  // ç›‘å¬ä»»åŠ¡åˆ‡æ¢ï¼Œæ›´æ–°ä»£ç 
  useEffect(() => {
     if (snakeData.code) setSandboxCode(snakeData.code);
  }, [snakeData.code]);
  // --- ğŸ è´ªé£Ÿè›‡æ²™ç›’é€»è¾‘ End ---
  
  // è°ƒè¯•ç¥å™¨ï¼šæ‰“å°å‡ºæ¥çœ‹çœ‹åˆ°åº•æœ‰æ²¡æœ‰æ‹¿åˆ°
  console.log("ã€P3 å¼ºåˆ¶æ¸²æŸ“æ•°æ®ã€‘", snakeData);
  
  // è‡´å‘½æ£€æŸ¥ï¼šå¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»åŠ¡ï¼Œæ˜¾ç¤ºå¾…æœºé¡µé¢
  if (!targetMission) {
    return (
      <div style={{
        display: 'flex',
        height: '100vh',
        width: '100vw',
        alignItems: 'center',
        justifyContent: 'center',
        background: 'black',
        color: 'white'
      }}>
        <div style={{ textAlign: 'center' }}>
          <h2 style={{ fontSize: '24px', fontWeight: 'bold', marginBottom: '8px' }}>å®éªŒå®¤å¾…æœºä¸­...</h2>
          <p style={{ color: '#666', marginBottom: '16px' }}>è¯·å‰å¾€ P4 é“¸é€ å¹¶å‘å¸ƒæ–°ä»»åŠ¡</p>
          <button
            onClick={() => navigate('/editor')}
            style={{
              background: '#000',
              border: '1px solid #333',
              borderRadius: '0',
              padding: '12px 24px',
              cursor: 'pointer',
              color: '#fff',
              fontSize: '14px'
            }}
          >
            è¿”å› P4 ç¼–è¾‘å™¨
          </button>
        </div>
      </div>
    );
  }
  
  // å†æ¬¡æ£€æŸ¥ï¼šç¡®ä¿ targetMission å­˜åœ¨ï¼Œé˜²æ­¢ç©ºæŒ‡é’ˆå´©æºƒ
  if (!targetMission) {
    return (
      <div style={{
        display: 'flex',
        height: '100vh',
        width: '100vw',
        alignItems: 'center',
        justifyContent: 'center',
        background: 'black',
        color: 'white',
        padding: '40px'
      }}>
        <div style={{ textAlign: 'center' }}>
          <h2 style={{ fontSize: '24px', fontWeight: 'bold', marginBottom: '8px' }}>æ­£åœ¨ç­‰å¾…ä»»åŠ¡æ•°æ®åŒæ­¥...</h2>
          <p style={{ color: '#666' }}>è¯·ç¡®ä¿ P4 å·²å‘å¸ƒä»»åŠ¡ï¼Œæ•°æ®æ­£åœ¨åŒæ­¥ä¸­...</p>
        </div>
      </div>
    );
  }
  
  // --- 4. è§†è§‰æ¸²æŸ“ (é‡æ„ä¸ºæ²‰æµ¸å¼å¯¹ç…§æ¶æ„) ---
  return (
    <div key={instanceKey} style={{
      position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh',
      backgroundColor: '#050505', color: '#fff', 
      display: 'flex', flexDirection: 'row', overflow: 'hidden',
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
      // æ·»åŠ è¿‡æ¸¡åŠ¨æ•ˆï¼šæ¨¡æ‹Ÿä»»åŠ¡åˆ‡æ¢çš„ç‰©ç†æ„Ÿ
      opacity: isTransitioning ? 0.5 : 1,
      transition: 'opacity 0.5s ease-in-out'
    }}>
      
      {/* é¡¶éƒ¨è¿›åº¦æ¡ */}
        <div style={{ position: 'absolute', top: 0, left: 0, width: '100%', height: '4px', background: '#222', zIndex: 200 }}>
          <div style={{ 
            // é€‚é… P4 å•é¡µåŸå­ä»»åŠ¡ï¼šè¿›åº¦æ¡å§‹ç»ˆæ˜¾ç¤º100%
            width: isP4Mission ? '100%' : hasSubSteps 
              ? `${((currentSubStep + 1) / targetMission.steps.length) * 100}%`
              : '100%', 
            maxWidth: '100%',
            height: '100%', background: themeColor, 
            transition: 'width 0.5s cubic-bezier(0.4, 0, 0.2, 1)'
          }}></div>
        </div>
        
        {/* P3 è¿›åº¦æœå®åŒ–åœ°å›¾ */}
        {/* é€‚é… P4 å•é¡µåŸå­ä»»åŠ¡ï¼šéšè—è¿›åº¦æœå®å›¾ */}
        {!isP4Mission && ((hasSubSteps && targetMission.steps.length > 1) || microStepsCount > 0) && (
          <div style={{
            position: 'absolute',
            top: '24px',
            left: '50%',
            transform: 'translateX(-50%)',
            zIndex: 199
          }}>
            <FruitProgressMap 
              totalSteps={microStepsCount > 0 ? microStepsCount : targetMission.steps.length}
              currentStep={currentSubStep}
              completedSteps={completedSteps}
            />
          </div>
        )}
      
      {/* è¿”å›æŒ‰é’® - æç®€è®¾è®¡ */}
      <button 
        onClick={() => navigate('/')}
        style={{ 
          position: 'absolute', top: 24, left: 24, zIndex: 100,
          background: '#000', border: '1px solid #333', borderRadius: '0',
          padding: 12, cursor: 'pointer', color: '#fff',
          display: 'flex', alignItems: 'center', justifyContent: 'center'
        }}
      >
        <ArrowLeft size={20} />
      </button>

      {/* === SideGuide (25%) - å·¦ä¾§ä»»åŠ¡æ  === */}
      <div style={{
        width: '25%', height: '100%', borderRight: '1px solid #333',
        background: '#000',
        display: 'flex', flexDirection: 'column',
        position: 'relative',
        overflowY: 'auto',
        padding: '20px 0'
      }}>
        
        {/* ä»»åŠ¡æ ‡é¢˜æ  */}
        <div style={{
          padding: '0 20px 20px', 
          borderBottom: '1px solid rgba(255,255,255,0.1)',
          marginBottom: '20px'
        }}>
          <div style={{
            display: 'flex', 
            alignItems: 'center', 
            gap: 10, 
            marginBottom: 10 
          }}>
            <span style={{
              padding: '4px 12px', 
              background: '#000', 
              border: `1px solid ${themeColor}`, 
              color: themeColor, 
              fontSize: 12, 
              borderRadius: '0', 
              letterSpacing: 2, 
              fontWeight: 'bold'
            }}>
              MISSION
            </span>
            <span style={{
              color: '#666', 
              fontSize: 12, 
              fontWeight: 'bold', 
              display: 'flex', 
              alignItems: 'center', 
              gap: 5 
            }}>
              <Activity size={14} /> {targetMission?.type || 'MIXED'}
            </span>
          </div>
          <h3 style={{
            fontSize: 18, 
            fontWeight: 'bold', 
            color: '#fff', 
            margin: 0,
            lineHeight: 1.3
          }}>
            {targetMission?.title || 'æœªå‘½åä»»åŠ¡'}
          </h3>
        </div>

        {/* åŒæ­¥æŒ‰é’® */}
        <div style={{
          padding: '0 20px 15px', 
          borderBottom: '1px solid #333' 
        }}>
          <button
            onClick={checkForSync}
            style={{
              width: '100%',
              background: '#000',
              border: '1px solid #333',
              color: '#fff',
              padding: '10px 16px',
              borderRadius: '0',
              fontSize: 13,
              fontWeight: 'normal',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: 8
            }}
          >
            <Activity size={14} />
            æ‰‹åŠ¨åŒæ­¥åè®®
          </button>
        </div>

        {/* ä»»åŠ¡èŠ‚ç‚¹åˆ—è¡¨ - æç®€Timeline */}
        <div style={{
          padding: '0 10px',
          position: 'relative'
        }}>
          {/* Timeline è¿çº¿ */}
          {!isP4Mission && hasSubSteps && (
            <div style={{
              position: 'absolute',
              left: 20,
              top: 0,
              bottom: 0,
              width: 1,
              background: '#333',
              zIndex: 1
            }} />
          )}
          
          {/* é€‚é… P4 å•é¡µåŸå­ä»»åŠ¡ */}
          {isP4Mission ? (
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: 12,
              padding: '8px 16px',
              cursor: 'pointer',
              background: 'transparent',
              border: 'none',
              transition: 'all 0.2s ease',
              position: 'relative',
              zIndex: 2
            }}
            onMouseEnter={(e) => {
              e.currentTarget.style.background = 'rgba(255,255,255,0.05)';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.background = 'transparent';
            }}>
              <div style={{
                width: 12,
                height: 12,
                borderRadius: '0',
                background: '#fff',
                border: '2px solid #fff',
                position: 'relative',
                zIndex: 3
              }} />
              <div style={{ 
                color: '#fff',
                opacity: 1
              }}>
                {getStepIcon('TEXT')}
              </div>
              <div style={{
                flex: 1,
                fontSize: 14,
                fontWeight: 'normal',
                color: '#fff',
                lineHeight: 1.2,
                opacity: 1
              }}>
                {p4MissionData.validation?.description || 'éªŒè¯è§„åˆ™'}
              </div>
              <div style={{
                fontSize: 11,
                color: '#fff',
                fontWeight: 'normal',
                opacity: 0.6
              }}>
                1
              </div>
            </div>
          ) : hasSubSteps ? (
            targetMission.steps.map((step: any, index: number) => {
              const isActive = index === currentSubStep;
              const isCompleted = index < currentSubStep;
              const isLocked = index > currentSubStep;
              
              return (
                <div
                  key={step.id || index}
                  onClick={() => !isLocked && setCurrentSubStep(index)}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: 12,
                    padding: '8px 16px',
                    marginBottom: 0,
                    cursor: isLocked ? 'not-allowed' : 'pointer',
                    background: 'transparent',
                    border: 'none',
                    transition: 'all 0.2s ease',
                    opacity: isLocked ? 0.3 : 1,
                    position: 'relative',
                    zIndex: 2
                  }}
                  onMouseEnter={(e) => {
                    if (!isLocked) {
                      e.currentTarget.style.background = 'rgba(255,255,255,0.05)';
                    }
                  }}
                  onMouseLeave={(e) => {
                    if (!isLocked) {
                      e.currentTarget.style.background = 'transparent';
                    }
                  }}>
                  {/* çŠ¶æ€æŒ‡ç¤ºå™¨ - æ–¹å½¢ */}
                  <div style={{
                    width: 12,
                    height: 12,
                    borderRadius: '0',
                    background: isActive ? '#fff' : isCompleted ? '#fff' : '#666',
                    border: isActive ? '2px solid #fff' : '1px solid #666',
                    position: 'relative',
                    zIndex: 3
                  }} />
                  
                  {/* æç®€å›¾æ ‡ */}
                  <div style={{
                    color: isActive ? '#fff' : isCompleted ? '#fff' : '#666',
                    opacity: isActive ? 1 : 0.7
                  }}>
                    {getStepIcon(step.verifyType || step.type)}
                  </div>
                  
                  {/* æ­¥éª¤æ ‡é¢˜ - ç»Ÿä¸€å­—å·ï¼Œå–æ¶ˆåŠ ç²— */}
                  <div style={{
                    flex: 1,
                    fontSize: 14,
                    fontWeight: 'normal',
                    color: isActive ? '#fff' : isCompleted ? '#fff' : '#aaa',
                    lineHeight: 1.2,
                    opacity: isActive ? 1 : 0.8
                  }}>
                    {step.title || `æ­¥éª¤ ${index + 1}`}
                  </div>
                  
                  {/* æ­¥éª¤ç¼–å· - æç®€æ˜¾ç¤º */}
                  <div style={{
                    fontSize: 11,
                    color: isActive ? '#fff' : '#666',
                    fontWeight: 'normal',
                    opacity: 0.6
                  }}>
                    {index + 1}
                  </div>
                </div>
              );
            })
          ) : (
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: 12,
              padding: '8px 16px',
              cursor: 'pointer',
              background: 'transparent',
              border: 'none',
              transition: 'all 0.2s ease',
              position: 'relative',
              zIndex: 2
            }}
            onMouseEnter={(e) => {
              e.currentTarget.style.background = 'rgba(255,255,255,0.05)';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.background = 'transparent';
            }}>
              <div style={{
                width: 12,
                height: 12,
                borderRadius: '0',
                background: '#fff',
                border: '2px solid #fff',
                position: 'relative',
                zIndex: 3
              }} />
              <div style={{ 
                color: '#fff',
                opacity: 1
              }}>
                {getStepIcon(displayType)}
              </div>
              <div style={{
                flex: 1,
                fontSize: 14,
                fontWeight: 'normal',
                color: '#fff',
                lineHeight: 1.2,
                opacity: 1
              }}>
                {targetMission?.title || 'å½“å‰ä»»åŠ¡'}
              </div>
              <div style={{
                fontSize: 11,
                color: '#fff',
                fontWeight: 'normal',
                opacity: 0.6
              }}>
                1
              </div>
            </div>
          )}
        </div>
      </div>

      {/* === MasterCanvas (75%) - å³ä¾§ä¸»ç”»å¸ƒ === */}
      <div style={{
        width: '75%', height: '100%', 
        background: '#000', 
        position: 'relative',
        display: 'flex',
        flexDirection: 'row'
      }}>
        
        {/* å·¦ä¾§å‚è€ƒçª—å£ (50%) - æš´åŠ›æ›¿æ¢ */}
        <div className="flex-1 bg-black h-full relative">
          {/* åªè¦æœ‰è§†é¢‘é“¾æ¥ï¼Œå°±å¼ºåˆ¶æ¸²æŸ“ iframeï¼Œå¿½ç•¥å…¶ä»–æ‰€æœ‰æ¡ä»¶ */}
          {snakeData.video ? (
            <iframe
              src={snakeData.video}
              className="w-full h-full border-0"
              allow="autoplay; encrypted-media"
            />
          ) : (
            /* åªæœ‰æ²¡è§†é¢‘æ—¶ï¼Œæ‰æ˜¾ç¤ºæ—§çš„å ä½ç¬¦ */
            <div className="text-gray-500 text-center mt-20">æš‚æ— å‚è€ƒç´ æ (Debug: No Video URL)</div>
          )}
        </div>
        
        {/* å³ä¾§å·¥ä½œçª—å£ (50%) - æš´åŠ›æ›¿æ¢ */}
        <div className="flex-1 flex flex-col h-full bg-[#1e1e1e]">
          {/* å·¥ä½œçª—å£æ ‡é¢˜æ  - æç®€é£æ ¼ */}
          <div style={{
            padding: '8px 12px',
            background: '#000',
            borderBottom: '1px solid #333',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: '8px'
            }}>
              <div style={{
                width: '6px',
                height: '6px',
                background: '#fff'
              }}></div>
              <span style={{ color: '#fff', fontSize: '12px' }}>
                {currentStep?.title || 'é€‰æ‹©ä»»åŠ¡å¼€å§‹'}
              </span>
            </div>
            
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: '4px'
            }}>
              {/* Qwen-VL è§†è§‰å®¡è®¡å¸¸é©»æŒ‰é’® - æç®€è®¾è®¡ */}
              <button 
                onClick={handleQwenVLAudit}
                disabled={isQwenVLAnalyzing}
                style={{
                  background: '#000',
                  border: '1px solid #333',
                  color: isQwenVLAnalyzing ? '#666' : '#fff',
                  padding: '4px 8px',
                  fontSize: '10px',
                  cursor: isQwenVLAnalyzing ? 'not-allowed' : 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '4px',
                  borderRadius: '0'
                }}
              >
                <Eye size={10} />
                {isQwenVLAnalyzing ? 'åˆ†æä¸­...' : 'è§†è§‰å®¡è®¡'}
              </button>
              
              <button 
                onClick={() => setIsVerifyPanelOpen(!isVerifyPanelOpen)}
                style={{
                  background: '#000',
                  border: '1px solid #333',
                  color: '#fff',
                  padding: '4px 8px',
                  fontSize: '10px',
                  cursor: 'pointer',
                  borderRadius: '0'
                }}
              >
                {isVerifyPanelOpen ? 'éšè—éªŒè¯' : 'æ˜¾ç¤ºéªŒè¯'}
              </button>
            </div>
          </div>
          
          { snakeData.code ? (
             <div className="flex flex-col h-full bg-[#111] p-4">
                <div className="text-yellow-400 mb-2 font-bold">ğŸ’¡ {snakeData.instruction}</div>
                <textarea 
                  className="flex-1 bg-black text-green-400 font-mono p-4 mb-4 border border-gray-700 resize-none" 
                  value={sandboxCode} 
                  onChange={(e) => setSandboxCode(e.target.value)} 
                />
                <div className="flex justify-end gap-2">
                   <button 
                     onClick={() => { setSandboxRunning(true); setSandboxKey(k => k+1); }} 
                     className="bg-green-600 text-white px-4 py-2 rounded flex items-center gap-2" 
                   >
                     <Play size={16} /> è¿è¡Œ
                   </button>
                </div>
                {sandboxRunning && (
                  <div className="h-64 mt-4 bg-white border border-gray-600">
                    <iframe key={sandboxKey} srcDoc={sandboxCode} className="w-full h-full border-0" sandbox="allow-scripts allow-modals" />
                  </div>
                )}
             </div>
          ) : (
            /* ä¿ç•™åŸæœ‰çš„ VerifyPanel ç»„ä»¶ */
            <VerifyPanel 
              step={isP4Mission ? p4MissionData : (steps[currentSubStep] || targetMission)}
              onVerified={handleNextStep}
              themeColor={'#fff'}
            />
          )}
        </div>
        
        {/* === å¯æ”¶ç¼©å·¥å…·ç®± === */}
        <div style={{
          position: 'fixed',
          bottom: '24px',
          right: '24px',
          zIndex: 10000, // æé«˜å±‚çº§ï¼Œç¡®ä¿ä¸è¢«é®æŒ¡
          pointerEvents: 'auto'
        }}>
          {isToolboxExpanded ? (
            // å±•å¼€çŠ¶æ€
            <div style={{
              background: 'rgba(0, 0, 0, 0.9)',
              border: '1px solid #333',
              borderRadius: '0',
              padding: 20,
              width: 280,
              backdropFilter: 'blur(4px)'
            }}>
              {/* å·¥å…·ç®±æ ‡é¢˜æ  */}
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: 15,
                paddingBottom: 10,
                borderBottom: '1px solid #333'
              }}>
                <span style={{ color: '#ffd700', fontSize: 14, fontWeight: 'bold' }}>æ™ºèƒ½å·¥å…·ç®±</span>
                <button 
                  onClick={() => setIsToolboxExpanded(false)}
                  style={{
                    background: 'none',
                    border: 'none',
                    color: '#666',
                    cursor: 'pointer',
                    padding: 5
                  }}
                >
                  <Settings size={16} />
                </button>
              </div>

              {/* å½“å‰éªŒè¯æ’ä»¶ - æ ¹æ®æ–¹æ¡ˆç±»å‹æ˜¾ç¤ºå¼•å¯¼è¯­ */}
              <div style={{
                background: '#000',
                border: '1px solid #333',
                borderRadius: '0',
                padding: 12,
                cursor: 'pointer'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                  <Zap size={14} color="#fff" />
                  <span style={{ color: '#fff', fontSize: 12, fontWeight: 'normal' }}>æ–¹æ¡ˆå¼•å¯¼</span>
                </div>
                <div style={{ color: '#aaa', fontSize: 10, marginTop: 4, lineHeight: '1.3' }}>
                  {schemeType === 'A' && 'åŸå‘³æ–¹æ¡ˆï¼šä¸“æ³¨æ–‡æœ¬é€»è¾‘éªŒè¯'}
                  {schemeType === 'B' && 'å¹³è¡Œæ–¹æ¡ˆï¼šä¾§é‡åæ ‡ç‰©ç†æ¯”å¯¹'}
                </div>
              </div>
              
              {/* å¿ƒæ³•å›é¡¾ */}
              <div style={{
                background: '#000',
                border: '1px solid #333',
                borderRadius: '0',
                padding: 12,
                cursor: 'pointer',
                marginTop: 12
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                  <Heart size={14} color="#fff" />
                  <span style={{ color: '#fff', fontSize: 12, fontWeight: 'normal' }}>å¿ƒæ³•å›é¡¾</span>
                </div>
                <div style={{ color: '#aaa', fontSize: 10, marginTop: 4 }}>å›é¡¾å½“å‰ä»»åŠ¡çš„æ ¸å¿ƒè¦ç‚¹</div>
              </div>
            </div>
          ) : (
            // æ”¶ç¼©çŠ¶æ€
            <button
              onClick={() => setIsToolboxExpanded(true)}
              style={{
                width: 50,
                height: 50,
                background: 'rgba(0, 0, 0, 0.9)',
                border: '1px solid #333',
                borderRadius: '0',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                cursor: 'pointer',
                color: '#fff',
                backdropFilter: 'blur(4px)'
              }}
            >
              <Settings size={20} />
            </button>
          )}
        </div>
      </div>

      <style>{`
        @keyframes ping { 75%, 100% { transform: scale(1.4); opacity: 0; } }
        @keyframes pulse {
          0% { transform: scale(1); opacity: 0.6; }
          50% { transform: scale(1.1); opacity: 0.3; }
          100% { transform: scale(1); opacity: 0.6; }
        }
        @keyframes toolboxSlideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes toolboxSlideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
        @keyframes confetti {
          0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
          100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        @keyframes zoomIn {
          0% { transform: rotate(-15deg) scale(0.5); opacity: 0; }
          100% { transform: rotate(-15deg) scale(1); opacity: 1; }
        }
      `}</style>
    </div>
  );
};

export default LabPage;