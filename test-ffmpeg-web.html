<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FFmpeg è§†é¢‘åˆæˆæµ‹è¯• - å®é™…æ•ˆæœæ¼”ç¤º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #fff;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 28px;
      background: linear-gradient(135deg, #FFC947 0%, #FF6F00 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      text-align: center;
      opacity: 0.8;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .section {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .section-title {
      font-size: 18px;
      margin-bottom: 15px;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      opacity: 0.9;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 14px;
      transition: all 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #FFC947;
      background: rgba(255, 255, 255, 0.15);
    }

    textarea {
      resize: vertical;
      min-height: 60px;
      font-family: inherit;
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #FFC947 0%, #FF6F00 100%);
      color: #000;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 201, 71, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      margin-top: 20px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
      white-space: pre-wrap;
      line-height: 1.6;
    }

    .status.show {
      display: block;
    }

    .status.loading {
      background: rgba(255, 193, 7, 0.2);
      border: 1px solid rgba(255, 193, 7, 0.4);
      color: #FFC947;
    }

    .status.success {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid rgba(76, 175, 80, 0.4);
      color: #4CAF50;
    }

    .status.error {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid rgba(244, 67, 54, 0.4);
      color: #F44336;
    }

    .video-preview {
      margin-top: 20px;
      display: none;
    }

    .video-preview.show {
      display: block;
    }

    video {
      width: 100%;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      margin-bottom: 15px;
    }

    .download-btn {
      display: inline-block;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: #fff;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.3s;
      margin-right: 10px;
    }

    .download-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }

    .template-item {
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 13px;
    }

    .template-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #FFC947;
    }

    .template-item.selected {
      background: rgba(255, 201, 71, 0.2);
      border-color: #FFC947;
    }

    @media (max-width: 600px) {
      .container {
        padding: 20px;
      }

      h1 {
        font-size: 24px;
      }

      .template-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¬ FFmpeg è§†é¢‘åˆæˆæµ‹è¯•</h1>
    <p class="subtitle">æµ‹è¯•å›¾ç‰‡è½¬è§†é¢‘ + å­—å¹•çƒ§å½•æ•ˆæœ</p>

    <!-- å¿«é€Ÿæµ‹è¯•æŒ‰é’® -->
    <div class="section">
      <div class="section-title">ğŸ“± ä¸€é”®æµ‹è¯•ï¼ˆä½¿ç”¨è´¢ç¥æ¨¡æ¿ï¼‰</div>
      <button class="btn" onclick="quickTest()">ç«‹å³æµ‹è¯•ï¼šè´¢ç¥æ¨¡æ¿ + å­—å¹•</button>
    </div>

    <!-- è‡ªå®šä¹‰æµ‹è¯• -->
    <div class="section">
      <div class="section-title">ğŸ› ï¸ è‡ªå®šä¹‰æµ‹è¯•</div>

      <div class="form-group">
        <label>å›¾ç‰‡URLï¼š</label>
        <input type="text" id="inputUrl" placeholder="è¾“å…¥å›¾ç‰‡URLæˆ–é€‰æ‹©ä¸‹æ–¹æ¨¡æ¿" value="https://fudaiai-1400086527.cos.ap-shanghai.myqcloud.com/festival-templates/caishen/female/female_01.png">
      </div>

      <div class="form-group">
        <label>å¿«é€Ÿé€‰æ‹©æ¨¡æ¿ï¼š</label>
        <div class="template-grid">
          <div class="template-item" onclick="selectTemplate('https://fudaiai-1400086527.cos.ap-shanghai.myqcloud.com/festival-templates/caishen/female/female_01.png')">
            ğŸ§§ è´¢ç¥å¥³1
          </div>
          <div class="template-item" onclick="selectTemplate('https://fudaiai-1400086527.cos.ap-shanghai.myqcloud.com/festival-templates/caishen/female/female_02.png')">
            ğŸ§§ è´¢ç¥å¥³2
          </div>
          <div class="template-item" onclick="selectTemplate('https://fudaiai-1400086527.cos.ap-shanghai.myqcloud.com/festival-templates/caishen/female/female_03.png')">
            ğŸ§§ è´¢ç¥å¥³3
          </div>
          <div class="template-item" onclick="selectTemplate('https://fudaiai-1400086527.cos.ap-shanghai.myqcloud.com/festival-templates/caishen/male/male_01.png')">
            ğŸ§§ è´¢ç¥ç”·1
          </div>
          <div class="template-item" onclick="selectTemplate('https://fudaiai-1400086527.cos.ap-shanghai.myqcloud.com/festival-templates/caishen/male/male_02.png')">
            ğŸ§§ è´¢ç¥ç”·2
          </div>
          <div class="template-item" onclick="selectTemplate('https://fudaiai-1400086527.cos.ap-shanghai.myqcloud.com/festival-templates/caishen/male/male_03.png')">
            ğŸ§§ è´¢ç¥ç”·3
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>å­—å¹•æ–‡æœ¬ï¼š</label>
        <textarea id="subtitle" placeholder="è¾“å…¥å­—å¹•æ–‡æœ¬ï¼ˆå¯é€‰ï¼‰">ğŸ§§ æ­å–œå‘è´¢ï¼Œè´¢ç¥åˆ°ï¼</textarea>
      </div>

      <div class="form-group">
        <label>è§†é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰ï¼š</label>
        <input type="number" id="duration" value="5" min="1" max="30">
      </div>

      <button class="btn" onclick="customTest()">ğŸš€ å¼€å§‹ç”Ÿæˆ</button>
    </div>

    <!-- çŠ¶æ€æ˜¾ç¤º -->
    <div id="status" class="status"></div>

    <!-- è§†é¢‘é¢„è§ˆ -->
    <div id="videoPreview" class="video-preview">
      <div class="section-title">âœ¨ ç”Ÿæˆç»“æœ</div>
      <video id="video" controls></video>
      <div>
        <a id="downloadLink" class="download-btn" download>ğŸ“¥ ä¸‹è½½è§†é¢‘</a>
        <span id="fileInfo" style="opacity: 0.7; font-size: 13px;"></span>
      </div>
    </div>
  </div>

  <script>
    const SERVER_URL = 'http://localhost:3002';

    // æ˜¾ç¤ºçŠ¶æ€
    function showStatus(message, type = 'loading') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status show ${type}`;
    }

    // éšè—çŠ¶æ€
    function hideStatus() {
      const status = document.getElementById('status');
      status.classList.remove('show');
    }

    // é€‰æ‹©æ¨¡æ¿
    function selectTemplate(url) {
      document.getElementById('inputUrl').value = url;

      // æ›´æ–°UI
      document.querySelectorAll('.template-item').forEach(item => {
        item.classList.remove('selected');
      });
      event.target.classList.add('selected');
    }

    // ä¸€é”®æµ‹è¯•
    async function quickTest() {
      await composeVideo({
        inputUrl: 'https://fudaiai-1400086527.cos.ap-shanghai.myqcloud.com/festival-templates/caishen/female/female_01.png',
        type: 'image',
        subtitle: 'ğŸ§§ æ­å–œå‘è´¢ï¼Œè´¢ç¥åˆ°ï¼',
        duration: 5
      });
    }

    // è‡ªå®šä¹‰æµ‹è¯•
    async function customTest() {
      const inputUrl = document.getElementById('inputUrl').value.trim();
      const subtitle = document.getElementById('subtitle').value.trim();
      const duration = parseInt(document.getElementById('duration').value);

      if (!inputUrl) {
        showStatus('âŒ è¯·è¾“å…¥å›¾ç‰‡URL', 'error');
        return;
      }

      await composeVideo({
        inputUrl,
        type: 'image',
        subtitle: subtitle || undefined,
        duration
      });
    }

    // æ‰§è¡Œè§†é¢‘åˆæˆ
    async function composeVideo(params) {
      showStatus('ğŸ¬ æ­£åœ¨ç”Ÿæˆè§†é¢‘ï¼Œè¯·ç¨å€™...', 'loading');

      const startTime = Date.now();

      try {
        const response = await fetch(`${SERVER_URL}/api/video/compose`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(params)
        });

        const duration = ((Date.now() - startTime) / 1000).toFixed(2);

        if (!response.ok) {
          const error = await response.text();
          throw new Error(`HTTP ${response.status}: ${error}`);
        }

        const result = await response.json();

        if (result.status === 'success') {
          showStatus(`âœ… ç”ŸæˆæˆåŠŸï¼è€—æ—¶ ${duration} ç§’`, 'success');

          // æ˜¾ç¤ºè§†é¢‘é¢„è§ˆ
          const video = document.getElementById('video');
          const videoPreview = document.getElementById('videoPreview');
          const downloadLink = document.getElementById('downloadLink');
          const fileInfo = document.getElementById('fileInfo');

          video.src = result.downloadUrl;
          downloadLink.href = result.downloadUrl;
          downloadLink.download = result.fileName;
          fileInfo.textContent = `æ–‡ä»¶ï¼š${result.fileName}`;

          videoPreview.classList.add('show');

          // è‡ªåŠ¨æ’­æ”¾
          video.play().catch(e => console.log('è‡ªåŠ¨æ’­æ”¾è¢«æµè§ˆå™¨é˜»æ­¢'));

        } else {
          showStatus(`âŒ ç”Ÿæˆå¤±è´¥ï¼š${result.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
        }

      } catch (error) {
        console.error('è§†é¢‘åˆæˆå¤±è´¥:', error);
        showStatus(`âŒ è¯·æ±‚å¤±è´¥ï¼š${error.message}`, 'error');

        // æ£€æŸ¥æ˜¯å¦æ˜¯æœåŠ¡å™¨æœªå¯åŠ¨
        if (error.message.includes('Failed to fetch')) {
          setTimeout(() => {
            showStatus('âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ã€‚è¯·ç¡®ä¿è¿è¡Œï¼šnode server.js', 'error');
          }, 100);
        }
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
    window.addEventListener('load', async () => {
      try {
        const response = await fetch(`${SERVER_URL}/api/health`, {
          signal: AbortSignal.timeout(3000)
        });
        if (response.ok) {
          console.log('âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸');
          showStatus('âœ… æœåŠ¡å™¨å·²è¿æ¥ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•', 'success');
          setTimeout(() => hideStatus(), 2000);
        }
      } catch (error) {
        showStatus(`âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ (${SERVER_URL})

è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š
1. æ‰“å¼€æ–°çš„ç»ˆç«¯/å‘½ä»¤è¡Œçª—å£
2. è¿›å…¥é¡¹ç›®ç›®å½•ï¼šcd F:\\project_kuajing
3. è¿è¡Œåç«¯æœåŠ¡å™¨ï¼šnode server.js
4. ç­‰å¾…çœ‹åˆ° "Server is running on http://localhost:3002"
5. åˆ·æ–°æ­¤é¡µé¢`, 'error');
      }
    });
  </script>
</body>
</html>
