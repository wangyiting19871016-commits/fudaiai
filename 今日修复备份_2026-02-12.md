# 今日修复备份 - 2026年2月12日

## 📋 修复总结

### ✅ 已完成的问题

#### 1. Mixed Content 错误（HTTPS/HTTP混用）
**问题**：
- 网站用HTTPS加载，但前端代码请求HTTP API
- 浏览器阻止：`http://124.221.252.223:3002`

**原因**：
- 构建时使用了本地 `.env` 配置（HTTP）
- 而不是服务器上的 `.env.production`（HTTPS）

**解决方案**：
- 在服务器上重新构建：`npm run build`
- 使用服务器的 `.env` 配置：`VITE_API_BASE_URL=https://www.fudaiai.com`

**验证**：
```bash
# 检查构建产物中的API地址
grep -o "https://www.fudaiai.com" /root/fudaiai/dist/assets/index-*.js | head -3
```

---

#### 2. Nginx 配置错误（500错误）
**问题**：
- 网站显示 500 Internal Server Error
- Nginx无法读取静态文件

**原因**：
1. Nginx配置错误：`location /` 代理到后端，而不是静态文件
2. 权限问题：Nginx无法访问 `/root/` 目录（Permission denied）

**解决方案**：

**2.1 修复Nginx配置**：
```nginx
server {
    server_name www.fudaiai.com fudaiai.com;

    # 前端静态文件
    location / {
        root /root/fudaiai/dist;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    # API反向代理
    location /api/ {
        proxy_pass http://localhost:3002;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 600;
        proxy_send_timeout 600;
        proxy_read_timeout 600;
    }

    client_max_body_size 100M;

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/www.fudaiai.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.fudaiai.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}
```

**2.2 修复权限**：
```bash
chmod 755 /root
chmod -R 755 /root/fudaiai/dist
```

---

#### 3. DNS 解析失败
**问题**：
- 服务器无法解析 `dashscope.aliyuncs.com`
- 错误：`getaddrinfo EAI_AGAIN`

**原因**：
- DNS配置被修改或损坏

**解决方案**：
```bash
# 修复DNS配置
echo -e "nameserver 183.60.83.19\nnameserver 183.60.82.98" | sudo tee /etc/resolv.conf

# 验证
nslookup dashscope.aliyuncs.com
```

---

#### 4. Fish Audio 超时问题
**问题**：
- Fish Audio TTS 请求超时
- 错误：`Fish Audio请求超时`

**原因**：
1. 后端代码直接调用Fish Audio API（国内网络受限）
2. 没有使用Render代理服务
3. 超时时间太短（60秒）

**解决方案**：
修改 `api-proxy-endpoints.js`，使用Render代理：

```javascript
app.post('/api/fish/tts', express.json({ limit: '50mb' }), async (req, res) => {
  try {
    // 使用Render代理服务（解决国内网络访问Fish Audio问题）
    const proxyUrl = process.env.FISH_AUDIO_PROXY_URL || 'https://fish-audio-proxy.onrender.com';
    const apiKey = process.env.FISH_AUDIO_API_KEY;

    console.log(`[Fish Audio] 通过Render代理: ${proxyUrl}`);

    const postData = JSON.stringify(req.body);
    const proxyUrlObj = new URL(proxyUrl);

    const options = {
      hostname: proxyUrlObj.hostname,
      path: '/v1/tts',
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(postData)
      },
      timeout: 120000  // 增加到120秒
    };
    // ... 其余代码
  }
});
```

**环境变量配置** (`/root/fudaiai/.env`)：
```env
FISH_AUDIO_PROXY_URL=https://fish-audio-proxy.onrender.com
FISH_AUDIO_API_KEY=58864427d9e44e4ca76febe5b50639e6
```

**Git提交**：
```bash
git commit -m "fix: Fish Audio使用Render代理,避免国内网络访问问题"
```

---

#### 5. 测试阶段积分不足
**问题**：
- 默认100积分不够测试使用

**解决方案**：
修改 `src/stores/creditStore.ts`：

```typescript
const initialCredits = ENABLE_UNLIMITED_CREDITS
  ? CREDIT_BOOTSTRAP
  : ENABLE_BOOTSTRAP_CREDITS
    ? CREDIT_BOOTSTRAP
    : 10000; // 测试阶段改为10000积分

const initialDescription = ENABLE_UNLIMITED_CREDITS
  ? `🧪 本地测试：无限积分模式（初始 ${initialCredits}）`
  : ENABLE_BOOTSTRAP_CREDITS
    ? `🧪 本地测试：预设积分 ${initialCredits}`
    : '🎁 新春礼包：赠送10000积分体验';
```

**注意**：
- 积分存储在浏览器 localStorage
- 已有用户需要清除浏览器数据才能获得新积分
- 新用户自动获得10000积分

**清除方法**：
```javascript
// 在浏览器控制台执行
localStorage.clear();
sessionStorage.clear();
location.reload();
```

---

#### 6. 手机无法访问网站
**问题**：
- 手机显示"找不到服务器"
- 电脑可以访问

**原因**：
- 手机DNS缓存问题
- 手机网络的DNS服务器缓存了旧记录

**解决方案**：
1. 切换网络（WiFi ↔ 4G/5G）
2. 清除手机浏览器缓存
3. 重启手机

**验证DNS配置**：
```bash
# 检查域名解析
nslookup www.fudaiai.com 8.8.8.8

# 检查服务器IP
curl -s ifconfig.me

# 应该返回相同的IP：124.221.252.223
```

---

## 🚀 部署脚本使用指南

### 一键部署脚本

#### 服务器端脚本：`/root/deploy.sh`

**内容**：
```bash
#!/bin/bash
cd /root/fudaiai
git reset --hard HEAD       # 清除本地修改（重要！）
git pull origin master      # 从Gitee拉取最新代码
npm install                 # 安装所有依赖（包括开发依赖）
npm run build              # 构建前端
chmod -R 755 /root/fudaiai/dist  # 设置权限
pm2 restart fudaiai-backend     # 重启后端服务
sleep 2
curl -s http://127.0.0.1:3002/api/health  # 健康检查
pm2 list                   # 查看服务状态
```

**使用方法**：
```bash
bash /root/deploy.sh
```

**执行流程**：
1. 拉取最新代码（约3秒）
2. 安装依赖（约5秒，如果依赖未变化）
3. 构建前端（约18秒）
4. 重启服务（约2秒）
5. 验证健康状态

**预期输出**：
```
HEAD is now at <commit-hash> <commit-message>
From https://gitee.com/wangyiting1987/fudaiai1234
 * branch              master     -> FETCH_HEAD
...
✓ built in 17.86s
[PM2] [fudaiai-backend](1) ✓
{"status":"ok","message":"Server is running"}
┌────┬────────────────────┬─────────────┬─────────┬─────────┬──────────┬────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ namespace   │ version │ mode    │ pid      │ uptime │ ↺    │ status    │ cpu      │ mem      │
├────┼────────────────────┼─────────────┼─────────┼─────────┼──────────┼────────┼──────┼───────────┼──────────┼──────────┤
│ 1  │ fudaiai-backend    │ default     │ 1.0.0   │ fork    │ 733342   │ 2s     │ 45   │ online    │ 0%       │ 67.5mb   │
└────┴────────────────────┴─────────────┴─────────┴─────────┴──────────┴────────┴──────┴───────────┴──────────┴──────────┘
```

---

#### Windows本地脚本：`快速部署.bat`

**内容**：
```batch
@echo off
chcp 65001 >nul
echo ========================================
echo   福袋AI - 一键部署到服务器
echo ========================================
echo.

echo [1/5] 本地构建...
call npm run build
if errorlevel 1 (
    echo ❌ 构建失败！
    pause
    exit /b 1
)
echo ✅ 构建完成
echo.

echo [2/5] 推送代码到 GitHub...
git add .
git commit -m "update: %date% %time%"
git push github master
echo ✅ 代码已推送
echo.

echo [3/5] 同步到 Gitee（手动）...
echo ⚠️ 请手动打开 https://gitee.com/wangyiting1987/fudaiai1234
echo ⚠️ 点击"同步"按钮，然后按任意键继续...
pause >nul
echo.

echo [4/5] 连接服务器部署...
ssh root@124.221.252.223 "cd /root/fudaiai && git pull origin master && npm install && npm run build && pm2 restart fudaiai-backend"
if errorlevel 1 (
    echo ❌ 服务器部署失败！
    pause
    exit /b 1
)
echo ✅ 服务器部署完成
echo.

echo [5/5] 验证部署...
curl -s https://www.fudaiai.com/api/health
echo.

echo ========================================
echo   ✅ 部署完成！
echo   🌐 访问: https://www.fudaiai.com
echo ========================================
pause
```

**使用方法**：
```
双击 F:\project_kuajing\快速部署.bat
```

---

### 完整部署流程

#### 方式1：使用Windows脚本（推荐）

1. 本地修改代码
2. 双击 `快速部署.bat`
3. 按提示操作（手动同步Gitee）
4. 等待部署完成

#### 方式2：手动部署

1. **本地修改代码并推送**：
```bash
cd F:\project_kuajing
git add .
git commit -m "修改说明"
git push github master
```

2. **Gitee同步**：
- 打开 https://gitee.com/wangyiting1987/fudaiai1234
- 点击页面右上角 **"🔄 同步"** 按钮
- 选择 **"强制同步"**

3. **服务器部署**：
```bash
ssh root@124.221.252.223
bash /root/deploy.sh
```

---

## ⚙️ 关键配置说明

### 环境变量配置

#### 服务器 `.env` 文件位置：
```
/root/fudaiai/.env
```

#### 重要配置项：

```env
# API基础URL（前端构建时使用）
VITE_API_BASE_URL=https://www.fudaiai.com

# Fish Audio配置
FISH_AUDIO_PROXY_URL=https://fish-audio-proxy.onrender.com
FISH_AUDIO_API_KEY=58864427d9e44e4ca76febe5b50639e6

# DNS服务器（如果需要）
# 在 /etc/resolv.conf 配置：
# nameserver 183.60.83.19
# nameserver 183.60.82.98

# CORS配置
CORS_ALLOWED_ORIGINS=https://www.fudaiai.com,https://fudaiai.com,http://www.fudaiai.com,http://fudaiai.com,http://localhost:5173

# Dashscope配置
DASHSCOPE_API_KEY=sk-b70b16990ce44557861b081b8c290413
VITE_DASHSCOPE_API_KEY=sk-b70b16990ce44557861b081b8c290413
```

---

### Nginx配置文件位置：
```
/etc/nginx/sites-available/fudaiai
```

**关键点**：
- `location /` → 静态文件（`/root/fudaiai/dist`）
- `location /api/` → 代理到后端（`http://localhost:3002`）
- 监听443端口（HTTPS）
- SSL证书由Let's Encrypt管理

---

### PM2进程管理

**常用命令**：
```bash
# 查看状态
pm2 list

# 查看日志
pm2 logs fudaiai-backend

# 查看错误日志
pm2 logs fudaiai-backend --err

# 重启服务
pm2 restart fudaiai-backend

# 停止服务
pm2 stop fudaiai-backend

# 查看详细信息
pm2 show fudaiai-backend
```

---

## 🔧 常见问题解决方案

### 1. 构建失败：`tsc: not found`

**原因**：缺少TypeScript编译器（开发依赖）

**解决**：
```bash
cd /root/fudaiai
npm install  # 不要加 --production
npm run build
```

---

### 2. Git冲突：`Your local changes would be overwritten`

**原因**：服务器上有本地修改

**解决**：
```bash
cd /root/fudaiai
git reset --hard HEAD  # 清除本地修改
git pull origin master
```

**⚠️ 注意**：会丢失本地修改！重要修改应先提交到Git。

---

### 3. 权限错误：`Permission denied`

**原因**：Nginx无法访问文件

**解决**：
```bash
chmod 755 /root
chmod -R 755 /root/fudaiai/dist
systemctl reload nginx
```

---

### 4. DNS解析失败

**症状**：
- `getaddrinfo EAI_AGAIN`
- `Could not resolve host`

**解决**：
```bash
# 修复DNS配置
echo -e "nameserver 183.60.83.19\nnameserver 183.60.82.98" | sudo tee /etc/resolv.conf

# 验证
nslookup dashscope.aliyuncs.com
```

---

### 5. Fish Audio超时

**症状**：
- `Fish Audio请求超时`
- 语音生成失败

**检查**：
```bash
# 检查Render代理状态
curl -I https://fish-audio-proxy.onrender.com

# 检查环境变量
grep FISH_AUDIO_PROXY /root/fudaiai/.env

# 检查后端日志
pm2 logs fudaiai-backend --err --lines 20 | grep -i fish
```

**解决**：
- 确保使用Render代理（已在最新代码中修复）
- 超时时间已增加到120秒
- Render免费服务冷启动需要10-30秒，首次请求会慢

---

### 6. 浏览器缓存问题

**症状**：
- 网站显示旧版本
- 功能不更新

**解决**：
```bash
# 强制刷新
Ctrl + Shift + R  (Windows/Linux)
Cmd + Shift + R   (Mac)

# 或清除浏览器缓存
F12 → Application → Clear Storage → Clear site data
```

---

## ❌ 未完成的问题

### 1. Render服务冷启动慢

**现状**：
- Render免费服务闲置15分钟会休眠
- 首次请求需要10-30秒唤醒

**临时方案**：
- 已将超时时间增加到120秒
- 用户首次使用会稍慢

**待优化方案**：
1. **定时保活**（推荐）：
```bash
# 在服务器添加cron任务
crontab -e

# 添加以下行（每10分钟访问一次）
*/10 * * * * curl https://fish-audio-proxy.onrender.com/ > /dev/null 2>&1
```

2. **升级Render付费版**：
   - 费用：约$7/月
   - 永不休眠

3. **自建Fish Audio代理**：
   - 部署在不休眠的服务器上

---

### 2. Node.js版本警告

**现状**：
```
npm warn EBADENGINE Unsupported engine {
  package: 'fabric@7.1.0',
  required: { node: '>=20.0.0' },
  current: { node: 'v18.20.8', npm: '10.8.2' }
}
```

**影响**：
- 仅警告，不影响运行
- 某些新特性可能不可用

**待优化方案**：
```bash
# 升级Node.js到20.x
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证
node -v  # 应显示 v20.x.x
```

---

### 3. 前端代码分包优化

**现状**：
```
(!) Some chunks are larger than 500 kBs after minification.
dist/assets/index-7f96917c.js   1,571.15 kB │ gzip: 513.95 kB
```

**影响**：
- 首次加载较慢
- 占用带宽较大

**待优化方案**：
- 使用动态导入（`import()`）按需加载
- 配置 `build.rollupOptions.output.manualChunks` 手动分包
- 提取第三方库到单独chunk

**示例配置** (`vite.config.ts`)：
```typescript
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'vendor': ['react', 'react-dom', 'react-router-dom'],
          'ui': ['antd', 'framer-motion'],
          'fabric': ['fabric'],
        }
      }
    }
  }
})
```

---

### 4. 积分同步机制

**现状**：
- 积分只存储在浏览器localStorage
- 没有后端持久化
- 清除浏览器数据会丢失积分

**影响**：
- 用户换设备无法同步积分
- 无法跨浏览器使用

**待优化方案**：
1. **后端积分系统**：
   - 数据库存储积分
   - 前端定期同步
   - 登录后恢复积分

2. **游客模式改进**：
   - 允许游客升级为注册用户
   - 保留已有积分

---

### 5. 手机DNS缓存问题

**现状**：
- 部分手机用户首次访问可能遇到DNS问题
- 需要手动切换网络

**影响**：
- 用户体验不佳
- 可能导致用户流失

**待优化方案**：
1. **等待DNS全球传播**（48小时）
2. **使用CDN加速**（如Cloudflare）
3. **提供备用访问方式**（如IP直达）

---

## 📊 代码提交记录

### 今日提交列表

1. **7d5eca24** - `feat: 测试阶段初始积分改为10000 + 添加一键部署脚本`
   - 修改初始积分：100 → 10000
   - 添加 `快速部署.bat`
   - 添加 `服务器部署脚本.sh`
   - 修改 `vite.config.ts` 确保环境变量注入

2. **e7fe23f8** - `fix: Fish Audio使用Render代理,避免国内网络访问问题`
   - 修改 `api-proxy-endpoints.js`
   - Fish Audio改用Render代理
   - 超时时间：60秒 → 120秒

---

## 🎯 下一步建议

### 高优先级

1. **添加Render保活cron任务**（5分钟）
   ```bash
   crontab -e
   # 添加：*/10 * * * * curl https://fish-audio-proxy.onrender.com/ > /dev/null 2>&1
   ```

2. **升级Node.js到20.x**（10分钟）
   - 消除警告
   - 获得更好性能

### 中优先级

3. **配置前端代码分包**（30分钟）
   - 减小首屏加载时间
   - 优化用户体验

4. **添加积分后端同步**（2小时）
   - 设计数据库表
   - 实现同步API
   - 前端集成

### 低优先级

5. **配置CDN加速**（可选）
   - 腾讯云COS CDN
   - Cloudflare加速

6. **监控和告警系统**（可选）
   - 服务器监控
   - 错误日志告警
   - 性能监控

---

## 📞 联系信息

### 服务器信息
- **IP**: 124.221.252.223
- **域名**: www.fudaiai.com
- **SSH**: `ssh root@124.221.252.223`

### Git仓库
- **GitHub**: https://github.com/wangyiting19871016-commits/fudaiai
- **Gitee**: https://gitee.com/wangyiting1987/fudaiai1234

### 关键服务
- **Render代理**: https://fish-audio-proxy.onrender.com
- **后端健康检查**: https://www.fudaiai.com/api/health
- **PM2进程**: `fudaiai-backend`

---

## 🔐 安全提醒

⚠️ **不要提交敏感信息到Git**：
- `.env` 文件（包含API密钥）
- SSL证书私钥
- 数据库密码

✅ **已在 `.gitignore` 中排除**：
- `.env`
- `.env.local`
- `.env.production`
- `*.pem`
- `*.key`

---

## 📝 备注

### 重要经验教训

1. **部署脚本会覆盖本地修改**
   - 重要修改必须提交到Git
   - 使用 `git reset --hard HEAD` 要谨慎

2. **环境变量的作用域**
   - `VITE_*` 前缀的变量在前端可用
   - 普通变量只在后端可用
   - 构建时会打包进前端代码

3. **Nginx配置顺序很重要**
   - `location /api/` 必须在 `location /` 之前
   - 否则API请求会被静态文件规则捕获

4. **权限问题要提前预防**
   - `/root/` 目录默认只有root可访问
   - Nginx用 `www-data` 用户运行
   - 需要修改目录权限为755

---

**文档创建时间**：2026年2月12日
**最后更新**：2026年2月12日 17:30
**文档版本**：1.0

---

## ✅ 快速检查清单

部署后检查：
- [ ] 网站可以访问（https://www.fudaiai.com）
- [ ] PM2服务在线（`pm2 list` 显示 online）
- [ ] API健康检查正常（`curl https://www.fudaiai.com/api/health`）
- [ ] Nginx配置正确（`nginx -t`）
- [ ] 权限设置正确（`ls -la /root/fudaiai/dist`）
- [ ] Fish Audio功能正常（测试语音生成）
- [ ] 新用户获得10000积分（清除localStorage测试）
- [ ] 手机可以访问（切换网络测试）

---

**祝部署顺利！🎉**
